<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Page</title>
    <script src="https://js.stripe.com/v3/"></script>

<!-- Add Google Fonts link BEFORE any styles -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

/* Add this new CSS rule with !important */
.profile-section {
    margin-bottom: 30px !important; /* Default margin for when Saved Instances are visible */
}

/* This conditional styling will add more space when Saved Instances section doesn't exist */
.profile-section:not(:has(+ .saved-analyses-section)) {
    margin-bottom: 300px !important; /* Increased bottom margin when there's no Saved Instances section */
}



/* Add this rule to properly position the saved-analyses-section */
.saved-analyses-section {
    margin-top: 20px;
    margin-bottom: 100px; /* Add space for the footer */
}

/* Ensure footer has proper positioning */
footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    padding: 10px 0;
}

/* Add this to your existing CSS */
.profile-section {
    margin-bottom: 30px; /* Reduce this from 300px to a smaller value */
}

/* Add this to ensure proper spacing between sections */
.saved-instances-section {
    margin-top: 30px;
}

/* This targets only the direct links in the main navigation bar */
.site-navigation > ul > li > a:hover {
    transform: scale(1.07) !important; /* Slightly increase size on hover */
    background-color: transparent !important; /* Ensure no background appears on hover */
}

/* This ensures the links are displayed correctly in the first place */
.site-navigation > ul > li > a {
    display: inline-block !important;
    color: white !important;
    text-decoration: none !important;
    padding: 8px 12px !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.dropdown .dropdown-menu {
    display: none !important;
}

.dropdown:hover .dropdown-menu {
    display: block !important;
}

/* Dropdown styles */
.dropdown {
    position: relative;
}

.dropdown-toggle {
    cursor: pointer;
}

.dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 180px;
    background-color: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 4px;
    z-index: 1000;
    padding: 8px 0;
}

.dropdown-menu li {
    display: block;
    width: 100%;
    margin: 0;
}

.dropdown-menu li a {
    padding: 8px 16px;
    display: block;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
}

.dropdown-menu li a:hover {
    background-color: #f5f5f5;
}

.dropdown:hover .dropdown-menu {
    display: block;
}


/* Larger logo styling */
.logo-title .site-logo {
    height: 200px; /* Try a moderate increase first */
    max-height: 200px; /* Ensure it doesn't get too large */
}

/* Apply Montserrat font to everything */
body, 
input, 
button, 
select, 
textarea, 
h1, h2, h3, h4, h5, h6, 
p, 
a, 
label, 
span, 
div {
    font-family: 'Montserrat', sans-serif !important;
}

/* Override any existing font-family declarations */
.site-title, 
.site-navigation a,
.container h2,
button,
.profile-section * {
    font-family: 'Montserrat', sans-serif !important;
}

.profile-section {
    margin-bottom: 30px; /* Creates space for the footer */
}

body {
    min-height: 110vh; /* Forces the page to be taller than the viewport */
}

footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    padding: 10px 0;
}

.profile-section .container {
    max-height: 80vh;
    overflow-y: auto;
}

/* Hide everything under the Save Advisor Type button in the User Profile box EXCEPT the footer */
#saveAdvisorTypeBtn ~ *:not(footer) {
    display: none !important;
}

/* Hide subscription info and update button */
label[for="subscriptionPlan"],
#currentSubscriptionPlan,
label[for="nextBillingDate"],
#nextBillingDate,
#subscriptionStatus,
div.profile-section .container form button[type="button"]:not(#saveAdvisorTypeBtn),
#cancelSubscriptionButton,
#cancelSubscriptionMessage,
#profileMessage {
    display: none !important;
}

/* Also hide any status text (which might be outside the above selectors) */
.profile-section .container form div:not(.form-group) {
    display: none !important;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Logo and Title Alignment */
.logo-title {
    display: flex;
    align-items: center;
    gap: 10px;
}

.site-logo {
    height: 40px; /* Adjust logo size */
    width: auto;
    object-fit: contain;
}

/* Consistent styling for input fields and dropdowns */
input[type="number"],
input[type="month"],
input[type="text"],
select {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 16px;
    background-color: #fff;
}



/* General Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f1f1f1;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ccc;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }

        /* Header Styles */
        .site-header {
            background: transparent;
            color: white;
            padding: 60px 0 60px;
            box-shadow: none;
            width: 100%;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .site-title {
            font-family: 'Roboto Slab', serif; /* Replace with your chosen font */
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }
        .site-navigation ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        .site-navigation a {
            color: white;
            text-decoration: none;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        .site-navigation a:hover {
            transform: scale(1.05);
            background-color: transparent;
        }


form {
    margin-top: 20px;
    max-width: 600px;
    width: 100%;
}

select[multiple] {
    width: 100%;
    height: auto;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 10px;
    font-size: 16px;
    background-color: #f9f9f9;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    outline: none;
    appearance: none;
    cursor: pointer;
    overflow-y: auto;
    transition: border-color 0.3s, box-shadow 0.3s;
}

select[multiple]:focus {
    border-color: #0056b3;
    box-shadow: 0 0 5px rgba(0, 91, 187, 0.5);
}

/* Option styles for multi-select */
select[multiple] option {
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #ffffff;
    color: #333;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
}

/* Hover and checked option styling */
select[multiple] option:hover {
    background-color: #007bff;
    color: #ffffff;
}

select[multiple] option:checked::before {
    content: "âœ”";
    color: #007bff;
    font-weight: bold;
    margin-right: 8px;
}

        input[type="file"], textarea { margin-top: 10px; width: 100%; max-width: 500px; font-family: Arial, sans-serif; padding: 10px; font-size: 15px;
}
        body {
            font-family: Arial, sans-serif;
            background-color: #f1f1f1;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="password"], input[type="email"], input[type="number"], input[type="month"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .billing-section {
            margin-top: 30px;
        }

        .error-message {
            color: red;
            font-size: 14px;
        }

        .success-message {
            color: green;
            font-size: 14px;
        }


body {
    background: linear-gradient(to bottom right, #19344f, #007bff);
    margin: 0; /* Ensures no extra spacing around the page */
    padding: 0 60px;
    box-sizing: border-box; /* Ensures padding doesn't affect the width */
    transition: background-color 0.3s ease, transform 0.3s ease;
}


/* Usage Tracker Container */
.usage-tracker-section .container {
    max-width: 600px;
    margin: 20px auto;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 2
0px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.usage-tracker-section h2 {
    text-align: center;
    margin-bottom: 20px;
}

.circle-container {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 0 auto;
    margin-bottom: 20px;
}

.circle {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: conic-gradient(
        #007bff 0%,
        #007bff var(--usage-percentage),
        #ccc var(--usage-percentage),
        #ccc 100%
    );
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

#buyCreditsButton {
    margin-top: 20px;
    padding: 10px;
    border: none;
    border-radius: 4px;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
}

#buyCreditsButton:hover {
    background-color: #0056b3;
}



    </style>
</head>
<body>
<!-- Web Header -->
    <header class="site-header">
        <div class="header-container">
            <!-- Logo and Site Title -->
            <div class="logo-title">
                <img src="logo.png" alt="Logo" class="site-logo">
            
	    </div>
	    <!-- Navigation -->
            <nav class="site-navigation">
                <ul>
                    <li><a href="/">Check Compliance</a></li>
                    <div class="nav-hover-box"></div>
        </li>
        <li><a href="profile">Profile</a></li>
        <li class="dropdown">
    <a href="#" class="dropdown-toggle">Admin <i class="fa fa-caret-down"></i></a>
    <div class="nav-hover-box"></div>
    <ul class="dropdown-menu">
        <li><a href="/manage-disclosures">Disclosures</a></li>
        <li><a href="/assign-disclosures">Personalization</a></li>
        <li><a href="/training">System Training</a></li>
        <li><a href="/admin-access">Admin Access</a></li>
    </ul>
</li>
                    
                    <li><a href="login">Logout</a></li>
		    <li id="adminTab" style="display: none;"><a href="control-panel">Admin</a></li>
                </ul>
            </nav>
        </div>
    </header>
</div>
<!-- User Profile Section -->
<div class="profile-section">
   
   <div class="container">
   <h2>User Profile</h2>
        <form id="profileForm">
            <label for="firstName">First Name:</label>
            <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>

            <label for="lastName">Last Name:</label>
            <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>

            <label for="lastName" style="display: none;">Last Name:</label>
<input type="text" id="lastName" name="lastName" value="DefaultLastName" style="display: none;" required>

            <label for="username">Username:</label>
            <input type="text" id="username" name="username" placeholder="Enter your username" required>

	    <!-- Advisor Type field with Save button below it -->
<div class="form-group">
    <label for="advisorType">Advisor Type:</label>
    <select id="advisorType" name="advisorType" style="width: 100%; margin-bottom: 10px;">
        <option value="">-- Select Advisor Type --</option>
        <!-- Options will be populated dynamically -->
    </select>
    <button type="button" id="saveAdvisorTypeBtn" class="btn" style="background-color: #007bff; color: white; width: 100%;">Save Advisor Type</button>
</div>
	    <label for="subscriptionPlan">Subscription Plan:</label>
<input type="text" id="currentSubscriptionPlan" name="currentSubscriptionPlan" readonly placeholder="Subscription Plan" style="background-color: #f1f1f1;">

	    <label for="nextBillingDate">Next Billing Date:</label>
<input type="text" id="nextBillingDate" name="nextBillingDate" readonly placeholder="Fetching next billing date..." style="background-color: #f1f1f1;">

<!-- Cancel Subscription Button (initially hidden) -->
<button type="button" id="cancelSubscriptionButton" onclick="cancelSubscription()" style="display: none;">
    Cancel Subscription
</button>
<div id="cancelSubscriptionMessage" class="success-message" style="display: none;"></div>


            <button type="button" onclick="updateProfile()">Update Profile</button>
            <div id="profileMessage" class="success-message"></div>
        </form>
    </div>
</div>

<footer style="position: fixed; bottom: 0; left: 0; width: 100%; text-align: center; padding: 10px; background-color: white; border-top: 1px solid #ccc; z-index: 9999; color: #333;">
        Â© 2025 Finalyze, LLC. All Rights Reserved.
    </footer>

<!-- Billing Information Section -->
        <div class="billing-section" style="display: none;">
            
            <div class="container">
            <h2>Billing Information</h2>
            <form id="billingForm">
               
		<!-- Dropdown to select the subscription plan -->
        	<label for="subscriptionPlan">Subscription Plan:</label>
        	<select id="subscriptionPlan" name="subscriptionPlan" required>
            	<option value=""> - </option>
		<option value="price_1QfMnGE4vPtJSn6exBGIUhda">Compliance Advisor Access ($19.99/month)</option>
		<option value="price_1QfMosE4vPtJSn6e7K3MfC8A">Compliance Advisor Access ($225/annual)</option>
        	</select>


                <label for="cardholderName">Cardholder Name:</label>
                <input type="text" id="cardholderName" name="cardholderName" placeholder="Enter the cardholder's name" required>


		<!-- Card Element -->
<label for="card-element">Payment Details:</label>
<div id="card-element" style="margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 4px;"></div>
<div id="card-errors" role="alert" class="error-message"></div>

<!-- Billing Address Section (initially hidden) -->
<div id="billingAddressSection" style="display: none; margin-top: 10px;">
    <label for="billingAddress">Billing Address:</label>
    <input type="text" id="billingAddress" placeholder="Street Address" required>

    <label for="billingCity">City:</label>
    <input type="text" id="billingCity" placeholder="City" required>

    <label for="billingState">State:</label>
    <input type="text" id="billingState" placeholder="State" required>

    <label for="billingZip">Postal Code:</label>
    <input type="text" id="billingZip" placeholder="Postal Code" required>

    <label for="billingCountry">Country:</label>
<select id="billingCountry" required>
    <option value="US">United States</option>
    <option value="CA">Canada</option>
    <option value="GB">United Kingdom</option>
    <option value="AU">Australia</option>
    <!-- Add more countries as needed -->
</select>

		 <!-- Subscribe button -->
        	<button type="button" id="subscribeButton" onclick="subscribe()">Subscribe</button>
<div id="loadingSpinner" style="display: none;">ðŸ”„</div>
                <button type="button" onclick="submitBilling()">Update Billing Info</button>
                <div id="billingMessage" class="success-message"></div>
            </form>
        </div>
    </div>


<!-- Usage Tracker Section -->
<div class="usage-tracker-section" style="display: none;">
    
    <div class="container">
    <h2>Usage Tracker</h2>
        <div class="circle-container">
            <div class="circle" id="usageCircle">
                <span id="usagePercentage">0%</span>
            </div>
        </div>
        <p>Usage: <span id="usageValue">0.000</span> / <span id="usageDenominator">5.0</span></p>
<!-- Dropdown to buy more credits -->
        	<label for="usagePlan">Select Usage Credits:</label>
<select id="usagePlan" name="usagePlan" required disabled onfocus="checkSubscriptionStatus()">
    <option value="">- Select Usage Credits -</option>
    <option value="price_1Qf8LCE4vPtJSn6exafXQTA8">$25/usage credit</option>
    <option value="price_1Qf8O4E4vPtJSn6enzkQ08eC">$50/usage credit</option>
    <option value="price_1Qf8QCE4vPtJSn6e6eTX5kTE">$100/usage credit</option>
</select>
<button id="buyCreditsButton" disabled onclick="buyMoreCredits()">Buy More Credits</button>
    </div>
</div>


<button id="buyCreditsButton" style="display: none;" onclick="buyMoreCredits()">Buy More Credits</button>




    <script>
/* Add this JavaScript to handle the spacing dynamically */
document.addEventListener('DOMContentLoaded', function() {
    // Check if the saved instances section exists
    const savedAnalysesSection = document.querySelector('.saved-analyses-section');
    const profileSection = document.querySelector('.profile-section');
    
    // If there's no saved instances section, add more margin to the profile section
    if (!savedAnalysesSection && profileSection) {
        profileSection.style.marginBottom = '150px';
    }
});



// Add this to conditionally hide Admin dropdown based on user permissions
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Fetch the current user's data
        const response = await fetch('/api/current-user');
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const user = await response.json();
        
        // Check if the user has admin access
        const hasAdminAccess = user["Administrator Access NEW"] === "Yes";
        
        // Get the Admin dropdown element
        const adminDropdown = document.querySelector('.site-navigation ul li.dropdown');
        
        // Hide the Admin dropdown if user doesn't have admin access
        if (!hasAdminAccess && adminDropdown) {
            adminDropdown.style.display = 'none';
        }
    } catch (error) {
        console.error('Error checking admin status:', error);
        // Hide Admin dropdown by default if there's an error
        const adminDropdown = document.querySelector('.site-navigation ul li.dropdown');
        if (adminDropdown) {
            adminDropdown.style.display = 'none';
        }
    }
});

// Add this to your existing JavaScript section
document.addEventListener('DOMContentLoaded', function() {
    // Fetch and populate the advisor type dropdown
    populateAdvisorTypeDropdown();
    
    // Add event listener for the Save button
    document.getElementById('saveAdvisorTypeBtn').addEventListener('click', function() {
        saveAdvisorType();
    });
});

// Function to populate the advisor type dropdown
async function populateAdvisorTypeDropdown() {
    try {
        const response = await fetch('/get_scenarios');
        const data = await response.json();
        
        if (data.success && data.scenarios) {
            const advisorTypeDropdown = document.getElementById('advisorType');
            
            // Clear existing options except the first one
            advisorTypeDropdown.innerHTML = '<option value="">-- Select Advisor Type --</option>';
            
            // Add each scenario title as an option
            data.scenarios.forEach(scenario => {
                const option = document.createElement('option');
                option.value = scenario.title;
                option.textContent = scenario.title;
                advisorTypeDropdown.appendChild(option);
            });
            
            // Check if the user has an advisor type already set
            fetchCurrentAdvisorType();
        }
    } catch (error) {
        console.error('Error fetching scenarios for advisor types:', error);
    }
}

// Function to fetch the current user's advisor type
async function fetchCurrentAdvisorType() {
    try {
        const response = await fetch('/api/current-user');
        if (response.ok) {
            const user = await response.json();
            if (user.advisorType) {
                document.getElementById('advisorType').value = user.advisorType;
            }
        }
    } catch (error) {
        console.error('Error fetching current advisor type:', error);
    }
}

async function saveAdvisorType() {
    const advisorType = document.getElementById('advisorType').value;
    const email = document.getElementById('username').value;
    
    if (!email) {
        alert('Username/email is required to save advisor type.');
        return;
    }
    
    // Add a loading indicator to the button
    const saveButton = document.getElementById('saveAdvisorTypeBtn');
    const originalText = saveButton.textContent;
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;
    
    try {
        const response = await fetch('/save_advisor_type', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                advisorType: advisorType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            const profileMessage = document.getElementById('profileMessage');
            profileMessage.textContent = 'Advisor type saved successfully!';
            profileMessage.className = 'success-message';
            profileMessage.style.display = 'block';
            
            // Un-dim the Usage Tracker section
            const trackerSection = document.querySelector('.usage-tracker-section');
            if (trackerSection) {
                trackerSection.style.opacity = '1.0';
                trackerSection.style.pointerEvents = 'auto';
            }
            
            // Set flag in localStorage to hide popup on uploads page
            localStorage.setItem('advisorTypeSelected', 'true');
            
            // Hide message after 3 seconds
            setTimeout(() => {
                profileMessage.style.display = 'none';
            }, 3000);
        } else {
            // Show error message
            alert(result.error || 'Failed to save advisor type.');
        }
    } catch (error) {
        console.error('Error saving advisor type:', error);
        alert('An error occurred while saving your advisor type.');
    } finally {
        // Reset button
        saveButton.textContent = originalText;
        saveButton.disabled = false;
    }
}

async function saveAdvisorType() {
    const advisorType = document.getElementById('advisorType').value;
    const email = document.getElementById('username').value;
    
    if (!email) {
        alert('Username/email is required to save advisor type.');
        return;
    }
    
    // Add a loading indicator to the button
    const saveButton = document.getElementById('saveAdvisorTypeBtn');
    const originalText = saveButton.textContent;
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;
    
    try {
        const response = await fetch('/save_advisor_type', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: email,
                advisorType: advisorType
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message
            const profileMessage = document.getElementById('profileMessage');
            profileMessage.textContent = 'Advisor type saved successfully!';
            profileMessage.className = 'success-message';
            profileMessage.style.display = 'block';
            
            // Un-dim the Usage Tracker section
            const trackerSection = document.querySelector('.usage-tracker-section');
            if (trackerSection) {
                trackerSection.style.opacity = '1.0';
                trackerSection.style.pointerEvents = 'auto';
            }
            
            // Set flag in localStorage to hide popup on uploads page
            localStorage.setItem('advisorTypeSelected', 'true');
            
            // Hide message after 3 seconds
            setTimeout(() => {
                profileMessage.style.display = 'none';
            }, 3000);
        } else {
            // Show error message
            alert(result.error || 'Failed to save advisor type.');
        }
    } catch (error) {
        console.error('Error saving advisor type:', error);
        alert('An error occurred while saving your advisor type.');
    } finally {
        // Reset button
        saveButton.textContent = originalText;
        saveButton.disabled = false;
    }
}

// Add this to your document ready function
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await fetchLoggedInUserTracker(); // Fetch and populate the username field
        fetchNextBillingDate(); // Fetch the next billing date using the populated username
        populateAdvisorTypeDropdown(); // Populate the advisor type dropdown
    } catch (error) {
        console.error("Error during initialization:", error);
    }
});

// Update the profile function to include saving the advisor type
async function updateProfile() {
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const username = document.getElementById('username').value;
    const advisorType = document.getElementById('advisorType').value;
    
    // Validation
    if (!firstName || !lastName || !username) {
        document.getElementById('profileMessage').textContent = "Please fill in all required fields.";
        document.getElementById('profileMessage').className = "error-message";
        return;
    }
    
    try {
        const response = await fetch('/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                firstName: firstName,
                lastName: lastName,
                email: username,
                advisorType: advisorType // Include the advisorType in the update
            }),
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('profileMessage').textContent = "Profile updated successfully!";
            document.getElementById('profileMessage').className = "success-message";
            
            // Show the Cancel Subscription button
            const cancelButton = document.getElementById('cancelSubscriptionButton');
            if (cancelButton) {
                cancelButton.style.display = 'block';
            }
            
            // Store the advisor type locally to maintain selection across page refreshes
            if (window.localStorage) {
                localStorage.setItem('userAdvisorType', advisorType);
            }
        } else {
            document.getElementById('profileMessage').textContent = result.error || "Failed to update profile.";
            document.getElementById('profileMessage').className = "error-message";
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        document.getElementById('profileMessage').textContent = "An error occurred. Please try again.";
        document.getElementById('profileMessage').className = "error-message";
    }
}

// Click to show the "Cancel Subscription" button
function updateProfile() {
    const cancelButton = document.getElementById('cancelSubscriptionButton');
    cancelButton.style.display = 'block';
}



// Cancels the users subscription and connects to @app.route('/api/cancel-subscription', methods=['POST'])
async function cancelSubscription() {
    const email = document.getElementById('username').value;

    if (!email) {
        alert("Email is required to cancel the subscription.");
        return;
    }

    try {
        const response = await fetch('/api/cancel-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });

        if (response.headers.get('content-type')?.includes('application/json')) {
            const data = await response.json();

            const messageDiv = document.getElementById('cancelSubscriptionMessage');

            if (response.ok) {
                messageDiv.textContent = "Subscription canceled successfully.";
                messageDiv.style.display = "block";
                messageDiv.className = "success-message";

                // Optionally update the Next Billing Date to indicate the cancellation
                document.getElementById('nextBillingDate').value = "Subscription Canceled";
		location.reload(); // Reloads page after success

            } else {
                messageDiv.textContent = `Error: ${data.error}`;
                messageDiv.style.display = "block";
                messageDiv.className = "error-message";
            }
        } else {
            console.error("Unexpected response from the server:", await response.text());
            alert("An unexpected error occurred. Please try again.");
        }
    } catch (error) {
        console.error("Error canceling subscription:", error);
        alert("An error occurred. Please try again.");
    }
}




//Fetches and displays the Next Billing Date from Stripe (connects with @app.route('/api/next-billing-date', methods=['GET']) in app.py)
// Ensure the user details are fetched and then proceed to fetch the next billing date
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await fetchLoggedInUserTracker(); // Fetch and populate the username field
        fetchNextBillingDate(); // Fetch the next billing date using the populated username
    } catch (error) {
        console.error("Error during initialization:", error);
    }
});

// Fetches and displays the Next Billing Date
async function fetchNextBillingDate() {
    const email = document.getElementById('username').value;
    if (!email) {
        console.error("Email is required to fetch billing date.");
        return;
    }

    try {
        const response = await fetch(`/api/next-billing-date?email=${encodeURIComponent(email)}`);
        const data = await response.json();
        console.log("Billing date response:", data); // Add this

        if (data.nextBillingDate) {
            // Convert Unix timestamp to readable format
            const nextBillingDate = new Date(data.nextBillingDate * 1000).toLocaleDateString();
            document.getElementById('nextBillingDate').value = `${nextBillingDate}`;
        } else {
            console.error("Error fetching next billing date:", data.error);
        }
    } catch (error) {
        console.error("Error fetching next billing date:", error);
    }
}




// Saves the Selected Subscription Plan at Billing to User Profile Box
let isUpdating = false; // Flag to prevent conflicts

async function saveSelectedPlan() {
    if (isUpdating) return; // Prevent execution during programmatic updates

    const email = document.getElementById('username').value; // Get the user's email
    const subscriptionDropdown = document.getElementById('subscriptionPlan');
    const subscriptionPlan = subscriptionDropdown.options[subscriptionDropdown.selectedIndex].text; // Get the plan's name

    if (!email || !subscriptionPlan || subscriptionPlan === "-") {
        return; // Exit if email or subscription plan is invalid
    }

    try {
        const response = await fetch('/update-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, subscriptionPlan }),
        });

        const result = await response.json();
        if (result.error) {
            console.error(`Error: ${result.error}`);
        } else {
            console.log("Subscription plan saved successfully!");
        }
    } catch (error) {
        console.error("Error sending update request:", error);
    }
}

// Trigger save on subscription plan change
// document.getElementById('subscriptionPlan').addEventListener('change', saveSelectedPlan);




// Updates Subscription with selected option upon registration
async function updateSubscriptionPlan() {
    const email = document.getElementById('username').value;  // Get the user's email
    const subscriptionPlan = document.getElementById('subscriptionPlan').value;  // Get the selected plan

    if (!email || !subscriptionPlan) {
        console.error("Email and subscription plan are required.");
        return;
    }

    try {
        const response = await fetch('/update-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, subscriptionPlan }),
        });

        const result = await response.json();
        if (result.error) {
            console.error("Error updating subscription plan:", result.error);
        } else {
            console.log("Subscription plan updated successfully:", result.message);
        }
    } catch (error) {
        console.error("Error sending update request:", error);
    }
}


async function checkSubscriptionStatus() {
    const loggedInUser = localStorage.getItem('loggedInUser');
    const usagePlanDropdown = document.getElementById('usagePlan');
    const buyCreditsButton = document.getElementById('buyCreditsButton');

    if (!loggedInUser) {
        console.error("No logged-in user found.");
        usagePlanDropdown.disabled = true;
        buyCreditsButton.disabled = true;
        return;
    }

    try {
        const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(loggedInUser)}`);
        const data = await response.json();

        if (data.subscribed) {
            console.log("User is subscribed. Enabling dropdown and button.");
            usagePlanDropdown.disabled = false;
        } else {
            console.log("User is not subscribed. Disabling dropdown and button.");
            usagePlanDropdown.disabled = true;
            buyCreditsButton.disabled = true;
            alert("You need to subscribe to use this feature.");
        }
    } catch (error) {
        console.error("Error checking subscription status:", error);
        usagePlanDropdown.disabled = true;
        buyCreditsButton.disabled = true;
    }
}



function toggleBillingAddress() {
    const billingSection = document.getElementById('billingAddressSection');
    const toggleButton = document.getElementById('toggleBillingAddress');

    if (billingSection.style.display === 'none') {
        billingSection.style.display = 'block';
        toggleButton.textContent = '- Hide Billing Address';
    } else {
        billingSection.style.display = 'none';
        toggleButton.textContent = '+ Add Billing Address';
    }
}


// Update the fetchLoggedInUserTracker function to handle advisor type
async function fetchLoggedInUserTracker() {
    try {
        const response = await fetch('/api/current-user');
        if (!response.ok) {
            throw new Error('Failed to fetch user tracker data.');
        }
        const user = await response.json();
        console.log("Logged-in User:", user);

        // Populate user details in the profile form
        document.getElementById('firstName').value = user.fullName.split(" ")[0];
        document.getElementById('lastName').value = user.fullName.split(" ")[1] || "";
        document.getElementById('username').value = user.email;
        
        // Store the user object for later use
        window.currentUser = user;
        
        // After fetching user data, populate the advisor type dropdown and select the saved value
        await populateAdvisorTypeDropdown();
    } catch (error) {
        console.error('Error fetching tracker data:', error);
    }
}

fetchLoggedInUserTracker();



async function buyMoreCredits() {
    const usagePlan = document.getElementById('usagePlan').value;
    const email = document.getElementById('username').value; // Assuming the email is entered in a field

    if (!usagePlan || !email) {
        alert('Please select a valid usage credit option and provide your email.');
        return;
    }

    try {
        const response = await fetch('/charge-card', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ priceId: usagePlan, email: email }),
        });

        const result = await response.json();

        if (result.error) {
            alert(`Error: ${result.error}`);
        } else if (result.clientSecret) {
            alert('Purchase successful! Your credits have been updated.');
            updateUsageTracker(); // Optional: Update the usage tracker
        }
    } catch (error) {
        console.error('Error processing payment:', error);
        alert('An unexpected error occurred. Please try again.');
    }
}




// Log the logged-in user's email to the console
        const loggedInUser = "{{ user_email }}";
        console.log("Logged-in user:", loggedInUser);


// Fetch the logged-in user's data and log it to the console
    fetch('http://127.0.0.1:5000/api/current-user')
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error fetching user data: ${response.statusText}`);
            }
            return response.json();
        })
        .then(user => {
            console.log("Logged-in User:", user);

            // Optionally display user details on the page
            document.getElementById('firstName').value = user.fullName.split(" ")[0];
            document.getElementById('lastName').value = user.fullName.split(" ")[1] || "";
            document.getElementById('username').value = user.email;
        })
        .catch(error => {
            console.error("Error fetching logged-in user:", error);
        });




const email = "jimmy@aol.com"; // Replace with the logged-in user's email

function updateUsageTracker() {
    fetch('/api/current-user') // Fetch data for the logged-in user
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error fetching user data: ${response.statusText}`);
            }
            return response.json();
        })
        .then(user => {
    // Get usage and denominator from the user's data
            const userUsage = user.usage || 0.0001; // Default usage if undefined
            const userDenominator = user.usage_denominator || 100; // Default denominator if undefined



    // Calculate usage percentage
    const usagePercentage = Math.min((userUsage / userDenominator) * 100, 100);

    // Update circle and usage text
    document.documentElement.style.setProperty('--usage-percentage', `${usagePercentage}%`);
    document.getElementById("usageCircle").style.background = `conic-gradient(
        #007bff 0%,
        #007bff ${usagePercentage}%,
        #ccc ${usagePercentage}%,
        #ccc 100%
    )`;

    // Update text values
    document.getElementById('usagePercentage').textContent = `${usagePercentage.toFixed(1)}%`;
    document.getElementById('usageValue').textContent = userUsage.toFixed(3);
    document.getElementById('usageDenominator').textContent = userDenominator.toFixed(3);
})

        .catch(error => {
            console.error("Error updating usage tracker:", error);
        });
}

// Call the function on page load
updateUsageTracker();


// Replace this with the actual user's usage data
    const userUsage = {
        fullName: "Jimmy",
        email: "jimmy@aol.com",
        usage: 1.4175, // Example usage
	usage_denominator: 721.946, // Example denominator
        flat_rate_paid: false,
    };

    // Calculate percentage using correct denominator
    const usagePercentage = Math.min((userUsage.usage / userUsage.usage_denominator) * 100, 100);


    // Update circle and usage text
    document.documentElement.style.setProperty("--usage-percentage", usagePercentage + "%");
    document.getElementById("usageCircle").style.background = `conic-gradient(
        #007bff 0%,
        #007bff ${usagePercentage}%,
        #ccc ${usagePercentage}%,
        #ccc 100%
    )`;

    document.getElementById("usagePercentage").textContent = `${usagePercentage.toFixed(1)}%`;
    document.getElementById("usageValue").textContent = userUsage.usage.toFixed(3);





	// Initialize Stripe (See real and test keys)

const stripe = Stripe('pk_test_w1lrA7a8EF5wNI87daoqLMJu008mfFsQ7t'); // Replace with your actual test publishable key

//const stripe = Stripe('pk_live_t90TofUsm22Azo9oiPPjQWNi00pOyMaTvj'); // Your publishable key


const elements = stripe.elements();
const cardElement = elements.create('card');
cardElement.mount('#card-element');

// Listen for card changes to detect when the details are complete
cardElement.on('change', (event) => {
    const billingSection = document.getElementById('billingAddressSection');
    const cardErrors = document.getElementById('card-errors');

    if (event.complete) {
        // Show the billing address section when the card details are complete
        billingSection.style.display = 'block';
        cardErrors.textContent = '';
    } else if (event.error) {
        // Display card errors if there are any
        cardErrors.textContent = event.error.message;
        billingSection.style.display = 'none'; // Hide the billing address section if errors occur
    } else {
        // Hide the billing address section if the card details are incomplete
        billingSection.style.display = 'none';
        cardErrors.textContent = '';
    }
});

async function subscribe() {
    const subscriptionPlan = document.getElementById('subscriptionPlan').value;
    if (!subscriptionPlan) {
        document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
        document.getElementById('billingMessage').textContent = "Please select a subscription plan.";
        document.getElementById('billingMessage').className = "error-message";
        return;
    }
    const username = document.getElementById('username').value; // Get the email from the username field

    if (!username) {
        document.getElementById('billingMessage').textContent = "Email is required.";
        document.getElementById('billingMessage').className = "error-message";
        return;
    }

    document.getElementById('billingMessage').innerHTML = '<div class="spinner"></div>'; // Show loading spinner

    // Collect billing address details if visible
    const billingSection = document.getElementById('billingAddressSection');
    const billingDetails = billingSection.style.display === 'block' ? {
        name: document.getElementById('cardholderName').value,
        email: username,
        address: {
            line1: document.getElementById('billingAddress').value,
            city: document.getElementById('billingCity').value,
            state: document.getElementById('billingState').value,
            postal_code: document.getElementById('billingZip').value,
            country: document.getElementById('billingCountry').value,
        },
    } : {
        name: document.getElementById('cardholderName').value,
        email: username,
    };

    try {
        // Create a payment method with the billing details
        const { paymentMethod, error } = await stripe.createPaymentMethod({
            type: 'card',
            card: cardElement,
            billing_details: billingDetails, // Pass billing details
        });

        if (error) {
            document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
            document.getElementById('billingMessage').textContent = error.message;
            document.getElementById('billingMessage').className = "error-message";
            return;
        }

        // Send the payment method and subscription details to your backend
        const response = await fetch('/create-subscription', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                paymentMethodId: paymentMethod.id,
                priceId: subscriptionPlan,
                email: username, // Send email to the backend
            }),
        });

        const result = await response.json();

        if (result.error) {
            document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
            document.getElementById('billingMessage').textContent = result.error;
            document.getElementById('billingMessage').className = "error-message";
        } else if (result.clientSecret) {
            const { error: confirmError } = await stripe.confirmCardPayment(result.clientSecret);

            if (confirmError) {
                document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
                document.getElementById('billingMessage').textContent = confirmError.message;
                document.getElementById('billingMessage').className = "error-message";
            } else {
                // Inform the user of success
                document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
                document.getElementById('billingMessage').textContent = "Subscription successful!";
                document.getElementById('billingMessage').className = "success-message";

                // Update the current subscription plan AFTER the success message
                const subscriptionPlanName = document.getElementById('subscriptionPlan').options[document.getElementById('subscriptionPlan').selectedIndex].text;
                document.getElementById('currentSubscriptionPlan').value = subscriptionPlanName;

                // Optionally update the server-side record (users.json) with the new subscription plan
                await fetch('/update-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: username, subscriptionPlan: subscriptionPlanName }),
                });

                setTimeout(() => location.reload(), 2000); // Reload page after 2 seconds
            }
        } else {
            document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
            document.getElementById('billingMessage').textContent = "Subscription created successfully! No payment required upfront.";
            document.getElementById('billingMessage').className = "success-message";
            setTimeout(() => location.reload(), 2000); // Reload page after 2 seconds
        }
    } catch (error) {
        document.getElementById('billingMessage').innerHTML = ''; // Remove loading spinner
        document.getElementById('billingMessage').textContent = "An error occurred. Please try again.";
        document.getElementById('billingMessage').className = "error-message";
    }
}







    function submitBilling() {
        const cardNumber = document.getElementById('cardNumber').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const cvv = document.getElementById('cvv').value;
        const cardholderName = document.getElementById('cardholderName').value;

        if (!cardNumber || cardNumber.length < 12 || cardNumber.length > 19) {
            document.getElementById('billingMessage').textContent = "Invalid card number!";
            document.getElementById('billingMessage').className = "error-message";
            return;
        }

        console.log("Billing Info Saved:", { cardNumber, expiryDate, cvv, cardholderName });
        document.getElementById('billingMessage').textContent = "Billing information saved successfully!";
        document.getElementById('billingMessage').className = "success-message";
    }

document.getElementById('usagePlan').addEventListener('change', function () {
    const selectedValue = this.value;
    const buyCreditsButton = document.getElementById('buyCreditsButton');

    if (selectedValue && selectedValue !== "") {
        // Enable the button if a valid option is selected
        buyCreditsButton.disabled = false;
    } else {
        // Disable the button if the default or invalid option is selected
        buyCreditsButton.disabled = true;
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    const loggedInUser = localStorage.getItem('loggedInUser');
    const usagePlanDropdown = document.getElementById('usagePlan');
    const buyCreditsButton = document.getElementById('buyCreditsButton');

    if (loggedInUser) {
        console.log(`Logged-in user: ${loggedInUser}`);

        try {
            // Fetch subscription status from the backend
            const response = await fetch(`/api/subscription-status?email=${encodeURIComponent(loggedInUser)}`);
            const data = await response.json();

            if (data.subscribed) {
    console.log("User is subscribed. Enabling dropdown and button.");
    usagePlanDropdown.disabled = false;
    buyCreditsButton.disabled = true; // Initially disabled until a value is selected
} else {
    console.log("User is not subscribed. Disabling dropdown and button.");
    usagePlanDropdown.disabled = true;
    buyCreditsButton.disabled = true;
}
        } catch (error) {
            console.error('Error checking subscription status:', error);
            usagePlanDropdown.disabled = true; // Default to disabled if error occurs
            buyCreditsButton.disabled = true;
        }
    } else {
        console.log('No user is currently logged in.');
        usagePlanDropdown.disabled = true; // Default to disabled if no user is logged in
        buyCreditsButton.disabled = true;
    }
});

document.getElementById('usagePlan').addEventListener('change', function () {
    const selectedValue = this.value;
    const buyCreditsButton = document.getElementById('buyCreditsButton');

    if (selectedValue && selectedValue !== "") {
        // Enable the button if a valid option is selected
        buyCreditsButton.disabled = false;
    } else {
        // Disable the button if the default or invalid option is selected
        buyCreditsButton.disabled = true;
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Fetch the current user's data
        const response = await fetch('/api/current-user');
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const user = await response.json();

        // Check if the user is an Administrator
        if (user.Administrator === "Yes") {
            document.getElementById('adminTab').style.display = 'block'; // Show the Admin tab
        }
    } catch (error) {
        console.error('Error checking admin status:', error);
    }
});

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Fetch the current user data
        const response = await fetch('/api/current-user'); // Endpoint to fetch the logged-in user's data
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const user = await response.json();

        // Populate user details if subscribed
        if (user.Subscribed === "Yes") {
            document.getElementById('firstName').value = user.fullName.split(" ")[0];
            document.getElementById('lastName').value = user.fullName.split(" ")[1] || "";
            document.getElementById('username').value = user.email;
            document.getElementById('currentSubscriptionPlan').value = user.subscriptionPlan ? user.subscriptionPlan : "No subscription plan selected";
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
    }
});

async function dimProfileForUnsubscribedUsers() {
    try {
        const response = await fetch('/api/current-user');
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const user = await response.json();
        
        if (user.Subscribed === "No") {
            // Only dim the usage tracker section
            document.querySelector('.usage-tracker-section').style.opacity = '0.5';
            document.querySelector('.usage-tracker-section').style.pointerEvents = 'none';
            
            // Keep billing section highlighted
            const billingSection = document.querySelector('.billing-section');
            billingSection.style.opacity = '1.0';
            billingSection.style.pointerEvents = 'auto';
            
            // Header remains visible
            const headerContainer = document.querySelector('.header-container');
            headerContainer.style.opacity = '1.0';
            headerContainer.style.pointerEvents = 'auto';
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
    }
}

// Run the function when the page loads
document.addEventListener('DOMContentLoaded', dimProfileForUnsubscribedUsers);


async function updateSubscriptionStatus() {
    try {
        const response = await fetch('/api/current-user'); // Fetch the user data
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const user = await response.json();

	if (user["Sign Up Status"] === "Not Yet") {
            return; // Don't show any status if sign-up isn't finalized
        }

        const nextBillingDateField = document.getElementById('nextBillingDate'); // Target the Next Billing Date field
        const statusField = document.createElement('div'); // Create a div for the status
        statusField.id = 'subscriptionStatus'; // Add an ID to the status div for easy identification
        statusField.style.marginTop = '10px'; // Add spacing
        statusField.style.fontWeight = 'bold'; // Optional styling

        if (user.Unsubscribed === "Yes") {
            statusField.textContent = "Subscription Cancelled. Access ending soon.";
            statusField.style.color = "red"; // Red color for cancelled status
	    document.querySelector('label[for="nextBillingDate"]').textContent = "Access End Date:";
        } else if (user.Subscribed === "Yes") {
            statusField.textContent = "Status: Active";
            statusField.style.color = "green"; // Green color for active status
        }

        // Add the status below the Next Billing Date if it doesn't already exist
        if (!document.getElementById('subscriptionStatus')) {
            nextBillingDateField.insertAdjacentElement('afterend', statusField);
        }
    } catch (error) {
        console.error('Error fetching user data:', error);
    }
}

// Run the function when the page loads
document.addEventListener('DOMContentLoaded', updateSubscriptionStatus);

// Save for Later feature
document.addEventListener('DOMContentLoaded', function() {
    const saveForLaterButton = document.getElementById('saveForLaterButton');
    const titleDialog = document.getElementById('titleDialog');
    const confirmSaveButton = document.getElementById('confirmSave');
    const cancelSaveButton = document.getElementById('cancelSave');
    const titleInput = document.getElementById('savedTitle');
    
    // Add hover effects
    saveForLaterButton.addEventListener('mouseover', function() {
        this.style.backgroundColor = '#218838'; // Darker green on hover
        this.style.transform = 'translateY(-3px)';
        this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
    });
    
    saveForLaterButton.addEventListener('mouseout', function() {
        this.style.backgroundColor = '#28a745'; // Back to original color
        this.style.transform = 'translateY(0)';
        this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
    });
    
    // Show the Save for Later button after the Continue button in the alert is clicked
    if (document.getElementById("submitConfirm")) {
        document.getElementById("submitConfirm").addEventListener("click", function() {
            // Show the Save for Later button
            saveForLaterButton.style.display = "block";
        });
    }
    
    // When Save for Later button is clicked, show title dialog
    saveForLaterButton.addEventListener('click', function() {
        // Show the title dialog
        titleDialog.style.display = "flex";
        
        // Set focus on title input
        setTimeout(() => {
            titleInput.focus();
        }, 100);
        
        // Generate a default title with date and time
        const now = new Date();
        const defaultTitle = `Analysis - ${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        titleInput.value = defaultTitle;
    });
    
    // Handle confirm save
    confirmSaveButton.addEventListener('click', function() {
        saveAnalysis();
    });
    
    // Also allow Enter key to confirm
    titleInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveAnalysis();
        }
    });
    
    // Handle cancel
    cancelSaveButton.addEventListener('click', function() {
        titleDialog.style.display = "none";
    });
    
        function saveAnalysis() {
        const title = titleInput.value.trim() || `Untitled - ${new Date().toLocaleString()}`;
        
        // Get current content
        const revisedText = document.getElementById('revisedText').innerText;
        const selectedOptions = JSON.parse(localStorage.getItem('selectedUseTypes') || '[]');
        
        // Get any displayed disclosures
        let disclosures = [];
        const dynamicInstructions = document.getElementById('dynamicInstructions');
        if (dynamicInstructions) {
            const disclosureDivs = dynamicInstructions.querySelectorAll('.disclosure-content');
            disclosureDivs.forEach(div => {
                const disclosureText = div.innerText.replace(/\n\s*\n/g, '\n');
                disclosures.push(disclosureText);
            });
        }
        
        // Create saved analysis object
        const savedAnalysis = {
            id: Date.now().toString(),
            title: title,
            date: new Date().toISOString(),
            revisedText: revisedText,
            selectedOptions: selectedOptions,
            disclosures: disclosures
        };
        
        // Get existing saved analyses or initialize empty array
        const savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
        
        // Add new analysis to the beginning of the array
        savedAnalyses.unshift(savedAnalysis);
        
        // Save to localStorage
        localStorage.setItem('savedAnalyses', JSON.stringify(savedAnalyses));
        
        // Close dialog
        titleDialog.style.display = "none";
        
        // Provide feedback to user
        const originalText = saveForLaterButton.innerHTML;
        saveForLaterButton.innerHTML = '<i class="fas fa-check" style="margin-right: 8px;"></i> Saved Successfully!';
        saveForLaterButton.style.backgroundColor = '#218838';
        
        setTimeout(() => {
            saveForLaterButton.innerHTML = originalText;
            saveForLaterButton.style.backgroundColor = '#28a745';
        }, 2000);
    }
});


// Add this to your existing Profile page code
function populateSavedAnalyses() {
    // Get saved analyses from localStorage
    const savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
    
    // Check if there are any saved analyses
    if (savedAnalyses.length === 0) {
        return; // No saved analyses to display
    }
    
    // Create the Saved Analyses section if it doesn't exist
    let savedAnalysesSection = document.querySelector('.saved-analyses-section');
    
    if (!savedAnalysesSection) {
        // Create the section
        savedAnalysesSection = document.createElement('div');
        savedAnalysesSection.className = 'saved-analyses-section';
        
        // Create container
        const container = document.createElement('div');
        container.className = 'container';
        container.style.marginTop = '20px';
        
        // Add heading
        const heading = document.createElement('h2');
        heading.textContent = 'Saved Instances';
        
        // Create table
        const table = document.createElement('table');
        table.id = 'savedAnalysesTable';
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.marginTop = '20px';
        
        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        const headers = ['Title', 'Date', 'Actions'];
        headers.forEach(headerText => {
            const th = document.createElement('th');
            th.textContent = headerText;
            th.style.padding = '12px';
            th.style.backgroundColor = '#007bff';
            th.style.color = 'white';
            th.style.textAlign = 'left';
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Create table body
        const tbody = document.createElement('tbody');
        table.appendChild(tbody);
        
        // Append elements
        container.appendChild(heading);
        container.appendChild(table);
        savedAnalysesSection.appendChild(container);
        
        // Insert the section before the footer
        const footer = document.querySelector('footer');
        document.body.insertBefore(savedAnalysesSection, footer);
    }
    
    // Get the table body to update
    const tbody = document.querySelector('#savedAnalysesTable tbody');
    tbody.innerHTML = ''; // Clear existing content
    
    // Add each saved analysis to the table
    savedAnalyses.forEach(analysis => {
        const row = document.createElement('tr');
        
        // Title cell
        const titleCell = document.createElement('td');
        titleCell.textContent = analysis.title;
        titleCell.style.padding = '12px';
        titleCell.style.borderBottom = '1px solid #ddd';
        
        // Date cell
        const dateCell = document.createElement('td');
        const date = new Date(analysis.date);
        dateCell.textContent = date.toLocaleString();
        dateCell.style.padding = '12px';
        dateCell.style.borderBottom = '1px solid #ddd';
        
        // Actions cell
        const actionsCell = document.createElement('td');
        actionsCell.style.padding = '12px';
        actionsCell.style.borderBottom = '1px solid #ddd';
        
        // View button
        const viewButton = document.createElement('button');
        viewButton.textContent = 'View';
        viewButton.style.marginRight = '5px';
        viewButton.style.padding = '5px 10px';
        viewButton.style.backgroundColor = '#007bff';
        viewButton.style.color = 'white';
        viewButton.style.border = 'none';
        viewButton.style.borderRadius = '3px';
        viewButton.style.cursor = 'pointer';
        
        viewButton.onclick = function() {
    // Check if the saved analysis has URL path and parameters
    if (analysis.pathname && analysis.pathname.length > 0) {
        // Store the selected analysis in localStorage for loading
        localStorage.setItem('loadSavedAnalysis', JSON.stringify(analysis));
        
        // Store selected alternatives from this analysis (if they exist)
        if (analysis.selectedAlternatives) {
            localStorage.setItem('selectedAlternatives', JSON.stringify(analysis.selectedAlternatives));
        }
        
        // Construct URL to return to the original page
        let url = analysis.pathname;
        if (analysis.urlParams && analysis.urlParams.length > 0) {
            url += '?' + analysis.urlParams;
        }
        
        // Add a parameter indicating we're loading a saved analysis
        if (url.includes('?')) {
            url += '&loadSaved=true';
        } else {
            url += '?loadSaved=true';
        }
        
        // Redirect to the original page
        window.location.href = url;
    } else {
        // Fallback if pathname not available
        alert("Cannot load this saved analysis. Please try again.");
    }
};
        
        // Delete button
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.style.padding = '5px 10px';
        deleteButton.style.backgroundColor = '#dc3545';
        deleteButton.style.color = 'white';
        deleteButton.style.border = 'none';
        deleteButton.style.borderRadius = '3px';
        deleteButton.style.cursor = 'pointer';
        
        deleteButton.onclick = function() {
            if (confirm('Are you sure you want to delete this saved analysis?')) {
                // Remove from saved analyses
                const updatedAnalyses = savedAnalyses.filter(item => item.id !== analysis.id);
                localStorage.setItem('savedAnalyses', JSON.stringify(updatedAnalyses));
                
                // Refresh the table
                populateSavedAnalyses();
            }
        };
        
        actionsCell.appendChild(viewButton);
        actionsCell.appendChild(deleteButton);
        
        // Add cells to row
        row.appendChild(titleCell);
        row.appendChild(dateCell);
        row.appendChild(actionsCell);
        
        // Add row to table
        tbody.appendChild(row);
    });
}

// Check if we're on the profile page and populate saved analyses
if (window.location.pathname.includes('/profile')) {
    document.addEventListener('DOMContentLoaded', populateSavedAnalyses);
}


viewButton.onclick = function() {
    // Check if the saved analysis has URL path and parameters
    if (analysis.pathname && analysis.pathname.length > 0) {
        // Store the selected analysis in localStorage for loading
        localStorage.setItem('loadSavedAnalysis', JSON.stringify(analysis));
        
        // Store selected alternatives from this analysis (if they exist)
        if (analysis.selectedAlternatives) {
            localStorage.setItem('selectedAlternatives', JSON.stringify(analysis.selectedAlternatives));
        }
        
        // Construct URL to return to the original page
        let url = analysis.pathname;
        if (analysis.urlParams && analysis.urlParams.length > 0) {
            url += '?' + analysis.urlParams;
        }
        
        // Add a parameter indicating we're loading a saved analysis
        if (url.includes('?')) {
            url += '&loadSaved=true';
        } else {
            url += '?loadSaved=true';
        }
        
        // Redirect to the original page
        window.location.href = url;
    } else {
        // Fallback if pathname not available
        alert("Cannot load this saved analysis. Please try again.");
    }
};

    </script>

<!-- Save for Later Button -->
<button id="saveForLaterButton" style="display: none; margin: 20px auto; padding: 12px 24px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;">
    <i class="fas fa-save" style="margin-right: 8px;"></i> Save for Later
</button>

<!-- Title Input Dialog -->
<div id="titleDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); text-align: left; max-width: 90%; width: 400px; margin: 40px auto;">
        <h3 style="margin-top: 0; text-align: center;">Save This Analysis</h3>
        <p style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #666;">Enter a title to help you identify this saved analysis:</p>
        
        <input type="text" id="savedTitle" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;" placeholder="Enter a title for this analysis">
        
        <div style="text-align: center;">
            <button id="confirmSave" style="margin: 10px; padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
            <button id="cancelSave" style="margin: 10px; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>
</body>
</html>