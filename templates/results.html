<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results</title>
    
    <!-- Add Google Fonts link BEFORE any styles -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
/* Header navigation highlight styles */
.highlight-header-nav {
    animation: glow-pulse 2s infinite;
    box-shadow: 0 0 10px 5px rgba(0, 123, 255, 0.5);
    border-radius: 8px;
    padding: 5px;
    background-color: rgba(255, 255, 255, 0.1);
}

/* Pulsing glow animation for the header nav */
@keyframes glow-pulse {
    0% {
        box-shadow: 0 0 10px 2px rgba(0, 123, 255, 0.5);
    }
    50% {
        box-shadow: 0 0 20px 5px rgba(0, 123, 255, 0.8);
    }
    100% {
        box-shadow: 0 0 10px 2px rgba(0, 123, 255, 0.5);
    }
}

/* Glow effect for individual nav items */
.nav-item-glow {
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
}

/* Ensure the navigation bar is above other elements */
.header-container nav.site-navigation {
    position: relative;
    z-index: 1000;
}

.recycle-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s ease, transform 0.2s ease;
    width: 32px;
    height: 32px;
}

.recycle-button:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.recycle-button svg {
    width: 16px;
    height: 16px;
}

/* Notes section - appears at the bottom of each category */
.notes-section {
    display: none; /* Hide the notes section */
}

/* Notes header */
.notes-section h4 {
    display: none; /* Hide the notes header */
}


/* Container for the entire reminders box */
#instructionsBox {
    background-color: #fff !important;
    border-radius: 8px !important;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    margin-top: 30px !important;
    padding: 20px !important;
}

/* Section for each content type category */
#dynamicInstructions > ul {
    padding-left: 0 !important;
    list-style-type: none !important;
}

#dynamicInstructions > ul > li {
    background-color: #f8f9fa !important;
    border-radius: 8px !important;
    margin-bottom: 20px !important;
    padding: 18px !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05) !important;
    border: 1px solid #e9ecef !important;
}

/* Category header styling */
#dynamicInstructions > ul > li > strong {
    display: block !important;
    font-size: 17px !important;
    color: #2c3e50 !important;
    margin-bottom: 12px !important;
    border-bottom: 2px solid #dee2e6 !important;
    padding-bottom: 8px !important;
}

/* Tab container positioning */
#dynamicInstructions > ul > li .disclosure-tabs {
    margin-top: 15px !important;
}

/* Better tab styling */
.disclosure-tab {
    font-weight: 500 !important;
    text-transform: uppercase !important;
    font-size: 13px !important;
    letter-spacing: 0.5px !important;
}

/* Active tab is more prominent */
.disclosure-tab.active {
    font-weight: 600 !important;
    box-shadow: 0 -3px 5px rgba(0,0,0,0.05) !important;
}

/* Panel content area */
.disclosure-panel {
    background-color: #ffffff !important;
    padding: 18px !important;
    border: 1px solid #dee2e6 !important;
    border-top: none !important;
}

/* Disclosure panel headers */
.disclosure-panel h4 {
    color: #3498db !important;
    font-size: 16px !important;
    margin-top: 0 !important;
    margin-bottom: 12px !important;
    font-weight: 600 !important;
}

/* Notes section - appears at the bottom of each category */
.notes-section {
    margin-top: 10px;
    font-size: 0.9em;
    color: #2e3236;
    font-style: italic;
}

/* Notes header */
.notes-section h4 {
    color: #007bff !important;
    font-weight: 600 !important;
    margin-top: 0 !important;
    margin-bottom: 8px !important;
    font-size: 15px !important;
}

/* Page-specific content section */
.page-tab-content {
    border-left: 4px solid #979899 !important;
    padding: 15px !important;
    margin-bottom: 15px !important;
    background-color: #f8f9fa !important;
    border-radius: 0 4px 4px 0 !important;
}

/* Last page tab doesn't need bottom margin */
.page-tab-content:last-child {
    margin-bottom: 0 !important;
}

/* Page numbers in page-specific sections */
.page-number {
    font-weight: 600 !important;
    color: #333 !important;
    margin-bottom: 8px !important;
    font-size: 15px !important;
}

/* Visual indicator for content types (different colors for each) */
#dynamicInstructions > ul > li:nth-child(1) {
    border-left: 5px solid #3498db !important; /* Social Media - Blue */
}

#dynamicInstructions > ul > li:nth-child(2) {
    border-left: 5px solid #9b59b6 !important; /* Booklet - Purple */
}

#dynamicInstructions > ul > li:nth-child(3) {
    border-left: 5px solid #2ecc71 !important; /* Presentation - Green */
}

#dynamicInstructions > ul > li:nth-child(4) {
    border-left: 5px solid #e74c3c !important; /* Audio - Red */
}

#dynamicInstructions > ul > li:nth-child(5) {
    border-left: 5px solid #f39c12 !important; /* Video - Orange */
}

#dynamicInstructions > ul > li:nth-child(6) {
    border-left: 5px solid #1abc9c !important; /* Article - Teal */
}

#dynamicInstructions > ul > li:nth-child(7) {
    border-left: 5px solid #e67e22 !important; /* Graphic - Amber */
}

#dynamicInstructions > ul > li:nth-child(8) {
    border-left: 5px solid #95a5a6 !important; /* Other - Gray */
}

/* Animation for smooth appearance */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#dynamicInstructions > ul > li {
    animation: fadeIn 0.3s ease-out forwards !important;
}

/* Staggered animation for list items */
#dynamicInstructions > ul > li:nth-child(1) { animation-delay: 0.1s !important; }
#dynamicInstructions > ul > li:nth-child(2) { animation-delay: 0.2s !important; }
#dynamicInstructions > ul > li:nth-child(3) { animation-delay: 0.3s !important; }
#dynamicInstructions > ul > li:nth-child(4) { animation-delay: 0.4s !important; }
#dynamicInstructions > ul > li:nth-child(5) { animation-delay: 0.5s !important; }
#dynamicInstructions > ul > li:nth-child(6) { animation-delay: 0.6s !important; }
#dynamicInstructions > ul > li:nth-child(7) { animation-delay: 0.7s !important; }
#dynamicInstructions > ul > li:nth-child(8) { animation-delay: 0.8s !important; }


/* OR target more specifically if you have other paragraphs you want to keep */
#instructionsContent li > strong + p {
    display: none !important;
}

/* Tab Navigation Styles */
.disclosure-tabs {
    display: flex;
    margin-bottom: 0;
    border-bottom: 1px solid #dee2e6;
}

.disclosure-tab {
    padding: 10px 15px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
    cursor: pointer;
    margin-right: 5px;
    font-size: 14px;
    transition: background-color 0.2s ease;
}

.disclosure-tab:hover {
    background-color: #e9ecef;
}

.disclosure-tab.active {
    background-color: #fff;
    border-bottom: 1px solid #fff;
    margin-bottom: -1px;
    font-weight: 600;
    color: #007bff;
}

.disclosure-panel {
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 4px 4px;
    padding: 15px;
    background-color: #fff;
    animation: fadeIn 0.3s ease-in-out;
    display: none;
    margin-bottom: 15px;
}

.disclosure-panel.active {
    display: block;
}

/* Page Disclosure Styling */
.page-tab-content {
    border-left: 4px solid #6c757d;
    padding: 10px 15px;
    margin-bottom: 10px;
    background-color: #f8f9fa;
    border-radius: 0 4px 4px 0;
}

.page-number {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
    font-size: 16px;
}

#pageSpecificDisclosures {
    display: none !important;
    margin-top: 30px;
    padding: 20px;
    border-radius: 8px;
    background-color: #fff;
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#pageSpecificDisclosures:hover {
    transform: translateY(-5px);
    box-shadow: 0px 12px 24px rgba(0, 0, 0, 0.15);
}

#pageSpecificDisclosures h2 {
    color: #333;
    margin-bottom: 20px;
    text-align: center;
}

.page-disclosure {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-left: 4px solid #28a745;
    border-radius: 4px;
}

.page-disclosure h5 {
    margin-top: 0;
    color: #28a745;
    font-weight: 600;
}

.page-disclosure p {
    margin: 5px 0;
}


/* Make sure the intro-container is not dimmed */
.intro-container {
    position: relative;
    z-index: 999; /* Ensure this appears above the overlay */
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.3); /* Add a subtle glow */
}


/* Add these to your existing styles */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.intro-container {
    /* Add to existing styles */
    animation: fadeIn 0.8s ease-out forwards;
}

.benefit-item {
    /* Add to existing styles */
    transition: all 0.3s ease;
}

.benefit-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    background: rgba(255, 255, 255, 0.2);
}

.intro-icon {
    /* Add to existing styles */
    transition: transform 0.3s ease;
}

.intro-icon:hover {
    transform: scale(1.1);
}











/* Intro Section Styles */
.intro-section {
    margin-bottom: 40px;
}

.intro-container {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 30px;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    gap: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin: 0 auto;
    max-width: 1200px;
}

.intro-icon {
    background: linear-gradient(135deg, #2c5282, #0072ff);
    width: 100px;
    height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
}

.intro-icon i {
    font-size: 48px;
    color: white;
}

.intro-content {
    flex: 1;
}

.intro-content h2 {
    font-size: 28px;
    margin-bottom: 15px;
    color: white;
}

.intro-content p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
}

.intro-benefits {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}

.benefit-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255, 255, 255, 0.9);
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    border: 1px solid rgba(255, 255, 255, 0.15);
}

.benefit-item i {
    color: #4ade80;
}

/* Media query for mobile responsiveness */
@media (max-width: 768px) {
    .intro-container {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .intro-benefits {
        flex-direction: column;
        align-items: center;
    }
    
    .intro-icon {
        width: 80px;
        height: 80px;
    }
    
    .intro-icon i {
        font-size: 36px;
    }
}

.site-navigation ul li a {
    display: inline-block !important;
    text-decoration: none !important;
    padding: 8px 12px !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.dropdown .dropdown-menu {
    display: none !important;
}

.dropdown:hover .dropdown-menu {
    display: block !important;
}

/* Dropdown styles */
.dropdown {
    position: relative;
}

.dropdown-toggle {
    cursor: pointer;
}

.dropdown-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 180px;
    background-color: #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-radius: 4px;
    z-index: 1000;
    padding: 8px 0;
}

.dropdown-menu li {
    display: block;
    width: 100%;
    margin: 0;
}

.dropdown-menu li a {
    padding: 8px 16px;
    display: block;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
}

.dropdown-menu li a:hover {
    background-color: #f5f5f5;
}

.dropdown:hover .dropdown-menu {
    display: block;
}

/* Font Awesome icon for dropdown */
.fa-caret-down {
    margin-left: 5px;
}

/* Dropdown Button */
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9fa;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1000;
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    text-align: left;
}

.dropdown-content a:hover {
    background-color: #f1f1f1;
}

.dropdown:hover .dropdown-content {
    display: block;
}

.page-disclosure {
    margin-bottom: 15px;
    padding: 10px;
    background-color: #f8f9fa;
    border-left: 4px solid #28a745;
    border-radius: 4px;
}

.page-disclosure h5 {
    margin-top: 0;
    color: #28a745;
    font-weight: 600;
}

#instructionsBox {
    display: none !important;
}

#assignedScenarioContainer {
    display: none !important;
}

.disclosure-toggle {
    background-color: #f0f0f0;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px 10px;
    margin: 10px 0;
    display: block;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.disclosure-toggle:hover {
    background-color: #e0e0e0;
}

.disclosure-content {
    border-radius: 4px;
    margin-top: 10px;
    padding: 15px;
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Blocks the Confirm social compliance and Back button at bottom of page */
#confirmComplianceButton, 
#confirmComplianceButton + button,
a[href="/"] {
    display: none !important; /* Use !important to override any inline styles */
}

/* Hover effect for the buttons in the Revised Analyzed Text Section */
.action-button {
    transition: transform 0.2s ease, background-color 0.2s ease;
}

.action-button:hover {
    transform: translateY(-3px); /* Moves the button 3px upward on hover */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Adds shadow for floating effect */
}

/* Specific hover effects for each button */
#copyButton:hover {
    background-color: #5a6268; /* Darker gray on hover */
}

#submitButton:hover {
    background-color: #0056b3; /* Darker blue on hover */
}

#exitButton:hover {
    background-color: #bd2130; /* Darker red on hover */
}

/* Font for entire RESULTS HTML page */
html, body, button, input, select, textarea, div, p, h1, h2, h3, h4, h5, h6, a, span, label {
        font-family: 'Montserrat', sans-serif !important;
    }

/* Logo and Title Alignment */
.logo-title {
    display: flex;
    align-items: center;
    gap: 12px; /* Spacing between logo and title */
}


/* Larger logo styling */
.logo-title .site-logo {
    height: 200px; /* Try a moderate increase first */
    max-height: 200px; /* Ensure it doesn't get too large */
}


@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

.feedback-box {
    display: none; /* Keeps the entire feedback box hidden initially */
}

.full-sentence {
    display: none;
}

.rationale-only {
    display: inline; /* Makes only the rationale part visible */
}

.feedback-box {
    display: none; /* Hidden by default */
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    font-weight: bold;
    text-align: center;
    color: white;
}

.feedback-box.green {
    background-color: #28a745; /* Green color for compliant */
}

.feedback-box.red {
    background-color: #dc3545; /* Red color for non-compliant */
}

#uploadButton {
    display: inline-block;
    width: 3in; /* Match width */
    padding: 10px 6px; /* Same padding */
    margin: 20px 0; /* Same margin */
    background-color: #007bff; /* Blue background color */
    color: white; /* White text color */
    text-decoration: none; /* Remove underline */
    border: none; /* No border */
    border-radius: 4px; /* Slightly rounded corners */
    font-size: 16px; /* Match font size */
    text-align: center; /* Center text */
    cursor: pointer; /* Pointer cursor on hover */
    line-height: normal; /* Consistent line height */
    transition: transform 0.2s ease, background-color 0.2s ease; /* Smooth hover effects */
}

#uploadButton:hover {
    background-color: #0056b3; /* Darker blue on hover */
    transform: translateY(-3px); /* Same hover effect */
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.confirmed {
    background-color: #007bff; /* Same blue color */
    color: white;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    padding: 8px 12px;
    cursor: default; /* Disable pointer */
    pointer-events: none; /* Prevent clicking */
    text-align: center; /* Center text alignment */
}

#toggleAnalyzedTextButton {
    display: none; /* Hidden by default */
}

.compliance-analysis {
    display: none; /* Hidden by default */
}

#toggleComplianceTextButton {
    padding: 8px 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-left: auto; /* Push the button to the right in the flex container */
}

#toggleComplianceTextButton:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

#revisedTextBox {
    border-radius: 8px;
    background-color: #fff;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    display: none; /* Initially hidden */
    max-height: none; /* Allow box to expand fully */
    overflow: visible; /* Prevent content cutoff */
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* Optional: Smooth expand/collapse effect */
}

#revisedTextBox:hover {
    transform: translateY(-5px); /* Moves the box slightly upward */
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.1); /* Deeper shadow on hover */
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth hover animation */
}

#toggleRevisedTextButton {
    padding: 8px 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    position: relative; /* Ensures proper alignment in the box */
}

#generateLoadingBar {
    margin-left: 10px; /* Space between the button and the loading bar */
    display: none; /* Initially hidden */
    vertical-align: middle; /* Align with button */
}

/* Overlay for dimming the rest of the page */
.dim-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
    z-index: 998; /* Below the highlighted elements */
    display: none; /* Hidden by default */
}

/* Highlighted button on top of the dim overlay */
.highlighted {
    position: relative;
    z-index: 999; /* Ensure this appears above the overlay */
    box-shadow: none; /* Remove Blue glow effect */
    transition: box-shadow 0.5s ease; /* Smooth transition */
}

/* Adjust the arrow for highlighting */
#arrowIndicator {
    z-index: 999; /* Above the dim overlay */
}

.highlight-button {
    box-shadow: 0 0 15px 5px rgba(0, 123, 255, 0.5); /* Blue glowing effect */
    transition: box-shadow 0.5s ease; /* Smooth transition */
}
.highlight-arrow {
    color: none; /* Red color for emphasis */
    font-size: 28px; /* Slightly larger arrow */
    transition: color 0.5s ease; /* Smooth transition */
}

/* Moving arrow indicator pointing left */
#arrowIndicator {
    position: absolute;
    top: 10%; /* Will be dynamically updated */
    left: 100%; /* Will be dynamically updated */
    transform: translate(10px, -50%);
    font-size: 48px;
    color: white;
    animation: bounce 1s infinite;
    display: none; /* Hidden by default */
    z-index: 1001; /* Ensure it appears above other elements */
}

@keyframes bounce {
    0%, 100% {
        transform: translate(10px, -55%);
    }
    50% {
        transform: translate(15px, -50%);
    }
}
/* Full-screen overlay for dimming effect */
#pageOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
    z-index: 999; /* Ensure it appears above all content */
    display: none; /* Hidden by default */
}

/* Highlight specific sections */
.highlight {
    position: relative;
    z-index: 1000; /* Ensure these sections appear above the overlay */
    background-color: white; /* Optional: ensure a solid background */
}
        /* Header Styles */
.site-header {
    background: transparent;
    color: white;
    padding: 10px 0; /* Reduced padding */
    box-shadow: none;
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
    min-height: 60px;
}
.site-title {
    font-family: 'Roboto Slab', serif; /* Replace with your chosen font */
    font-size: 28px;
    font-weight: bold;
    margin: 0;
}
.site-navigation ul {
    list-style: none;
    display: flex;
    gap: 20px;
    margin: 0;
    padding: 0;
}
.site-navigation a {
    color: white;
    text-decoration: none;
    font-size: 18px;
    padding: 8px 12px; /* Button padding */
    border-radius: 4px; /* Rounded corners */
    transition: transform 0.3s ease, color 0.3s ease; /* Smooth transition for hover effects */
}

.site-navigation a:hover {
    transform: scale(1.07); /* Slightly increase size on hover */
    background-color: transparent; /* Ensure no background appears on hover */
}
/* Include Font Awesome for icons */

        /* Existing styles */
        body {
            font-family: Arial, sans-serif;
            font-size: 16px;
            margin: 20px;
            line-height: 1.5;
            background-color: linear-gradient(45deg, #343a40, #007bff); /* Matching blue gradient color */
            color: #333; /* Ensure text remains readable */
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        h1, h2 {
            color: #333;
        }
        a {
    display: inline-block;
    padding: 10px 15px;
    background-color: linear-gradient(45deg, #343a40, #007bff); /* Removed gray background */
    color: #007bff; /* Changed to blue for the button text */
    text-decoration: none;
    border-radius: 5px;
    transition: background-color 0.3s ease, transform 0.3s ease;
}

body {
    background: linear-gradient(to bottom right, #19344f, #007bff);
    margin: 0; /* Ensures no extra spacing around the page */
    padding: 0 60px;
    box-sizing: border-box; /* Ensures padding doesn't affect the width */
    transition: background-color 0.3s ease, transform 0.3s ease;
}

a:hover {
    background-color: #e2e6ea; /* Light background effect on hover */
    transform: translateY(-2px); /* Slight upward movement on hover */
}
        .compliance-box {
    border: none; /* Remove the border */
    border-radius: 8px; /* Keep rounded corners for a soft look */
    padding: 20px; /* Inner padding */
    margin-top: 20px; /* Space above the box */
    max-width: 100%; /* Ensure it doesn't exceed container width */
    overflow-wrap: break-word; /* Prevent content overflow */
    background-color: #fff; /* White background */
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.1); /* Enhanced shadow effect */
    transition: transform 0.2s ease, box-shadow 0.2s ease; /* Smooth hover animation */
}

.compliance-box:hover {
    transform: translateY(-5px); /* Moves the box 5px upwards on hover */
    box-shadow: 0px 12px 24px rgba(0, 0, 0, 0.15); /* Deeper shadow on hover for floating effect */
        }
        .compliance-item {
    background-color: #f0f0f0; /* Slightly darker shade */
    border-radius: 8px; /* Rounded corners */
    margin-top: 15px; /* Space between items */
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for default state */
    overflow: hidden; /* Prevent content overflow */
    transition: transform 0.2s ease, box-shadow 0.2s ease; /* Smooth hover animation */
}

.compliance-item:hover {
    transform: translateY(-5px); /* Moves the box 5px upwards on hover */
    box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.15); /* Deeper shadow effect on hover */
        }
.button-group {
    display: inline-flex; /* Align the buttons horizontally */
    align-items: center; /* Vertically align buttons */
    gap: 10px; /* Space between the buttons */
}
        .compliance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            font-weight: bold;
            background-color: #6c757d;
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .toggle-button {
            background-color: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .toggle-button:hover {
            background-color: #5a6268;
        }
        .compliance-content {
            padding: 15px;
            display: none;
        }
        .recycle-button {
    display: inline-flex; /* Align icon horizontally */
    align-items: center; /* Vertically center the icon */
    background-color: #007bff; /* Blue background color */
    color: white; /* White icon color */
    border: none; /* Remove border */
    cursor: pointer; /* Pointer cursor on hover */
    padding: 10px; /* Padding for comfortable click area */
    border-radius: 4px; /* Rounded corners, but keep it square */
    transition: background-color 0.2s ease, transform 0.2s ease; /* Smooth hover animation */
}

.recycle-button:hover {
    background-color: #0056b3; /* Darker blue on hover */
    transform: translateY(-2px); /* Slight upward movement on hover */
}

.recycle-button svg {
    fill: white; /* Make sure the icon matches the button text color */
}

        .select-button {
    display: inline-flex;
    align-items: center;
    background-color: transparent; /* Remove gray background */
    color: #28a745; /* Green text color */
    border: 1px solid #28a745; /* Border to match text color */
    cursor: pointer;
    font-size: 14px;
    padding: 10px;
    border-radius: 4px;
    transition: background-color 0.2s ease, transform 0.2s ease;
}

.select-button:hover {
    background-color: rgba(40, 167, 69, 0.1); /* Light green hover background */
    transform: translateY(-2px); /* Slight upward movement on hover */
}
        .go-back-button {
            color: #dc3545;
            border: 1px solid #dc3545;
        }
        .go-back-button:hover {
            background-color: #dc3545;
            color: white;
        }
        .selected-alternative {
    font-size: 14px;
    color: #007bff;
    font-weight: bold;
    margin-top: 10px; /* Adjust as needed */
    margin-left: 0; /* Align with flagged instance text */
    padding-left: 15px; /* Ensure it aligns consistently */
        }
        .custom-alternative {
            font-style: italic;
            color: #555;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .custom-alternative input[type="text"] {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            max-width: 500px;
        }
        .feedback-line {
            font-size: 14px;
            color: #333;
            margin-top: 5px;
            font-weight: bold;
        }

        /* Loading bar next to buttons */
        .loading-bar {
            width: 100px;
            height: 8px;
            background-color: #ddd;
            border-radius: 4px;
            margin-left: 8px;
            display: none; /* Hidden by default */
            overflow: hidden;
        }
        .loading-progress {
            height: 100%;
            background-color: #6c757d;
            width: 0; /* Start with 0 width */
        }
        .compliance-link {
    display: inline-block;
    width: 3in; /* Keep the width at 3 inches */
    padding: 10px 6px; /* Add padding inside the button (above and below: 10px, sides: 6px) */
    margin: 20px 0; /* Add 20px of space above and below the button */
    background-color: #007bff; /* Blue background color */
    color: white; /* White text color */
    text-decoration: none; /* Remove underline */
    border: none; /* No border */
    border-radius: 4px; /* Slightly rounded corners */
    font-size: 16px; /* Match font size to "Go Back" button */
    text-align: center; /* Center text */
    cursor: pointer; /* Pointer cursor on hover */
    line-height: normal; /* Ensure consistent line height */
    transition: transform 0.2s ease, background-color 0.2s ease; /* Smooth transition for hover effects */
}

.compliance-link:hover {
    background-color: #0056b3; /* Darker blue on hover */
    transform: translateY(-3px); /* Moves the button 3px upward on hover */
}
#newDisclosuresContainer:hover {
    transform: translateY(-5px); /* Moves the box slightly up */
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Increases shadow on hover */
}
#generateDisclosuresBtn {
    background: linear-gradient(to right, white 0%, #007bff 100%); /* White fill moving over blue */
    background-size: 0% 100%; /* Start with no fill */
    background-repeat: no-repeat; /* Prevent repeating the gradient */
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    padding: 10px 6px;
    cursor: pointer;
    line-height: normal;
    text-align: center;
    overflow: hidden; /* Ensure fill stays within button bounds */
    position: relative; /* Position relative for pseudo-elements or children */
    transition: transform 0.3s ease, background-size 0.5s ease; /* Smooth transition for hover and animation */
}

#generateDisclosuresBtn::after {
    content: ""; /* Creates the water fill effect */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, white, rgba(255, 255, 255, 0)); /* White fades out */
    z-index: 1; /* Overlay effect */
    transition: transform 2s ease-in-out; /* Smooth water-like animation */
    transform: translateX(-100%); /* Start from outside the button */
}

#generateDisclosuresBtn:hover {
    transform: translateY(-3px); /* Slight lift for emphasis */
}

#generateDisclosuresBtn:active {
    transform: translateY(0); /* Reset lift on click */
}

#generateDisclosuresBtn.filling::after {
    transform: translateX(0); /* Fill effect moves across the button */
}

.site-navigation ul li {
    display: flex !important; /* Force display of all navigation items */
}
    </style>
</head>
<body>
<div id="pageOverlay"></div>
<!-- Web Header -->
<div class="video-header">
    <video autoplay muted loop class="background-video">
        <source src="globe.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <header class="site-header">
        <div class="header-container">
            <!-- Logo and Site Title -->
            <div class="logo-title">
                <img src="/logo.png" alt="Logo" class="site-logo">
            </div>
            <!-- Navigation -->
<nav class="site-navigation">
    <ul>
        <li>
            <a href="/">Compliance Check</a>
            <div class="nav-hover-box"></div>
        </li>
        <li>
            <a href="/profile">Profile</a>
            <div class="nav-hover-box"></div>
        </li>
        <li class="dropdown">
    <a href="#" class="dropdown-toggle">Admin <i class="fa fa-caret-down"></i></a>
    <div class="nav-hover-box"></div>
    <ul class="dropdown-menu">
        <li><a href="/manage-disclosures">Disclosures</a></li>
        <li><a href="/assign-disclosures">Personalization</a></li>
        <li><a href="/admin/training">System Training</a></li>
        <li><a href="/admin-access">Admin Access</a></li>
    </ul>
</li>
        <li>
            <a href="login">Logout</a>
            <div class="nav-hover-box"></div>
        </li>
    </ul>
</nav>
        </div>
    </header>
</div>

<!-- Intro Section -->
<div class="intro-section">
    <div class="intro-container">
        <div class="intro-icon">
            <i class="fas fa-clipboard-check"></i>
        </div>
        <div class="intro-content">
            <h2>Analysis Results</h2>
            <p>Review your text for compliance issues and resolve them with suggested alternatives. Our system helps ensure your communications meet regulatory standards.</p>
            <!-- 
            <div class="intro-benefits">
                <div class="benefit-item">
                    <i class="fas fa-check-circle"></i>
                    <span>Identify issues</span>
                </div>
                <div class="benefit-item">
                    <i class="fas fa-lightbulb"></i>
                    <span>Suggested solutions</span>
                </div>
                <div class="benefit-item">
                    <i class="fas fa-shield-alt"></i>
                    <span>Stay compliant</span>
                </div>
            </div>
            -->
        </div>
    </div>
</div>

    <div id="analyzedTextBox" class="compliance-box highlight">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Analyzed Text</h2>
        <button id="toggleAnalyzedTextButton" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Show Analyzed Text
        </button>
    </div>
    <p id="analyzedTextContent" style="display: none; margin-top: 10px;">{{ text | safe }}</p>
</div>
    <!-- FINRA Compliance Analysis Box -->
<div id="finraComplianceBox" class="compliance-box highlight">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Compliance Analysis</h2>
        <button id="toggleComplianceTextButton" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Show Compliance Details
        </button>
    </div>
    <div class="compliance-analysis" style="display: none;">
    <p><strong>Please select a compliant alternative.</strong></p>
    {% if finra_analysis %}
    {% for item in finra_analysis %}
        {% if item.flagged_instance and item.flagged_instance not in ["N/A", "None"] %}
            <div class="compliance-item" id="itemContainer{{ loop.index }}">
                <div class="compliance-header" id="header{{ loop.index }}">
    Flagged Instance {{ loop.index }}
    <button class="toggle-button" onclick="toggleContent({{ loop.index }})" id="toggleButton{{ loop.index }}">
        Expand
    </button>
</div>
                <div class="compliance-content" id="content{{ loop.index }}">
                    <div id="flaggedInstance{{ loop.index }}">
                        <div class="full-sentence">
                            <strong>Full Sentence:</strong> {{ item.flagged_instance|safe }}
                        </div>
                        <div style="white-space: pre-wrap;"><strong>Flagged Instance:</strong> {{ item.flagged_instance|safe }}</div>
                        <strong>Page Number:</strong> {{ item.page }}
                    </div>

                    {% if item.specific_compliant_alternative %}
                        <div>
                            <strong>Compliant Alternative:</strong>
                            <span id="compliantAlternative{{ loop.index }}">{{ item.specific_compliant_alternative }}</span>
                            <div class="button-group">
                                <button class="recycle-button" title="Recycle" onclick="recycleAlternative('{{ loop.index }}')">
    <i class="fas fa-sync-alt"></i>
</button>
                                <button class="select-button" title="Select" onclick="selectAlternative('{{ loop.index }}', 'compliant')">Select</button>
                            </div>
                            <div class="loading-bar" id="recycleLoadingBar{{ loop.index }}" style="display: none;">
                                <div class="loading-progress" id="recycleLoadingProgress{{ loop.index }}"></div>
                            </div>
                        </div>
                        <div class="custom-alternative">
                            <label for="customAlt{{ loop.index }}">Test custom alternative:</label>
                            <input type="text" placeholder="Type your custom alternative here" id="customAlt{{ loop.index }}">
                            <button class="test-button" onclick="testCustomAlternative('{{ loop.index }}')">Test</button>
                            <button class="select-button" id="customSelect{{ loop.index }}" disabled onclick="selectAlternative('{{ loop.index }}', 'custom')">Select</button>
                            <div class="loading-bar" id="loadingBar{{ loop.index }}">
                                <div class="loading-progress" id="loadingProgress{{ loop.index }}"></div>
                            </div>
                        </div>
                        <div class="feedback-line" id="feedback{{ loop.index }}" style="margin-top: 10px; display: none;"></div>
                        <div id="expandButtonContainer{{ loop.index }}"></div>

                        <div id="feedbackBox{{ loop.index }}" class="feedback-box">
                            <span class="rationale-only">
                                {{ item.rationale|safe }}
                            </span>
                        </div>
                    {% endif %}
                </div>
                <div id="selectedAlternative{{ loop.index }}" class="selected-alternative" style="display: none;">
                    Selected Alternative: <span id="selectedText{{ loop.index }}"></span>
                </div>
            </div>
        {% endif %}
    {% endfor %}
{% else %}
    <p>No compliance issues found.</p>
    <div id="actionButtons" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
        <button id="submitButton" class="action-button" style="background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; font-size: 16px;">
            <i class="fas fa-paper-plane" style="margin-right: 5px;"></i> GENERATE DISCLOSURES
        </button>
        <button id="exitButton" class="action-button" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; font-size: 16px;">
            <i class="fas fa-times" style="margin-right: 5px;"></i> EXIT WITHOUT SAVING
        </button>
    </div>
    <script>

// Add this to your existing JavaScript code
document.getElementById("toggleComplianceTextButton").addEventListener("click", function() {
    // Target the header navigation specifically
    const headerNav = document.querySelector(".header-container nav.site-navigation");
    
    if (this.textContent === "Show Compliance Details") {
        // User is showing compliance details - highlight the header nav
        
        // Add highlight class to the nav
        headerNav.classList.add("highlight-header-nav");
        
        // Add a glowing border to each nav item
        const navItems = document.querySelectorAll(".header-container .site-navigation ul li a");
        navItems.forEach(item => {
            item.classList.add("nav-item-glow");
        });
        
        // Add a small indicator arrow pointing up at the nav
        if (!document.getElementById("nav-indicator")) {
            const indicator = document.createElement("div");
            indicator.id = "nav-indicator";
            indicator.innerHTML = "â†‘ Navigation Bar";
            indicator.style.position = "fixed";
            indicator.style.top = "65px";
            indicator.style.right = "20px";
            indicator.style.color = "#fff";
            indicator.style.background = "rgba(0, 123, 255, 0.8)";
            indicator.style.padding = "5px 10px";
            indicator.style.borderRadius = "4px";
            indicator.style.fontSize = "14px";
            indicator.style.zIndex = "9999";
            document.body.appendChild(indicator);
        }
    } else {
        // User is hiding compliance details - remove highlight
        headerNav.classList.remove("highlight-header-nav");
        
        // Remove glow from nav items
        const navItems = document.querySelectorAll(".header-container .site-navigation ul li a");
        navItems.forEach(item => {
            item.classList.remove("nav-item-glow");
        });
        
        // Remove the indicator
        const indicator = document.getElementById("nav-indicator");
        if (indicator) {
            indicator.remove();
        }
    }
});
        // Special handling when no compliance issues are found
document.addEventListener('DOMContentLoaded', function() {
    // 1. Hide the revised text box and make sure it stays hidden
    var revisedTextBox = document.getElementById("revisedTextBox");
    revisedTextBox.style.display = "none";
    
    // Override any attempt to show it
    Object.defineProperty(revisedTextBox.style, 'display', {
        get: function() { return "none"; },
        set: function(value) { /* Do nothing - always keep it as "none" */ }
    });
    
    // 2. Set up proper dimming effect with lighter opacity
    var pageOverlay = document.getElementById("pageOverlay");
    if (pageOverlay) {
        // Allow the overlay to be displayed with lighter opacity
        pageOverlay.style.display = "block";
        pageOverlay.style.backgroundColor = "rgba(0, 0, 0, 0.3)"; // Lighter overlay (0.3 opacity)
    }
    
    // Create a dim overlay for dimming effect if it doesn't exist
    var dimOverlay = document.querySelector(".dim-overlay");
    if (!dimOverlay) {
        dimOverlay = document.createElement("div");
        dimOverlay.classList.add("dim-overlay");
        dimOverlay.style.position = "fixed";
        dimOverlay.style.top = "0";
        dimOverlay.style.left = "0";
        dimOverlay.style.width = "100%";
        dimOverlay.style.height = "100%";
        dimOverlay.style.backgroundColor = "rgba(0, 0, 0, 0.3)"; // Lighter overlay (0.3 opacity)
        dimOverlay.style.zIndex = "998"; // Below the highlighted elements
        document.body.appendChild(dimOverlay);
    } else {
        // Update existing overlay opacity
        dimOverlay.style.backgroundColor = "rgba(0, 0, 0, 0.3)"; // Lighter overlay (0.3 opacity)
    }
    
    // Show the overlay for dimming
    if (dimOverlay) {
        dimOverlay.style.display = "block";
    }
    
    // 3. Add highlight class to the boxes we want to keep visible
    var analyzedTextBox = document.getElementById("analyzedTextBox");
    var complianceBox = document.getElementById("finraComplianceBox");
    var instructionsBox = document.getElementById("instructionsBox");
    var saveForLaterButton = document.getElementById("saveForLaterButton");
    
    if (analyzedTextBox) analyzedTextBox.classList.add("highlight");
    if (complianceBox) complianceBox.classList.add("highlight");
    if (instructionsBox) {
        // Configure the instructions box (Generated Disclosures)
        instructionsBox.removeAttribute('style');
        instructionsBox.style.backgroundColor = "#fff";
        instructionsBox.style.borderRadius = "8px";
        instructionsBox.style.boxShadow = "0 4px 12px rgba(0,0,0,0.1)";
        instructionsBox.style.marginTop = "30px";
        instructionsBox.style.padding = "20px";
        // Initially hidden, but will be shown when needed
        instructionsBox.style.display = "none";
        
        // Mark it as highlight so it will be visible when shown
        instructionsBox.classList.add("highlight");
    }
    
    // Add highlight class to Save for Later button and make it visible when needed
    if (saveForLaterButton) {
        saveForLaterButton.classList.add("highlight");
        // Initially hidden, will be shown after instructions
        saveForLaterButton.style.display = "none";
    }
    
    // 4. Make the submitButton directly show the instructionsBox and save button
    var submitButton = document.getElementById("submitButton");
    if (submitButton) {
        submitButton.addEventListener('click', function() {
            // Don't show the Revised Analyzed Text box - skip this step entirely
            
            // Call the generateDisclosures function directly
            generateDisclosures();
            
            // Make sure the instructions box appears above the overlay
            if (instructionsBox) {
                instructionsBox.style.display = "block";
                instructionsBox.style.position = "relative";
                instructionsBox.style.zIndex = "1000";
                
                // Show the Save for Later button after instructions are displayed
                setTimeout(function() {
                    if (saveForLaterButton) {
                        saveForLaterButton.style.display = "block";
                        saveForLaterButton.style.position = "relative";
                        saveForLaterButton.style.zIndex = "1000";
                    }
                }, 500); // Short delay to ensure proper order
            }
        });
    }
    
    // 5. Disable toggle functionality for the revised text box
    var toggleRevisedTextButton = document.getElementById("toggleRevisedTextButton");
    if (toggleRevisedTextButton) {
        // Hide the toggle button completely
        toggleRevisedTextButton.style.display = "none";
        
        // Or make it do nothing when clicked
        toggleRevisedTextButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
    }
    
    // 6. Ensure the title dialog for saving is also highlighted
    var titleDialog = document.getElementById("titleDialog");
    if (titleDialog) {
        titleDialog.classList.add("highlight");
    }
    
    console.log("No compliance issues found: Modified UI elements for proper dimming");
});
    </script>
{% endif %}      
</div>

    </div>

    <!-- Revised Analyzed Text Section -->
<div id="revisedTextBox" class="compliance-box">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Revised Analyzed Text</h2>
        <button id="toggleRevisedTextButton" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Show Revised Text
        </button>
    </div>
    <p id="revisedText" style="display: none; margin-top: 10px;">{{ revised_text | safe }}</p>
    
    <!-- Action Buttons -->
<div id="actionButtons" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
    <button id="copyButton" class="action-button" style="background-color: #6c757d; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; font-size: 16px;">
        <i class="fas fa-copy" style="margin-right: 5px;"></i> COPY
    </button>
    <button id="submitButton" class="action-button" style="background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; font-size: 16px;">
        <i class="fas fa-paper-plane" style="margin-right: 5px;"></i> GENERATE DISCLOSURES
    </button>
    <button id="exitButton" class="action-button" style="background-color: #dc3545; color: white; border: none; border-radius: 4px; padding: 10px 15px; cursor: pointer; font-size: 16px;">
        <i class="fas fa-times" style="margin-right: 5px;"></i> EXIT WITHOUT SAVING
    </button>
</div>
</div>
<div id="preloader" style="display: none; text-align: center; margin-top: 10px;">
    <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
</div>
    <!-- Replace the Generate Disclosures button area with this code -->
<div style="display: flex; gap: 15px; margin-top: 20px; position: relative; z-index: 1002;">
    <button id="generateDisclosuresBtn" onclick="generateDisclosures()" style="display: none; padding: 10px 40px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; line-height: normal; text-align: center; transition: transform 0.2s ease; position: relative; z-index: 1002;">
        Next
    </button>
    <button id="goBackBtn" onclick="goBackToPreviousStep()" style="display: none; padding: 10px 40px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; text-decoration: none; text-align: center; transition: transform 0.2s ease; position: relative; z-index: 1002;">
        Go Back
    </button>
</div>
    <div id="generateLoadingBar" class="loading-bar">
    <div id="generateLoadingProgress" class="loading-progress"></div>
    </div>
    <div id="arrowIndicator"></div>
    <h2 style="display: none;">Disclosures:</h2>
<ul id="disclosuresSection" style="display: none;">
    <li>{{ disclosures[0] | safe }}</li>
    <li>
        <p>
            {% if assigned_scenario %}
                <span id="disclosureScenario" style="font-weight: bold;">{{ assigned_scenario | safe }}</span> 
            {% else %}
                <span id="disclosureScenario" style="display: none;"></span>
            {% endif %}
            {% for disclosure in sliced_disclosures %}
                {{ disclosure | safe }}{% if not disclosure.endswith('.') %}.{% endif %}
            {% endfor %}
        </p>
    </li>
</ul>
   
    <!-- New Disclosures Section -->
<div id="newDisclosuresContainer" style="display: none; margin-top: 20px; padding: 20px; background-color: #ffffff; border: none; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease;">
    <h2 id="newDisclosuresTitle" style="color: black; margin-bottom: 15px;">New Disclosures</h2>
    <ul id="newDisclosuresSection" style="list-style: none; padding: 0;">
        <!-- Disclosures will be dynamically populated here -->
    </ul>
</div>

<!-- Assigned Scenario Section -->
<div id="assignedScenarioContainer" class="compliance-box" style="margin-top: 20px; display: none;">
    <h3>Assigned Scenario</h3>
    <p id="assignedScenarioText"></p>
</div>


<!-- Upload Box (hidden initially) -->
<div style="display: none; flex-direction: column; gap: 15px;" id="uploadFinalContainer">
    <a href="#" id="uploadButton" class="upload-link">Upload Final</a>
    <div id="uploadBox" style="display: none; border: 2px dashed #007bff; padding: 20px; text-align: center; margin-top: 10px; border-radius: 8px; background-color: #f9f9f9;">
        <p>Drag and drop files here or <button id="fileSelectButton" style="color: #007bff; background: none; border: none; cursor: pointer; text-decoration: underline;">click to select</button></p>
        <input id="fileInput" type="file" style="display: none;" multiple />
    </div>
</div>

    <!-- Social Profile Compliance Link -->
    <div style="display: flex; align-items: center; gap: 10px;">
        <a href="#" id="confirmComplianceButton" class="compliance-link">Confirm Social Profile Compliance</a>
        <button onclick="archiveText()" class="compliance-link" style="background-color: #5ab334; display: none;">
            Submit
        </button>
    </div>
</div>


    <a href="/">Go back</a>

<!-- Revised Reminders Box -->
<div id="instructionsBox" class="compliance-box" style="display: none; margin-top: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Generated Disclosures</h2>
        <button id="toggleInstructionsButton" style="padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Hide Instructions
        </button>
    </div>
    <div id="instructionsContent" style="margin-top: 15px;">
        <div id="dynamicInstructions">
            <!-- This will be dynamically populated based on selections -->
        </div>
    </div>
</div>

    <script>

// Add or update this function
function rebuildRevisedText() {
    // Start with the original text
    let newRevisedText = originalText;
    
    // Apply all current selections to build a fresh revised text
    for (let i = 1; i <= totalItems; i++) {
        const selectedTextElement = document.getElementById(`selectedText${i}`);
        if (selectedTextElement && selectedTextElement.textContent) {
            const selectedAlternative = selectedTextElement.textContent;
            
            // Get the corresponding flagged instance
            const flaggedInstanceElement = document.querySelector(`#flaggedInstance${i} > div[style="white-space: pre-wrap;"]`);
            if (flaggedInstanceElement) {
                const flaggedInstance = flaggedInstanceElement.textContent.replace("Flagged Instance:", "").trim();
                const cleanedFlaggedInstance = flaggedInstance.replace(/\s+/g, ' ').trim();
                
                // Replace this flagged instance with the selected alternative
                const regex = new RegExp(cleanedFlaggedInstance, 'g');
                newRevisedText = newRevisedText.replace(regex, selectedAlternative);
            }
        }
    }
    
    // Update the global revisedText variable
    revisedText = newRevisedText;
    
    // Also update the DOM if the revisedText element is visible
    const revisedTextElement = document.getElementById("revisedText");
    if (revisedTextElement) {
        revisedTextElement.innerText = revisedText;
    }
    
    return revisedText;
}

// Add these global variables at the top of your script section
let nextButtonClicked = false;

function generateDisclosures() {
    // Set the flag that the Next button has been clicked
    nextButtonClicked = true;
    
    // Rebuild the revised text to ensure it includes all current selections
    rebuildRevisedText();
    
    const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
    const goBackBtn = document.getElementById("goBackBtn");
    const preloader = document.getElementById("preloader");
    const revisedTextBox = document.getElementById("revisedTextBox");
    const revisedTextContent = document.getElementById("revisedText");
    const actionButtons = document.getElementById("actionButtons");
    const toggleRevisedTextButton = document.getElementById("toggleRevisedTextButton");
    
    // Hide both the Finalize button and Go Back button
    generateDisclosuresBtn.style.display = "none";
    goBackBtn.style.display = "none";
    
    // Show the Revised Analyzed Text section when Generate Disclosures is clicked
    revisedTextBox.style.display = "block";
    
    // Make sure the content inside is also visible
    revisedTextContent.style.display = "block";
    actionButtons.style.display = "flex";
    
    // Update the toggle button text to match the state
    toggleRevisedTextButton.textContent = "Hide Revised Text";
    
    // Minimize the Compliance Analysis section
    const complianceAnalysisContent = document.querySelector(".compliance-analysis");
    const toggleComplianceButton = document.getElementById("toggleComplianceTextButton");
    
    if (complianceAnalysisContent.style.display !== "none") {
        complianceAnalysisContent.style.display = "none";
        toggleComplianceButton.textContent = "Show Compliance Details";
    }

    // Show the preloader
    preloader.style.display = "block";

    // Retrieve the logged-in user from localStorage
    const loggedInUser = localStorage.getItem("loggedInUser") || "Unknown";

    // Get the most up-to-date revised text (which includes the latest selected alternatives)
    const currentText = revisedTextContent.innerText;
    
    // Store current text to preserve it
    const originalDisplay = currentText;
    
    // Remove any existing user scenario and disclosures to get clean text for API calls
    const cleanedText = currentText.replace(/User Scenario:[\s\S]*?(?=\n\n|$)/g, '')
                                  .replace(/Disclosures:[\s\S]*?(?=$)/g, '')
                                  .trim();
    
    // DON'T update the displayed text, just use cleaned text for API calls
    // revisedTextContent.innerText = cleanedText;

    // Call the API to get matching disclosures based on the latest cleaned text
    fetch("/get_matching_disclosures", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ text: cleanedText })
    })
    .then(response => {
        // Check if the response is ok before proceeding
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        return response.json();
    })
    .then(matchingData => {
        console.log("Matching disclosures response:", matchingData);
        
        // Add validation for the expected data structure
        if (!matchingData || typeof matchingData !== 'object') {
            throw new Error('Invalid response format for matching disclosures');
        }
        
        // Get the matched disclosures from the API response
        const matchedDisclosures = matchingData.disclosures || [];
        
        // Format the disclosures
        let disclosuresContent = matchedDisclosures.join(" ");
        
        // Now fetch the user's assigned scenario
        return fetch("/get_user_scenario")
            .then(response => {
                // Check if the response is ok before proceeding
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                return response.json();
            })
            .then(scenarioData => {
                console.log("User scenario response:", scenarioData);
                
                // Get the user scenario text if available
                let userScenario = "";
                if (scenarioData.success && scenarioData.hasScenario) {
                    userScenario = scenarioData.scenarioText || "";
                }
                
                // Now fetch any other data from the original endpoint
                return fetch("/generate_disclosures", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Logged-In-User": loggedInUser,
                    },
                    body: JSON.stringify({ text: cleanedText }),
                })
                .then((response) => {
                    // Check if the response is ok before proceeding
                    if (!response.ok) {
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    // Get any additional system-generated scenario if there's no user-assigned one
                    if (!userScenario && data.assigned_scenario) {
                        userScenario = data.assigned_scenario;
                    }
                    
                    // Store the scenario and the matched disclosures in localStorage
                    localStorage.setItem('pendingUserScenario', userScenario);
                    localStorage.setItem('pendingDisclosures', disclosuresContent);
                    
                    // Update the display of the assigned scenario if it exists
                    const assignedScenarioContainer = document.getElementById("assignedScenarioContainer");
                    const assignedScenarioText = document.getElementById("assignedScenarioText");
                    if (assignedScenarioText) {
                        assignedScenarioText.textContent = userScenario;
                    }
                    if (assignedScenarioContainer && userScenario) {
                        assignedScenarioContainer.style.display = "block";
                    } else if (assignedScenarioContainer) {
                        assignedScenarioContainer.style.display = "none";
                    }
                    
                    // Clear previous instructions content before updating
                    const dynamicInstructions = document.getElementById("dynamicInstructions");
                    if (dynamicInstructions) {
                        dynamicInstructions.innerHTML = '';
                        
                        // Add the scenario if available
                        if (userScenario) {
                            const scenarioDiv = document.createElement('div');
                            scenarioDiv.className = 'user-scenario';
                            scenarioDiv.innerHTML = `<strong>Your Scenario:</strong> ${userScenario}`;
                            dynamicInstructions.appendChild(scenarioDiv);
                        }
                    }
                    
                    // Show the instructionsBox with reminders
                    const instructionsBox = document.getElementById("instructionsBox");
                    if (instructionsBox) {
                        instructionsBox.style.display = "block";
                    }
                    
                    try {
                        // Regenerate disclosure toggles with the updated content
                        if (typeof addDisclosureTogglesToReminders === 'function') {
                            addDisclosureTogglesToReminders();
                        }
                        
                        // Update the user scenario in the disclosures
                        if (typeof updateDisclosureTogglesWithScenario === 'function') {
                            updateDisclosureTogglesWithScenario();
                        }
                    } catch (err) {
                        console.warn('Non-critical error in disclosure toggles:', err);
                        // Don't throw this error as it's not critical
                    }
                    
                    // Return the combined data for further processing if needed
                    return {
                        userScenario,
                        disclosuresContent
                    };
                });
            });
    })
    .catch((error) => {
        console.error("Error fetching disclosures:", error);
        
        // Simply log the error instead of showing an alert
        console.warn("Suppressing error alert:", error.message);
        
        // Fallback to default disclosures in case of error
        return {
            userScenario: "",
            disclosuresContent: "Investing involves risk including loss of principal. No strategy assures success or protects against loss."
        };
    })
    .finally(() => {
        // Hide preloader when done, regardless of success or failure
        preloader.style.display = "none";
    });
}

// New function to store selected alternatives for comparison
function storeSelectedAlternatives() {
    originalSelectedAlternatives = {};
    
    // Loop through all items and store their selected alternatives
    for (let i = 1; i <= totalItems; i++) {
        const selectedTextElement = document.getElementById(`selectedText${i}`);
        if (selectedTextElement) {
            originalSelectedAlternatives[i] = selectedTextElement.textContent;
        }
    }
}

// Listener for page specific disclosures
document.addEventListener('DOMContentLoaded', function() {

    const filename = "{{ filename }}";
    if (filename) {
        localStorage.setItem('currentFilename', filename);
    }
});

// Add this at the beginning of your DOMContentLoaded event
document.addEventListener('DOMContentLoaded', function() {
    // Make sure the instructionsBox is hidden when the page loads
    const instructionsBox = document.getElementById('instructionsBox');
    if (instructionsBox) {
        instructionsBox.style.display = 'none';
    }
});

function addScenarioToDisclosures() {
    // Get the assigned scenario from wherever it's available
    let userScenario = '';
    
    // First try to get it from the disclosureScenario element in the page
    const disclosureScenario = document.getElementById('disclosureScenario');
    if (disclosureScenario && disclosureScenario.textContent) {
        userScenario = disclosureScenario.textContent.trim();
    }
    
    // If not found, try from localStorage
    if (!userScenario) {
        userScenario = localStorage.getItem('pendingUserScenario') || '';
    }
    
    // Now find all disclosure content divs in the reminders section
    const disclosureDivs = document.querySelectorAll('[id$="-disclosures"]');
    
    disclosureDivs.forEach(div => {
        // Skip the social media one which has special handling
        if (div.id === 'socialMedia-disclosures') {
            return;
        }
        
        // Find the Required Disclosures paragraph
        const disclosureParagraph = div.querySelector('p:not(:first-child)');
        if (disclosureParagraph && userScenario) {
            // Create a strong element for the scenario
            const scenarioStrong = document.createElement('strong');
            scenarioStrong.textContent = userScenario + ' ';
            
            // Save the original text content
            const originalText = disclosureParagraph.textContent;
            
            // Clear the paragraph
            disclosureParagraph.innerHTML = '';
            
            // Add the scenario in bold
            disclosureParagraph.appendChild(scenarioStrong);
            
            // Add the rest of the disclosures
            disclosureParagraph.appendChild(document.createTextNode(originalText));
        }
    });
}

// Function to make sure user scenario is included in the disclosures
function updateDisclosureTogglesWithScenario() {
    // Allow a small delay for the DOM to update
    setTimeout(() => {
        // Get the user scenario
        const userScenario = localStorage.getItem('pendingUserScenario') || '';
        if (!userScenario) return;
        
        // Find all disclosure panels
        const disclosurePanels = document.querySelectorAll('[id$="-disclosures-panel"]');
        
        disclosurePanels.forEach(panel => {
            // Skip the social media one which has special handling
            if (panel.id === 'social-media-post-disclosures-panel') return;
            
            // Find the content paragraphs (not including investing risk disclosure)
            const contentParagraphs = Array.from(panel.querySelectorAll('p')).filter(p => 
                !p.textContent.includes('Investing involves risk including loss of principal'));
            
            // If we found at least one paragraph that's not the investing risk one
            if (contentParagraphs.length > 0) {
                const mainParagraph = contentParagraphs[contentParagraphs.length - 1];
                
                // Check if it already has the scenario
                if (!mainParagraph.innerHTML.includes(`<strong>${userScenario}</strong>`)) {
                    // Create a strong element for the scenario
                    const scenarioStrong = document.createElement('strong');
                    scenarioStrong.textContent = userScenario + ' ';
                    
                    // Save the original text content
                    const originalText = mainParagraph.textContent;
                    
                    // Clear the paragraph
                    mainParagraph.innerHTML = '';
                    
                    // Add the scenario in bold
                    mainParagraph.appendChild(scenarioStrong);
                    
                    // Add the rest of the disclosures
                    mainParagraph.appendChild(document.createTextNode(originalText.replace(userScenario, '').trim()));
                }
            }
        });
        
        // Do the same for page-specific disclosures in the Pages tabs
        const pagesPanels = document.querySelectorAll('[id$="-pages-panel"]');
        
        pagesPanels.forEach(panel => {
            // Skip panels for content types that don't use page-specific disclosures
            if (panel.id === 'social-media-post-pages-panel' ||
                panel.id === 'audio-or-podcast-pages-panel' ||
                panel.id === 'video-pages-panel' ||
                panel.id === 'article-pages-panel' ||
                panel.id === 'graphic-or-image-pages-panel' ||
                panel.id === 'other-format-pages-panel') {
                return;
            }
            
            // Find all page content sections
            const pageContents = panel.querySelectorAll('.page-tab-content p');
            
            pageContents.forEach(pageContent => {
                // Check if it already has the scenario
                if (!pageContent.innerHTML.includes(`<strong>${userScenario}</strong>`)) {
                    // Create a strong element for the scenario
                    const scenarioStrong = document.createElement('strong');
                    scenarioStrong.textContent = userScenario + ' ';
                    
                    // Save the original text content
                    const originalText = pageContent.textContent;
                    
                    // Clear the paragraph
                    pageContent.innerHTML = '';
                    
                    // Add the scenario in bold
                    pageContent.appendChild(scenarioStrong);
                    
                    // Add the rest of the disclosures
                    pageContent.appendChild(document.createTextNode(originalText.replace(userScenario, '').trim()));
                }
            });
        });
    }, 100);
}

// Function to fetch and display user's assigned scenario disclosure
function fetchAndDisplayUserScenario() {
    fetch('/get_user_scenario')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.hasScenario) {
                // Store the scenario text in localStorage
                localStorage.setItem('pendingUserScenario', data.scenarioText);
                
                // Update the disclosureScenario element if it exists
                const disclosureScenario = document.getElementById('disclosureScenario');
                if (disclosureScenario) {
                    disclosureScenario.textContent = data.scenarioText;
                    disclosureScenario.style.display = 'inline'; // Make sure it's visible
                }
                
                // If the disclosures section is displayed, make sure the scenario text appears first
                const disclosuresSection = document.getElementById('disclosuresSection');
                if (disclosuresSection && disclosuresSection.style.display !== 'none') {
                    // Find the paragraph containing disclosures and prepend the scenario text
                    const disclosureParagraph = disclosuresSection.querySelector('li:nth-child(2) p');
                    if (disclosureParagraph) {
                        // Clear existing content first
                        disclosureParagraph.innerHTML = '';
                        
                        // Create and add the scenario span
                        const scenarioSpan = document.createElement('span');
                        scenarioSpan.style.fontWeight = 'bold';
                        scenarioSpan.textContent = data.scenarioText + ' ';
                        disclosureParagraph.appendChild(scenarioSpan);
                        
                        // Add the rest of the disclosures
                        const slicedDisclosures = {{ sliced_disclosures | tojson }};
                        slicedDisclosures.forEach(disclosure => {
                            const text = document.createTextNode(disclosure);
                            disclosureParagraph.appendChild(text);
                            
                            // Add period if needed
                            if (!disclosure.endsWith('.')) {
                                disclosureParagraph.appendChild(document.createTextNode('.'));
                            }
                        });
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error fetching scenario:', error);
        });
}

// Call the function when the page loads
document.addEventListener('DOMContentLoaded', fetchAndDisplayUserScenario);

document.addEventListener('DOMContentLoaded', function() {
    // Hide the Confirm Social Profile Compliance button and Go Back button
    const confirmComplianceButton = document.getElementById('confirmComplianceButton');
    if (confirmComplianceButton) {
        confirmComplianceButton.style.display = 'none';
    }
    
    // The Go Back button is likely the one with the class "compliance-link" next to the Confirm button
    // This assumes it's the next button after confirmComplianceButton
    const goBackButton = document.querySelector('#confirmComplianceButton + button');
    if (goBackButton) {
        goBackButton.style.display = 'none';
    }
    
    // If the Go Back button has a specific ID, you can use this instead:
    // const goBackButton = document.getElementById('goBackButtonId');
    // if (goBackButton) {
    //     goBackButton.style.display = 'none';
    // }
});

document.addEventListener('DOMContentLoaded', function() {
    // Get references to buttons
    const copyButton = document.getElementById('copyButton');
    const submitButton = document.getElementById('submitButton');
    const exitButton = document.getElementById('exitButton');
    const revisedText = document.getElementById('revisedText');

    // Add the action-button class to each button if it doesn't already have it
    copyButton.classList.add('action-button');
    submitButton.classList.add('action-button');
    exitButton.classList.add('action-button');
    
    // Copy button functionality - copies all text inside the Revised Analyzed Text section
    copyButton.addEventListener('click', function() {
        if (revisedText.innerText) {
            navigator.clipboard.writeText(revisedText.innerText)
                .then(() => {
                    // Temporary visual feedback
                    const originalText = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fas fa-check" style="margin-right: 5px;"></i> COPIED!';
                    copyButton.style.backgroundColor = '#28a745';
                    
                    setTimeout(() => {
                        copyButton.innerHTML = originalText;
                        copyButton.style.backgroundColor = '#6c757d';
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                    alert('Failed to copy text. Please try again.');
                });
        }
    });
    
    submitButton.addEventListener('click', function() {

    // Re-initialize PDF upload area when modal opens
setTimeout(() => {
    // Make sure event handlers are attached
    const useBookCheckbox = document.getElementById('useBook');
    const usePresentationCheckbox = document.getElementById('usePresentation');
    if (useBookCheckbox && usePresentationCheckbox) {
        // Initial check in case boxes are pre-checked
        togglePdfUploadArea();
        
        // Re-attach event listeners
        useBookCheckbox.addEventListener('change', togglePdfUploadArea);
        usePresentationCheckbox.addEventListener('change', togglePdfUploadArea);
        
        console.log("PDF upload event listeners attached");
    }
}, 300); // Small delay to ensure modal is fully displayed


    // Before showing the popup, prepare the content by adding user scenario and disclosures
    const userScenario = localStorage.getItem('pendingUserScenario');
    const disclosuresContent = localStorage.getItem('pendingDisclosures');
    
    if (userScenario && disclosuresContent) {
        // Get the revised text and add the scenario and disclosures to the internal data
        // but don't update the visible text yet
        const revisedTextElement = document.getElementById("revisedText");
        const currentText = revisedTextElement.innerText.trim();
        
        // Store the current text and the full text with scenario and disclosures
        localStorage.setItem('revisedTextWithoutAppendix', currentText);
        localStorage.setItem('revisedTextWithAppendix', 
            currentText + "\n\n" + "User Scenario: " + userScenario + "\n\n" + "Disclosures: " + disclosuresContent);
    }
    
    // Show the custom submit alert modal
    const submitAlert = document.getElementById("submitAlert");
    submitAlert.style.display = "flex";
    
    // Add change event listeners to all checkboxes
    const checkboxes = document.querySelectorAll('input[name="useType"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateMessages);
    });
    
    // Initial call to show any messages for pre-checked boxes
    updateMessages();


    
// Handle Continue button
document.getElementById("submitConfirm").onclick = () => {
    // Check if PDF is required but not uploaded
    const bookletChecked = document.getElementById('useBook').checked;
    const presentationChecked = document.getElementById('usePresentation').checked;
    const pdfUploaded = document.getElementById('pdfFileInput').files.length > 0;
    
    if ((bookletChecked || presentationChecked) && !pdfUploaded) {
        alert('Please upload a PDF file of your booklet, pamphlet, or presentation before continuing.');
        return; // Stop execution if PDF is required but not uploaded
    }

    // Get the original content of the revised text before adding any appendix
    const originalContent = localStorage.getItem('revisedTextWithoutAppendix') || '';
    const fullText = localStorage.getItem('revisedTextWithAppendix') || '';
    const userScenario = localStorage.getItem('pendingUserScenario') || '';
    const disclosures = localStorage.getItem('pendingDisclosures') || '';
    
    // Get selected options
    const selectedOptions = [];
    document.querySelectorAll('input[name="useType"]:checked').forEach(checkbox => {
        selectedOptions.push(checkbox.value);
    });
    
    // Store the selected options
    localStorage.setItem('selectedUseTypes', JSON.stringify(selectedOptions));
    
    // Special handling for Social Media Post only
    const hasSocialMedia = selectedOptions.includes('Social Media Post');
    const hasSocialMediaOnly = hasSocialMedia && selectedOptions.length === 1;
    
    // Always show the revised text box without changing its content
    document.getElementById("revisedTextBox").style.display = "block";
    
    // Make sure the revised text content is visible
    document.getElementById("revisedText").style.display = "block";
    document.getElementById("actionButtons").style.display = "flex";
    
    // Clean up localStorage items
    localStorage.removeItem('pendingUserScenario');
    localStorage.removeItem('pendingDisclosures');
    localStorage.removeItem('revisedTextWithoutAppendix');
    localStorage.removeItem('revisedTextWithAppendix');

    // Make sure the Save for Later button is initially hidden
    const saveForLaterButton = document.getElementById('saveForLaterButton');
    if (saveForLaterButton) {
        saveForLaterButton.style.display = "none"; // Ensure it's hidden first
    }
    
    // Close the modal
    submitAlert.style.display = "none";
    
    // Show the instructions box after a short delay
    setTimeout(() => {
        const instructionsBox = document.getElementById("instructionsBox");
        const dynamicInstructions = document.getElementById("dynamicInstructions");
        
        // Clear previous content
        dynamicInstructions.innerHTML = '';
        
        // Build instructions based on selections
        let instructionsHTML = '<ul style="padding-left: 20px;">';
        
        // Social Media instructions
        if (hasSocialMedia) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Social Media Post</strong> 
                    ${hasSocialMediaOnly ? '<p></p>' : ''}
                </li>
            `;
        }
        
        // Booklet/Pamphlet instructions
        if (selectedOptions.includes('Book')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Booklet or Pamphlet</strong>
                </li>
            `;
        }
        
        // Presentation instructions
        if (selectedOptions.includes('Presentation')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Presentation Script or Slides</strong>
                </li>
            `;
        }
        
        // Audio instructions
        if (selectedOptions.includes('Audio')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Audio or Podcast</strong>
                </li>
            `;
        }
        
        // Video instructions
        if (selectedOptions.includes('Video')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Video</strong>
                </li>
            `;
        }
        
        // Article instructions
        if (selectedOptions.includes('Article')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Article</strong>
                </li>
            `;
        }
        
        // Graphic/Image instructions
        if (selectedOptions.includes('Graphic/Image')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Graphic or Image</strong>
                </li>
            `;
        }
        
        // Other instructions
        if (selectedOptions.includes('Other')) {
            instructionsHTML += `
                <li style="margin-bottom: 10px;">
                    <strong>Other Format</strong>
                </li>
            `;
        }
        
        instructionsHTML += '</ul>';

        // Set the dynamic instructions
        dynamicInstructions.innerHTML = instructionsHTML;

        // Add disclosure toggle buttons
        addDisclosureTogglesToReminders();
        
        // Force override any CSS !important rules by setting the style attribute directly
        instructionsBox.setAttribute('style', 'display: block !important; margin-top: 20px;');
        
        // Scroll to make it visible
        instructionsBox.scrollIntoView({ behavior: 'smooth' });
        
        // Show the Save for Later button AFTER instructions are displayed
        if (saveForLaterButton) {
            saveForLaterButton.style.display = "block";
        }
    }, 300);
};
    
    // Handle Cancel button
    document.getElementById("submitCancel").onclick = () => {
        // If canceled, revert to the text without appendix and clean up
        localStorage.removeItem('revisedTextWithAppendix');
        submitAlert.style.display = "none"; // Hide the modal
    };
});

function updateMessages() {
    // Set all message containers to be hidden regardless of checkbox state
    document.getElementById('socialMediaMessage').style.display = 'none';
    document.getElementById('bookletMessage').style.display = 'none';
    document.getElementById('presentationMessage').style.display = 'none';
    document.getElementById('audioMessage').style.display = 'none';
    document.getElementById('videoMessage').style.display = 'none';
    document.getElementById('articleMessage').style.display = 'none';
    document.getElementById('graphicMessage').style.display = 'none';
    
    // Keep the PDF upload area functionality
    togglePdfUploadArea();
}



// Handle PDF upload requirements for Booklet and Presentation
document.getElementById('useBook').addEventListener('change', togglePdfUploadArea);
document.getElementById('usePresentation').addEventListener('change', togglePdfUploadArea);

function togglePdfUploadArea() {
    // Make sure these elements exist before trying to access them
    const bookletCheckbox = document.getElementById('useBook');
    const presentationCheckbox = document.getElementById('usePresentation');
    const pdfUploadArea = document.getElementById('pdfUploadArea');
    
    if (!bookletCheckbox || !presentationCheckbox || !pdfUploadArea) {
        console.error('Required elements not found for PDF upload area toggle');
        return;
    }
    
    // Show the PDF upload area if either checkbox is checked
    if (bookletCheckbox.checked || presentationCheckbox.checked) {
        pdfUploadArea.style.display = 'block';
        console.log('PDF upload area should be visible now');
    } else {
        pdfUploadArea.style.display = 'none';
        console.log('PDF upload area should be hidden now');
    }
}

// Make sure the event listeners are attached after the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    const bookletCheckbox = document.getElementById('useBook');
    const presentationCheckbox = document.getElementById('usePresentation');
    
    if (bookletCheckbox && presentationCheckbox) {
        bookletCheckbox.addEventListener('change', togglePdfUploadArea);
        presentationCheckbox.addEventListener('change', togglePdfUploadArea);
        console.log('Event listeners attached to PDF checkboxes');
        
        // Initial check in case boxes are pre-checked
        togglePdfUploadArea();
    }
});

// Also add this to be triggered when the modal is shown
document.getElementById('submitButton').addEventListener('click', function() {
    // Small delay to ensure modal is fully displayed
    setTimeout(togglePdfUploadArea, 300);
});



// Complete function to add tabbed disclosures to the Reminders box
// Update the addDisclosureTogglesToReminders function to preserve existing disclosure content
function addDisclosureTogglesToReminders() {
    // Get all the top-level items in the reminders section
    const instructionsContent = document.getElementById('instructionsContent');
    if (!instructionsContent) return;

    // Get the assigned scenario from multiple possible sources
    let userScenario = '';
    
    // First try to get it from the disclosureScenario element in the page
    const disclosureScenarioElement = document.getElementById('disclosureScenario');
    if (disclosureScenarioElement && disclosureScenarioElement.textContent.trim()) {
        userScenario = disclosureScenarioElement.textContent.trim();
    } else {
        // If not found on page, try localStorage
        userScenario = localStorage.getItem('pendingUserScenario') || '';
    }
    
    console.log('User scenario for disclosures:', userScenario);
    
    // Get the revised text to analyze for disclosures
    const revisedTextElement = document.getElementById("revisedText");
    const revisedText = revisedTextElement ? revisedTextElement.innerText : '';
    
    // Call the API to get matching disclosures based on revised text
    fetch('/get_matching_disclosures', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ text: revisedText })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Disclosures API response:', data);
        // Format the disclosures from the API into a single paragraph
        const matchedDisclosures = data.disclosures || [];
        
        // Standard investing disclosure text
        const investingDisclosure = "Investing involves risk including loss of principal. No strategy assures success or protects against loss.";
        
        // Check if investing disclosure is present in the matched disclosures
        const hasInvestingDisclosure = matchedDisclosures.some(disclosure => 
            disclosure.includes("Investing involves risk including loss of principal"));
        
        // Filter out the investing disclosure from the matched disclosures if it exists
        const filteredDisclosures = hasInvestingDisclosure 
            ? matchedDisclosures.filter(disclosure => 
                !disclosure.includes("Investing involves risk including loss of principal"))
            : matchedDisclosures;
        
        // Join the filtered disclosures
        const disclosuresText = filteredDisclosures.join(' ');
        
        // Store the dynamically generated disclosures
        localStorage.setItem('dynamicDisclosures', disclosuresText);
        
        // Look for each category heading and add toggle buttons after them
        const reminderItems = instructionsContent.querySelectorAll('li > strong');
        
        reminderItems.forEach((item, index) => {
            const categoryName = item.textContent.replace(':', '').trim();
            // Convert category name to a valid ID
            const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
            const parentLi = item.closest('li');
            
            // Skip if we already created tabs for this item
            if (parentLi && !parentLi.querySelector('.disclosure-tabs')) {
                // Get any existing disclosure content
                const existingDisclosure = parentLi.querySelector('.disclosure-content');
                
                // Format the user scenario with a space after it if it exists
                const formattedScenario = userScenario ? `<strong>${userScenario}</strong> ` : '';
                
                // Special case for Social Media Post
                if (categoryName === 'Social Media Post') {
                    const disclosuresHTML = existingDisclosure ? 
                        existingDisclosure.innerHTML : 
                        `<p><em>Does Not Apply. Disclosures should be present in your social media profile.</em></p>`;
                    
                    createTabbedDisclosures(parentLi, categoryId, {
                        disclosuresHTML: disclosuresHTML,
                        pagesHTML: `<p><em>Not applicable for social media posts.</em></p>`,
                        note: `Your social media account profile used to post this content must contain necessary disclaimers and be approved by principal prior to posting.`
                    });
                } else if (categoryName === 'Booklet or Pamphlet' || categoryName === 'Presentation Script or Slides') {
                    // For types that need page-specific disclosures
if (categoryName === 'Booklet or Pamphlet' || categoryName === 'Presentation Script or Slides') {
    // For types that need page-specific disclosures
    const pageSpecificBox = document.getElementById('pageSpecificDisclosures');
    let pagesHTML = `<p><em>No page-specific disclosures found.</em></p>`;
    
    if (pageSpecificBox) {
        // Extract page disclosures from the pageSpecificDisclosures box
        const pageDisclosures = pageSpecificBox.querySelectorAll('.page-disclosure');
        if (pageDisclosures.length > 0) {
            // Add the title at the beginning of the Pages panel
            pagesHTML = '<h4>This information should be included on the corresponding page (typically at bottom in prominent text)</h4>';
            
            pageDisclosures.forEach(disclosure => {
                const pageTitle = disclosure.querySelector('h5').textContent;
                const pageContent = disclosure.querySelector('p').textContent;
                
                pagesHTML += `
                    <div class="page-tab-content">
                        <div class="page-number">${pageTitle}</div>
                        <p>${pageContent}</p>
                    </div>
                `;
            });
        }
    }
    
    // Use existing disclosure content if available
    const disclosuresHTML = existingDisclosure ? 
        existingDisclosure.innerHTML : 
        hasInvestingDisclosure ? 
            `<h4>This information should be present at beginning or end of content</h4><p><strong>${investingDisclosure}</strong></p><p>${formattedScenario}${disclosuresText}</p>` :
            `<h4>Required Disclosures</h4><p>${formattedScenario}${disclosuresText}</p>`;
    
    createTabbedDisclosures(parentLi, categoryId, {
        disclosuresHTML: disclosuresHTML,
        pagesHTML: pagesHTML,
        note: getCategorySpecificNote(categoryName)
    });
}
                } else {
                    // For all other content types
                    const disclosuresHTML = existingDisclosure ? 
                        existingDisclosure.innerHTML : 
                        hasInvestingDisclosure ? 
                            `<h4>This information should be present at beginning or end of content</h4><p><strong>${investingDisclosure}</strong></p><p>${formattedScenario}${disclosuresText}</p>` :
                            `<h4>Required Disclosures</h4><p>${formattedScenario}${disclosuresText}</p>`;
                    
                    createTabbedDisclosures(parentLi, categoryId, {
                        disclosuresHTML: disclosuresHTML,
                        pagesHTML: `<p><em>Not applicable for this content type.</em></p>`,
                        note: getCategorySpecificNote(categoryName)
                    });
                }
                
                // Remove any existing disclosure content from the parent li (keep only the heading)
                parentLi.querySelectorAll('.disclosure-content, .disclosure-toggle').forEach(el => el.remove());
            }
        });

        // Make sure to update any scenarios in the disclosure tabs
        updateDisclosureTogglesWithScenario();
    })
    .catch(error => {
        console.error('Error fetching matching disclosures:', error);
    });
}

function createTabbedDisclosures(parentElement, categoryId, content) {
    // First, check if this parent element already has original disclosure content we need to preserve
    let originalDisclosureContent = '';
    const existingDisclosureContent = parentElement.querySelector('.disclosure-content');
    if (existingDisclosureContent) {
        // Save the original HTML content excluding any toggle buttons
        const toggleButtons = existingDisclosureContent.querySelectorAll('.disclosure-toggle, .toggle-button');
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = existingDisclosureContent.innerHTML;
        toggleButtons.forEach(button => {
            const buttonClone = tempDiv.querySelector(`#${button.id}`);
            if (buttonClone) buttonClone.remove();
        });
        originalDisclosureContent = tempDiv.innerHTML;
    }

    // Add the note as a subtitle right after the category title
    const categoryTitle = parentElement.querySelector('strong');
    if (categoryTitle) {
        const subtitle = document.createElement('div');
        subtitle.className = 'category-subtitle';
        subtitle.textContent = content.note;
        subtitle.style.fontSize = '0.9em'; // Slightly larger font
        subtitle.style.color = '#6c757d';
        subtitle.style.fontStyle = 'italic';
        subtitle.style.marginTop = '5px';
        subtitle.style.marginBottom = '12px'; // More margin for spacing
        subtitle.style.lineHeight = '1.4'; // Better readability
        
        // Insert after the title but before any other content
        categoryTitle.insertAdjacentElement('afterend', subtitle);
    }

    // Create container for the tabs
    const tabsContainer = document.createElement('div');
    tabsContainer.className = 'disclosure-tabs';
    
    // Create Required Disclosures tab - not active by default
    const disclosuresTab = document.createElement('div');
    disclosuresTab.className = 'disclosure-tab';
    disclosuresTab.textContent = 'Main Disclosure';
    disclosuresTab.dataset.target = `${categoryId}-disclosures-panel`;
    disclosuresTab.dataset.category = categoryId;
    disclosuresTab.dataset.type = 'disclosures';
    disclosuresTab.addEventListener('click', function() { 
        switchTab(categoryId, 'disclosures'); 
    });
    
    // Create Pages tab
    const pagesTab = document.createElement('div');
    pagesTab.className = 'disclosure-tab';
    pagesTab.textContent = 'Page Specific';
    pagesTab.dataset.target = `${categoryId}-pages-panel`;
    pagesTab.dataset.category = categoryId;
    pagesTab.dataset.type = 'pages';
    pagesTab.addEventListener('click', function() { 
        switchTab(categoryId, 'pages'); 
    });
    
    // Add tabs to container
    tabsContainer.appendChild(disclosuresTab);
    tabsContainer.appendChild(pagesTab);
    
    // Create the Required Disclosures panel - hidden by default
    const disclosuresPanel = document.createElement('div');
    disclosuresPanel.id = `${categoryId}-disclosures-panel`;
    disclosuresPanel.className = 'disclosure-panel';
    disclosuresPanel.style.display = 'none';
    
    // Use existing content if available, otherwise use the new content
    if (originalDisclosureContent && originalDisclosureContent.trim() !== '') {
        // If we have "Required Disclosures" as a heading in the original content, keep everything after it
        if (originalDisclosureContent.includes('<h4>Required Disclosures</h4>')) {
            const parts = originalDisclosureContent.split('<h4>Required Disclosures</h4>');
            disclosuresPanel.innerHTML = '<h4>Required Disclosures</h4>' + parts[1].split('<h4>')[0];
        } else {
            // Otherwise use the full original content
            disclosuresPanel.innerHTML = originalDisclosureContent;
        }
    } else {
        // Use the new content if no original content exists
        disclosuresPanel.innerHTML = content.disclosuresHTML;
    }
    
    // Create the Pages panel - also hidden by default
    const pagesPanel = document.createElement('div');
    pagesPanel.id = `${categoryId}-pages-panel`;
    pagesPanel.className = 'disclosure-panel';
    pagesPanel.style.display = 'none';

    // Check if this is a one-page file
    const pageSpecificBox = document.getElementById('pageSpecificDisclosures');
    const pageDisclosures = pageSpecificBox ? pageSpecificBox.querySelectorAll('.page-disclosure') : [];

    // First check if this is a content type that doesn't use page-specific disclosures
if (categoryId === 'social-media-post' || 
    categoryId === 'audio-or-podcast' || 
    categoryId === 'video' || 
    categoryId === 'article' || 
    categoryId === 'other-format') {
    // For content types that don't use page-specific disclosures
    pagesPanel.innerHTML = `<p><em>Page Specific Disclosures Do Not Apply For This Content Type</em></p>`;
} else if (pageDisclosures.length <= 1) {
    // For one-page files, just show "See Main Disclosure Tab" instead of the regular content
    pagesPanel.innerHTML = `<p><em>See Main Disclosure Tab</em></p>`;
} else {
    // For multi-page files, show the full disclosures
    pagesPanel.innerHTML = content.pagesHTML;
}
    
    // Add everything to the parent element (WITHOUT the notes section)
    parentElement.appendChild(tabsContainer);
    parentElement.appendChild(disclosuresPanel);
    parentElement.appendChild(pagesPanel);
}

// Function to switch between tabs
function switchTab(categoryId, tabType) {
    // Get all tabs and panels within this category
    const categoryTabs = document.querySelectorAll(`[data-category="${categoryId}"]`);
    const panels = document.querySelectorAll(`#${categoryId}-disclosures-panel, #${categoryId}-pages-panel`);
    
    // Get the selected tab and panel
    const selectedTab = document.querySelector(`[data-category="${categoryId}"][data-type="${tabType}"]`);
    const selectedPanel = document.getElementById(`${categoryId}-${tabType}-panel`);
    
    // Check if this panel is already visible
    const isPanelVisible = selectedPanel && selectedPanel.style.display === 'block';
    
    // If the selected tab is already active and panel is visible, collapse it
    if (selectedTab && selectedTab.classList.contains('active') && isPanelVisible) {
        // Collapse: remove active class and hide panel
        selectedTab.classList.remove('active');
        selectedPanel.classList.remove('active');
        selectedPanel.style.display = 'none';
        return;
    }
    
    // Otherwise, expand the selected tab and collapse others
    
    // Remove active class from all tabs and hide all panels
    categoryTabs.forEach(tab => tab.classList.remove('active'));
    panels.forEach(panel => {
        panel.classList.remove('active');
        panel.style.display = 'none';
    });
    
    // Add active class to selected tab and show the selected panel
    if (selectedTab) selectedTab.classList.add('active');
    if (selectedPanel) {
        selectedPanel.classList.add('active');
        selectedPanel.style.display = 'block';
    }
}

// Helper function to get category-specific notes
function getCategorySpecificNote(categoryName) {
    switch(categoryName) {
        case 'Booklet or Pamphlet':
            return 'Multi-page documents should contain disclosures on the corresponding page as indicated, along with other disclosures that appear in your Revised Analyzed Text.';
        case 'Presentation Script or Slides':
            return 'Speaker\'s notes may be required in addition to slides if there is not sufficient information on the slides. Slides should contain disclosures on the corresponding page as indicated. Disclosures on slides should be large enough to be seen from all points in the room.';
        case 'Audio or Podcast':
            return 'Content that is audio only should have disclosures said aloud at beginning or end of content. Disclosures must be articulated clearly and at a pace that can be easily understood by listeners.';
        case 'Video':
            return 'Disclosures should be presented clearly on screen, appear long enough to be read by viewers, and should be placed within the context of the content itself or at the end of the video. Consideration should be given to size of text used to display disclosure(s).';
        case 'Article':
            return 'For articles, disclosures text should not vary from size of text used in article and they should be placed within the context of the content itself or at the bottom of the page.';
        case 'Graphic or Image':
            return 'Graphics and images should include a source (if applicable) and relevant disclosure. Graphics should also include a simplified description.';
        case 'Other Format':
            return 'Ensure all disclosures from your Revised Analyzed Text are incorporated appropriately based on the medium you\'re using.';
        default:
            return '';
    }
}

// Function to toggle disclosure visibility
function toggleDisclosures(categoryId, event) {
    const disclosureElement = document.getElementById(`${categoryId}-disclosures`);
    const button = event.currentTarget;
    
    if (disclosureElement.style.display === 'none') {
        // Hide any other open disclosures
        document.querySelectorAll('.disclosure-content').forEach(elem => {
            if (elem.id !== `${categoryId}-disclosures`) {
                elem.style.display = 'none';
            }
        });
        
        // Update all other buttons to "Show"
        document.querySelectorAll('.disclosure-toggle').forEach(btn => {
            if (btn !== button) {
                btn.textContent = "Show disclosures for this content type";
            }
        });
        
        // Show this disclosure and update button
        disclosureElement.style.display = 'block';
        button.textContent = "Hide disclosures";
        
        // If this is book or presentation, update page-specific disclosures
        if (categoryId === 'booklet-or-pamphlet' || categoryId === 'presentation-script-or-slides') {
            const pageDisclosuresSection = document.getElementById(`${categoryId}-page-disclosures`);
            if (pageDisclosuresSection) {
                // Get the latest page-specific disclosures
                const pageSpecificBox = document.getElementById('pageSpecificDisclosures');
                
                if (pageSpecificBox) {
                    // Update with the latest content from pageSpecificDisclosures box
                    pageDisclosuresSection.innerHTML = `
                        <h4>Pages</h4>
                        ${pageSpecificBox.innerHTML.replace('<h2>PAGE SPECIFIC DISCLOSURES</h2>', '')}
                    `;
                }
            }
        }
    } else {
        // Hide this disclosure and update button
        disclosureElement.style.display = 'none';
        button.textContent = "Show disclosures for this content type";
    }
}

// Function to update all Pages sections in the reminders
function updatePagesInReminders() {
    const pageSpecificBox = document.getElementById('pageSpecificDisclosures');
    if (!pageSpecificBox) return;
    
    // Find all page disclosures sections in the reminders
    const pageDisclosuresSections = document.querySelectorAll('[id$="-page-disclosures"]');
    
    pageDisclosuresSections.forEach(section => {
        section.innerHTML = `
            <h4>Pages</h4>
            ${pageSpecificBox.innerHTML.replace('<h2>PAGE SPECIFIC DISCLOSURES</h2>', '')}
        `;
    });
}

    // Replace the existing Exit Without Saving button's event listener with this:
exitButton.addEventListener('click', function() {
    // Show the custom exit alert modal
    const exitAlert = document.getElementById("exitAlert");
    exitAlert.style.display = "flex";
    
    // Handle Confirm button
    document.getElementById("exitConfirm").onclick = () => {
        window.location.href = '/'; // Go back to the home/upload page
    };
    
    // Handle Cancel button
    document.getElementById("exitCancel").onclick = () => {
        exitAlert.style.display = "none"; // Just hide the modal
    };
});
});

// Hide revised text box initially
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById("revisedTextBox").style.display = "none";
});

// Enhance the goBackToPreviousStep function
function goBackToPreviousStep() {
    // Reset the next button clicked flag
    nextButtonClicked = false;
    
    // Clear stored alternatives
    originalSelectedAlternatives = {};
    
    // Reset the selected count to zero
    selectedCount = 0;

    // Hide the revised text box and buttons
    document.getElementById("revisedTextBox").style.display = "none";
    document.getElementById("generateDisclosuresBtn").style.display = "none";
    document.getElementById("goBackBtn").style.display = "none";
    
    // Show all compliance items and hide all selected alternatives
    for (let i = 1; i <= totalItems; i++) {
        const itemContent = document.getElementById(`content${i}`);
        const itemSelected = document.getElementById(`selectedAlternative${i}`);
        
        if (itemContent) itemContent.style.display = 'block';
        if (itemSelected) itemSelected.style.display = 'none';
    }
    
    // Remove any highlighting and overlays
    const dimOverlay = document.querySelector(".dim-overlay");
    const arrowIndicator = document.getElementById("arrowIndicator");
    
    if (dimOverlay) dimOverlay.style.display = "none";
    if (arrowIndicator) arrowIndicator.style.display = "none";
    
    // Ensure the Compliance Analysis box is visible
    const complianceAnalysis = document.querySelector(".compliance-analysis");
    if (complianceAnalysis) complianceAnalysis.style.display = "block";
    
    const toggleComplianceButton = document.getElementById("toggleComplianceTextButton");
    if (toggleComplianceButton) toggleComplianceButton.textContent = "Hide Compliance Details";
}

async function handleRecycleButtonClick(flaggedInstance) {
    const response = await fetch('/generate_new_alternative', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ flagged_instance: flaggedInstance }),
    });

    const result = await response.json();

    if (response.ok && result.new_alternative) {
        // Update the UI with the new alternative
        document.getElementById(`alternative-${flaggedInstance}`).textContent = result.new_alternative;
        alert("New alternative generated successfully!");
    } else {
        alert(result.feedback || "Failed to generate a new alternative.");
    }
}


document.querySelectorAll('.full-sentence').forEach(element => {
    element.style.display = 'none';
});

    function archiveText() {
    const revisedText = document.getElementById("revisedText").innerText;
    const fileLink = document.querySelector("#uploadBox a")?.href || "#";
    const disclosures = Array.from(document.querySelectorAll("#newDisclosuresSection li")).map(li => li.innerText);

    const userEmail = localStorage.getItem('loggedInUser') || "anonymous"; // Fallback to anonymous
    if (!localStorage.getItem('loggedInUser')) {
        console.warn("User email not found. Archiving as anonymous.");
    }

    const selectedChannels = JSON.parse(localStorage.getItem('selectedChannels')) || [];
    const selectedMethods = JSON.parse(localStorage.getItem('selectedMethods')) || [];

    const payload = {
        text: revisedText,
        link: fileLink,
        disclosures: disclosures,
        distribution_channel: selectedChannels,
        distribution_method: selectedMethods,
        user_email: userEmail
    };

    console.log("Archiving Payload:", payload);

    fetch('/save_archived_text', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
        .then(response => {
            if (response.ok) {
                window.location.href = "/archived";
            } else {
                alert("Failed to archive revised text.");
            }
        })
        .catch(error => console.error("Error archiving text:", error));
}

        let selectedCount = 0;
        const totalItems = {{ finra_analysis|length }};
        const originalText = `{{ text }}`;
        let revisedText = originalText;
        console.log("Original Text:", originalText);
        console.log("Revised Text Initialized:", revisedText);


        function toggleContent(itemId) {
    const content = document.getElementById(`content${itemId}`);
    const toggleButton = document.getElementById(`toggleButton${itemId}`);

    // Toggle visibility of the content
    const isCurrentlyVisible = content.style.display === 'block';
    content.style.display = isCurrentlyVisible ? 'none' : 'block';

    // Update the button text
    toggleButton.textContent = isCurrentlyVisible ? 'Expand' : 'Collapse';
}

        // Recycle alternative function to fetch a new compliant alternative
        async function recycleAlternative(itemId, retryDelay = 2000) {
    const flaggedTextElement = document.getElementById(`flaggedInstance${itemId}`);
    const alternativeDisplay = document.getElementById(`compliantAlternative${itemId}`);
    const loadingBar = document.getElementById(`recycleLoadingBar${itemId}`);
    const loadingProgress = document.getElementById(`recycleLoadingProgress${itemId}`);

    if (!flaggedTextElement) {
        console.error(`Flagged instance element not found for item ${itemId}`);
        return;
    }

    const flaggedText = flaggedTextElement.textContent.trim();

    // Show loading bar and start progress animation
    loadingBar.style.display = 'block';
    loadingProgress.style.width = '0%';
    loadingProgress.animate([{ width: '0%' }, { width: '100%' }], {
        duration: retryDelay,
        fill: 'forwards',
    });

    try {
        const response = await fetch('/generate_new_alternative', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ flagged_instance: flaggedText }),
        });

        if (!response.ok) {
            throw new Error(`Server responded with status ${response.status}`);
        }

        const data = await response.json();

        // Clean the returned alternative
        const cleanedAlternative = data.new_alternative
    ? data.new_alternative.replace(
        /(Alternative Statement:|Alternative:|Alternative Instance:|Specific Compliant Alternative:|Compliant Alternative:|Revised:|Alternative instance)\s*/g, // Global flag to replace all occurrences
        ''
    ).replace(/^["']|["']$/g, '').trim() // Remove leading/trailing quotes
    : '';

        // Check if the alternative is valid
        if (cleanedAlternative) {
            alternativeDisplay.textContent = cleanedAlternative;
        } else {
            console.warn('Invalid alternative received. Retrying...');
            setTimeout(() => recycleAlternative(itemId, retryDelay), retryDelay); // Retry with delay
        }
    } catch (error) {
        console.warn('Error occurred. Retrying...', error);
        setTimeout(() => recycleAlternative(itemId, retryDelay), retryDelay); // Retry on error with delay
    } finally {
        // Hide loading bar only when a valid alternative is displayed
        if (alternativeDisplay.textContent) {
            loadingBar.style.display = 'none';
        }
    }
}

        async function testCustomAlternative(itemId) {
    const customText = document.getElementById('customAlt' + itemId).value;
    const feedbackBox = document.getElementById('feedbackBox' + itemId);
    const feedbackLine = document.getElementById('feedback' + itemId);
    const customSelectButton = document.getElementById('customSelect' + itemId);
    const loadingBar = document.getElementById(`loadingBar${itemId}`);
    const loadingProgress = document.getElementById(`loadingProgress${itemId}`);

    // Reset feedback
    feedbackBox.className = 'feedback-box';
    feedbackBox.style.display = 'none';
    feedbackLine.style.display = 'none';

    if (customText) {
        try {
            // Show loading
            loadingBar.style.display = 'block';
            loadingProgress.style.width = '0%';
            loadingProgress.animate([{ width: '0%' }, { width: '100%' }], {
                duration: 2000,
                fill: 'forwards',
            });

            const response = await fetch('/check_custom_alternative', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ custom_text: customText }),
            });

            if (response.ok) {
                const data = await response.json();
                console.log("Compliance Response:", data); // Debugging
                if (data.compliant) {
                    // Show compliant feedback
                    feedbackBox.classList.add('green');
                    feedbackBox.textContent = "No Issues Identified";
                    feedbackBox.style.display = 'block';
                    feedbackLine.textContent = data.message;
                    feedbackLine.style.display = 'block';
                    customSelectButton.disabled = false;
                } else if (Array.isArray(data.flagged_instances) && data.flagged_instances.length > 0) {
                    // Show non-compliant feedback
                    feedbackBox.classList.add('red');
                    feedbackBox.textContent = "Issues Identified";
                    feedbackBox.style.display = 'block';
                    let rationales = "";
                    data.flagged_instances.forEach((instance) => {
                        rationales += `${instance.rationale}\n`;
                    });
                    feedbackLine.textContent = rationales;
                    feedbackLine.style.display = 'block';
                    customSelectButton.disabled = true;
                } else {
                    // Unexpected response structure
                    feedbackBox.classList.add('red');
                    feedbackBox.textContent = "An error occurred while checking compliance.";
                    feedbackBox.style.display = 'block';
                    feedbackLine.textContent = 'Unexpected response structure.';
                    feedbackLine.style.display = 'block';
                    customSelectButton.disabled = true;
                }
            } else {
                throw new Error('Failed to fetch feedback');
            }
        } catch (error) {
            console.error('Error testing custom alternative:', error);
            feedbackLine.textContent = 'An error occurred while checking compliance.';
            feedbackLine.style.display = 'block';
        } finally {
            // Hide loading
            loadingBar.style.display = 'none';
        }
    } else {
        feedbackLine.textContent = 'Please enter a custom alternative to test.';
        feedbackLine.style.display = 'block';
    }
}


// Modify the selectAlternative function
function selectAlternative(itemId, type) {
    console.log(`selectAlternative called with itemId: ${itemId}, type: ${type}`);
    
    // Get the selected alternative
    const selected = type === 'compliant'
        ? document.getElementById(`compliantAlternative${itemId}`).textContent
        : document.getElementById(`customAlt${itemId}`).value;
    
    // Update the selected alternative display
    document.getElementById(`selectedText${itemId}`).textContent = selected;
    document.getElementById(`selectedAlternative${itemId}`).style.display = 'block';
    document.getElementById(`content${itemId}`).style.display = 'none';
    
    // Store the selected alternative in localStorage regardless of the button state
    const selectedAlternatives = JSON.parse(localStorage.getItem('selectedAlternatives') || '{}');
    selectedAlternatives[itemId] = selected;
    localStorage.setItem('selectedAlternatives', JSON.stringify(selectedAlternatives));
    
    // Check if Next button was already clicked
    if (nextButtonClicked) {
        // Reset the Next button clicked flag
        nextButtonClicked = false;
        
        // Alert the user
        alert("You've changed a previously selected alternative. Please review all selections before continuing.");
        
        // Rebuild the revised text with ALL current selections
        rebuildRevisedText();
        
        // Hide the Revised Text box
        document.getElementById("revisedTextBox").style.display = "none";
        
        // Hide any reminders/instructions box that might be showing
        const instructionsBox = document.getElementById("instructionsBox");
        if (instructionsBox) {
            instructionsBox.style.display = "none";
        }
        
        // Show the Compliance Analysis section
        const complianceAnalysisContent = document.querySelector(".compliance-analysis");
        if (complianceAnalysisContent) {
            complianceAnalysisContent.style.display = "block";
        }
        
        // Update the toggle button text
        const toggleComplianceButton = document.getElementById("toggleComplianceTextButton");
        if (toggleComplianceButton) {
            toggleComplianceButton.textContent = "Hide Compliance Details";
        }
        
        // Show the Next and Go Back buttons
        document.getElementById("generateDisclosuresBtn").style.display = "block";
        document.getElementById("goBackBtn").style.display = "block";
        
        // Return early to skip the normal increment and check
        return;
    }
    
    // If we're here, Next wasn't clicked, so process normally
    // Process the flagged instance and update revised text
    const flaggedInstanceElement = document.querySelector(`#flaggedInstance${itemId} > div[style="white-space: pre-wrap;"]`);
    const flaggedInstance = flaggedInstanceElement 
        ? flaggedInstanceElement.textContent.replace("Flagged Instance:", "").trim()
        : "";
    const cleanedFlaggedInstance = flaggedInstance.replace(/\s+/g, ' ').trim();
    const cleanedRevisedText = revisedText.replace(/\s+/g, ' ').trim();
    
    // Replace the flagged instance in revisedText with the selected alternative
    const regex = new RegExp(cleanedFlaggedInstance, 'g');
    revisedText = cleanedRevisedText.replace(regex, selected);
    
    // Update the Revised Analyzed Text in the DOM
    document.getElementById("revisedText").innerText = revisedText;
    
    // Increment selected count
    selectedCount++;
    checkAllSelected();
}

        function goBack(itemId) {
            const header = document.getElementById(`header${itemId}`);
            const content = document.getElementById(`content${itemId}`);
            const selectedAlternative = document.getElementById(`selectedAlternative${itemId}`);
            header.textContent = `Flagged Instance ${itemId}`;
            content.style.display = 'block';
            selectedAlternative.style.display = 'none';
            selectedCount--;
            checkAllSelected();
        }

        // Make sure checkAllSelected properly shows buttons when all items are selected
function checkAllSelected() {
    console.log(`checkAllSelected called. selectedCount: ${selectedCount}, totalItems: ${totalItems}`);
    
    const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
    const goBackBtn = document.getElementById("goBackBtn");
    
    // Show the Next and Go Back buttons when all items have been addressed
    if (selectedCount >= totalItems) {
        console.log("All items selected, showing buttons");
        generateDisclosuresBtn.style.display = "block";
        goBackBtn.style.display = "block";
    } else {
        console.log("Not all items selected, hiding buttons");
        generateDisclosuresBtn.style.display = "none";
        goBackBtn.style.display = "none";
    }
}

function generateDisclosures() {
    // Set the flag that the Next button has been clicked
    nextButtonClicked = true;
    
    // Rebuild the revised text to ensure it includes all current selections
    rebuildRevisedText();
    
    const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
    const goBackBtn = document.getElementById("goBackBtn");
    const preloader = document.getElementById("preloader");
    const revisedTextBox = document.getElementById("revisedTextBox");
    const revisedTextContent = document.getElementById("revisedText");
    const actionButtons = document.getElementById("actionButtons");
    const toggleRevisedTextButton = document.getElementById("toggleRevisedTextButton");
    
    // Hide both the Finalize button and Go Back button
    generateDisclosuresBtn.style.display = "none";
    goBackBtn.style.display = "none";
    
    // Show the Revised Analyzed Text section when Generate Disclosures is clicked
    revisedTextBox.style.display = "block";
    
    // Make sure the content inside is also visible
    revisedTextContent.style.display = "block";
    actionButtons.style.display = "flex";
    
    // Update the toggle button text to match the state
    toggleRevisedTextButton.textContent = "Hide Revised Text";
    
    // Minimize the Compliance Analysis section
    const complianceAnalysisContent = document.querySelector(".compliance-analysis");
    const toggleComplianceButton = document.getElementById("toggleComplianceTextButton");
    
    if (complianceAnalysisContent.style.display !== "none") {
        complianceAnalysisContent.style.display = "none";
        toggleComplianceButton.textContent = "Show Compliance Details";
    }

    // Show the preloader
    preloader.style.display = "block";

    // Retrieve the logged-in user from localStorage
    const loggedInUser = localStorage.getItem("loggedInUser") || "Unknown";

    // Get the most up-to-date revised text (which includes the latest selected alternatives)
    const currentText = revisedTextContent.innerText;
    
    // Remove any existing user scenario and disclosures to get clean text
    const cleanedText = currentText.replace(/User Scenario:[\s\S]*?(?=\n\n|$)/g, '')
                                  .replace(/Disclosures:[\s\S]*?(?=$)/g, '')
                                  .trim();
    
    // Update the revised text to show only the cleaned content
    revisedTextContent.innerText = cleanedText;

    // Call the API to get matching disclosures based on the latest cleaned text
    fetch("/get_matching_disclosures", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ text: cleanedText })
    })
    .then(response => response.json())
    .then(matchingData => {
        console.log("Matching disclosures response:", matchingData);
        
        // Get the matched disclosures from the API response
        const matchedDisclosures = matchingData.disclosures || [];
        
        // Format the disclosures
        let disclosuresContent = matchedDisclosures.join(" ");
        
        // Now fetch the user's assigned scenario
        return fetch("/get_user_scenario")
            .then(response => response.json())
            .then(scenarioData => {
                console.log("User scenario response:", scenarioData);
                
                // Get the user scenario text if available
                let userScenario = "";
                if (scenarioData.success && scenarioData.hasScenario) {
                    userScenario = scenarioData.scenarioText || "";
                }
                
                // Now fetch any other data from the original endpoint
                return fetch("/generate_disclosures", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Logged-In-User": loggedInUser,
                    },
                    body: JSON.stringify({ text: cleanedText }),
                })
                .then((response) => response.json())
                .then((data) => {
                    // Get any additional system-generated scenario if there's no user-assigned one
                    if (!userScenario && data.assigned_scenario) {
                        userScenario = data.assigned_scenario;
                    }
                    
                    // Store the scenario and the matched disclosures in localStorage
                    localStorage.setItem('pendingUserScenario', userScenario);
                    localStorage.setItem('pendingDisclosures', disclosuresContent);
                    
                    // Update the display of the assigned scenario if it exists
                    const assignedScenarioContainer = document.getElementById("assignedScenarioContainer");
                    const assignedScenarioText = document.getElementById("assignedScenarioText");
                    if (assignedScenarioText) {
                        assignedScenarioText.textContent = userScenario;
                    }
                    if (assignedScenarioContainer && userScenario) {
                        assignedScenarioContainer.style.display = "block";
                    } else if (assignedScenarioContainer) {
                        assignedScenarioContainer.style.display = "none";
                    }
                    
                    // Clear previous instructions content before updating
                    const dynamicInstructions = document.getElementById("dynamicInstructions");
                    if (dynamicInstructions) {
                        dynamicInstructions.innerHTML = '';
                        
                        // Add the scenario if available
                        if (userScenario) {
                            const scenarioDiv = document.createElement('div');
                            scenarioDiv.className = 'user-scenario';
                            scenarioDiv.innerHTML = `<strong>Your Scenario:</strong> ${userScenario}`;
                            dynamicInstructions.appendChild(scenarioDiv);
                        }
                    }
                    
                    // Show the instructionsBox with reminders
                    const instructionsBox = document.getElementById("instructionsBox");
                    if (instructionsBox) {
                        instructionsBox.style.display = "block";
                    }
                    
                    // Regenerate disclosure toggles with the updated content
                    addDisclosureTogglesToReminders();
                    
                    // Update the user scenario in the disclosures
                    updateDisclosureTogglesWithScenario();
                    
                    // Return the combined data for further processing if needed
                    return {
                        userScenario,
                        disclosuresContent
                    };
                });
            });
    })
    .catch((error) => {
    console.error("Error fetching disclosures:", error);
    
    // COMMENT OUT THE ALERT - this is what's causing the issue
    // alert("An error occurred while generating disclosures. Please try again.");
    
    // Simply log the error instead of showing an alert
    console.warn("Suppressing error alert:", error.message);
    
    // Fallback to default disclosures in case of error
    return {
        userScenario: "",
        disclosuresContent: "Investing involves risk including loss of principal. No strategy assures success or protects against loss."
    };
})
    .finally(() => {
        // Hide preloader when done, regardless of success or failure
        preloader.style.display = "none";
    });
}

         // Add this code within your existing displayNewDisclosures function on the results page

function displayNewDisclosures(newDisclosures) {
    const newDisclosuresSection = document.getElementById("newDisclosuresSection");
    newDisclosuresSection.innerHTML = ''; // Clear previous content

    // Deduplicate disclosures
    const uniqueDisclosures = [...new Set(newDisclosures)];

    uniqueDisclosures.forEach(disclosure => {
        const li = document.createElement('li');
        li.innerHTML = `<span style='font-weight:bold;'>${disclosure}</span><br><span style='line-height:12pt;'>&nbsp;</span>`;
        newDisclosuresSection.appendChild(li);
    });

    newDisclosures.forEach((disclosure) => {
        const li = document.createElement("li");

        // Use innerHTML instead of textContent to render HTML styling correctly
        if (disclosure.includes("Investing involves risk including loss of principal.")) {
            li.innerHTML = `<span style='font-weight:bold;'>${disclosure}</span><br><span style='line-height:12pt;'>&nbsp;</span>`;
        } else {
            li.innerHTML = disclosure;
        }

        newDisclosuresSection.appendChild(li);
    });

    // Check if Video Format was selected and add confirmation line with link if true
    if (localStorage.getItem('videoFormatSelected') === 'true') {
        const confirmationLine = document.createElement("p");
        confirmationLine.innerHTML = `<strong><em>Confirm disclosures are written and placed at end of video</em></strong>`;

        // Create the checkbox
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginLeft = "10px";
        confirmationLine.appendChild(checkbox);

        // Create the "See examples" link
        const exampleLink = document.createElement("a");
        exampleLink.href = "your-link-url-here"; // Replace with the actual URL
        exampleLink.innerText = "See examples";
        exampleLink.style.marginLeft = "10px";
        exampleLink.style.textDecoration = "underline";

        confirmationLine.appendChild(exampleLink);
        newDisclosuresSection.appendChild(confirmationLine);
    }
    // Add confirmation line for Audio Format selection
    if (localStorage.getItem('audioFormatSelected') === 'true') {
        const confirmationLine = document.createElement("p");
        confirmationLine.innerHTML = `<strong><em>Confirm disclosures are spoken and placed at end of audio</em></strong>`;
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginLeft = "10px";
        
        confirmationLine.appendChild(checkbox);
        newDisclosuresSection.appendChild(confirmationLine);
    }
    // Add confirmation line for Graphic Image selection
    if (localStorage.getItem('graphicImageSelected') === 'true') {
        const confirmationLine = document.createElement("p");
        confirmationLine.innerHTML = `<strong><em>Confirm disclosures are written and included in graphic</em></strong>`;
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginLeft = "10px";
        
        confirmationLine.appendChild(checkbox);
        newDisclosuresSection.appendChild(confirmationLine);
    }
    // Add confirmation line for Article selection
    if (localStorage.getItem('articleFormatSelected') === 'true') {
        const confirmationLine = document.createElement("p");
        confirmationLine.innerHTML = `<strong><em>Confirm disclosures are written at the end of the publication</em></strong>`;
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginLeft = "10px";
        
        confirmationLine.appendChild(checkbox);
        newDisclosuresSection.appendChild(confirmationLine);
    }
    // Add confirmation line for Brochure/Flyer selection
    if (localStorage.getItem('brochureFormatSelected') === 'true') {
        const confirmationLine = document.createElement("p");
        confirmationLine.innerHTML = `<strong><em>Confirm disclosures are written at the bottom of each page as indicated of the brochure, flyer, or similar publication</em></strong>`;
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginLeft = "10px";
        
        confirmationLine.appendChild(checkbox);
        newDisclosuresSection.appendChild(confirmationLine);
    }
    // Add confirmation line for Book or Booklet selection
    if (localStorage.getItem('bookFormatSelected') === 'true') {
        const confirmationLine = document.createElement("p");
        confirmationLine.innerHTML = `<strong><em>Confirm disclosures are written at the bottom of each page as indicated</em></strong>`;
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.style.marginLeft = "10px";
        
        confirmationLine.appendChild(checkbox);
        newDisclosuresSection.appendChild(confirmationLine);
    }
}



    function toggleComplianceLink() {
    var method = document.getElementById("distribution-method").value;
    document.getElementById("compliance-link").style.display = method === "social_media" ? "block" : "none";
}

document.getElementById("toggleAnalyzedTextButton").addEventListener("click", function () {
        const analyzedTextContent = document.getElementById("analyzedTextContent");
        if (analyzedTextContent.style.display === "none") {
            analyzedTextContent.style.display = "block";
            this.textContent = "Hide Analyzed Text";
        } else {
            analyzedTextContent.style.display = "none";
            this.textContent = "Show Analyzed Text";
        }
    });
window.onload = function () {
    // Initially hide the revised text box
    document.getElementById("revisedTextBox").style.display = "none";
    
    // ELEMENT 1: Highlight specific sections with overlay
    const overlay = document.getElementById("pageOverlay");
    const analyzedTextBox = document.getElementById("analyzedTextBox");
    const complianceBox = document.getElementById("finraComplianceBox");
    const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
    const arrowIndicator = document.getElementById("arrowIndicator");

    // Create a dim overlay for dimming effect
    const dimOverlay = document.createElement("div");
    dimOverlay.classList.add("dim-overlay");
    document.body.appendChild(dimOverlay); // Append to body but keep hidden by default

    // Show overlay and highlight specific sections initially
    overlay.style.display = "block";
    analyzedTextBox.classList.add("highlight");
    complianceBox.classList.add("highlight");

    // ELEMENT 2: Show or hide the compliance link
    if (localStorage.getItem('showComplianceLink') === 'true') {
        document.querySelector('.compliance-link').style.display = 'block';
    } else {
        document.querySelector('.compliance-link').style.display = 'none';
    }

    // Track the number of compliant alternatives selected
    let selectedCount = 0;
    const totalItems = document.querySelectorAll('.compliance-item').length; // Total compliance items

    // Function to position the arrow next to the Generate Disclosures button
    const positionArrow = () => {
        const btnRect = generateDisclosuresBtn.getBoundingClientRect();
        const arrowHeight = arrowIndicator.offsetHeight;

        // Calculate vertical center and align tip of arrow to middle of button
        const verticalCenter = btnRect.top + window.scrollY + (btnRect.height / 2) - (arrowHeight / 2);
        const rightPosition = btnRect.right + window.scrollX + 10;

        // Set arrow position
        arrowIndicator.style.top = `${verticalCenter}px`;
        arrowIndicator.style.left = `${rightPosition}px`;
    };

    // Function to check if all items are selected
    const checkAllSelected = () => {
        if (selectedCount === totalItems) {
            // Remove initial overlay and highlights
            overlay.style.display = "none";
            analyzedTextBox.classList.remove("highlight");
            complianceBox.classList.remove("highlight");

            // Dim the rest of the page and highlight the button and arrow
            dimOverlay.style.display = "block"; // Show dim overlay
            generateDisclosuresBtn.classList.add("highlighted"); // Highlight the button
            arrowIndicator.classList.add("highlighted"); // Highlight the arrow

            // Position and display the arrow
            arrowIndicator.style.display = "block";
            positionArrow();
        }
    };

    // Add event listeners to compliance selection buttons
    const complianceButtons = document.querySelectorAll('.select-button');
    complianceButtons.forEach((button) => {
        button.addEventListener('click', () => {
            selectedCount++;
            checkAllSelected();
        });
    });

    // Hide arrow and dim overlay when Generate Disclosures button is clicked
    generateDisclosuresBtn.addEventListener('click', () => {
        arrowIndicator.style.display = "none";
        dimOverlay.style.display = "none";
        generateDisclosuresBtn.classList.remove("highlighted");
        arrowIndicator.classList.remove("highlighted");
    });

    // Ensure arrow positions correctly if the window is resized
    window.addEventListener('resize', positionArrow);
};

document.getElementById("toggleRevisedTextButton").addEventListener("click", function () {
    const revisedTextContent = document.getElementById("revisedText");
    const actionButtons = document.getElementById("actionButtons");

    if (revisedTextContent.style.display === "none") {
        // Show the text and buttons
        revisedTextContent.style.display = "block";
        actionButtons.style.display = "flex";
        this.textContent = "Hide Revised Text";
    } else {
        // Hide the text and buttons
        revisedTextContent.style.display = "none";
        actionButtons.style.display = "none";
        this.textContent = "Show Revised Text";
    }
});

let complianceDetailsShown = false; // Flag to track if compliance details were shown

document.getElementById("toggleComplianceTextButton").addEventListener("click", function () {
    const complianceAnalysisContent = document.querySelector(".compliance-analysis");
    const analyzedTextButton = document.getElementById("toggleAnalyzedTextButton");

    if (complianceAnalysisContent.style.display === "none" || !complianceAnalysisContent.style.display) {
        complianceAnalysisContent.style.display = "block";
        this.textContent = "Hide Compliance Details";

        // Reset all toggle buttons to "Expand"
        const toggleButtons = document.querySelectorAll('.toggle-button');
        toggleButtons.forEach(button => {
            const contentId = button.id.replace('toggleButton', '');
            const content = document.getElementById(`content${contentId}`);
            
            // Set appropriate button text based on content visibility
            if (content && content.style.display === 'block') {
                button.textContent = 'Collapse';
            } else {
                button.textContent = 'Expand';
            }
        });

        // Show the analyzed text button and mark compliance as shown
        analyzedTextButton.style.display = "inline-block";
        complianceDetailsShown = true;
    } else {
        complianceAnalysisContent.style.display = "none";
        this.textContent = "Show Compliance Details";

        // Only hide the analyzed text button if compliance details have never been shown
        if (!complianceDetailsShown) {
            analyzedTextButton.style.display = "none";
        }
    }
});
// Pop-up logic for Confirm Social Profile Compliance button
document.getElementById("confirmComplianceButton").addEventListener("click", function (event) {
    event.preventDefault(); // Prevent default action

    // Show the custom alert modal
    const alertModal = document.getElementById("customAlert");
    alertModal.style.display = "flex";

    // Handle Confirm button
    document.getElementById("alertConfirm").onclick = () => {
        alertModal.style.display = "none"; // Hide the modal

        // Replace button text with "Confirmed"
        const complianceButton = document.getElementById("confirmComplianceButton");
        complianceButton.textContent = "Confirmed âœ“";
        complianceButton.classList.add("confirmed"); // Update styling

        // Show the Submit button only after Confirm is selected
        const submitButton = document.querySelector("#confirmComplianceButton + button");
        submitButton.style.display = "inline-block"; // Reveal Submit button
    };

    // Handle Cancel button
    document.getElementById("alertCancel").onclick = () => {
        alertModal.style.display = "none"; // Just hide the modal
    };
});

// Show the upload box when the Upload Final button is clicked
document.getElementById("uploadButton").addEventListener("click", function (event) {
    event.preventDefault(); // Prevent default behavior
    const uploadBox = document.getElementById("uploadBox");
    uploadBox.style.display = "block"; // Show the upload box
});

// Trigger file input when "click to select" is clicked
document.getElementById("fileSelectButton").addEventListener("click", function () {
    document.getElementById("fileInput").click();
});

// Function to handle file upload
// Improved handleFileUpload function
function handleFileUpload() {
    const fileInput = document.getElementById("fileInput");
    const uploadBox = document.getElementById("uploadBox");
    
    if (fileInput && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileURL = URL.createObjectURL(file);
        
        // Update upload box content
        uploadBox.innerHTML = `
            <p><strong>Attached file:</strong> ${file.name}</p>
            <a href="${fileURL}" download="${file.name}" style="color: #007bff; text-decoration: underline;">Reopen File</a>
            <button id="changeFileButton" style="display: block; margin-top: 10px; padding: 5px 10px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">Change File</button>
        `;
        
        // Add click handler for the change file button
        const changeFileButton = document.getElementById("changeFileButton");
        if (changeFileButton) {
            changeFileButton.addEventListener('click', function(e) {
                e.preventDefault();
                // Reset the upload box to its original state
                uploadBox.innerHTML = `
                    <p>Drag and drop files here or <button id="fileSelectButton" style="color: #007bff; background: none; border: none; cursor: pointer; text-decoration: underline;">click to select</button></p>
                    <input id="fileInput" type="file" style="display: none;" multiple />
                `;
                
                // Reattach event listeners
                document.getElementById("fileSelectButton").addEventListener('click', function() {
                    document.getElementById("fileInput").click();
                });
                
                document.getElementById("fileInput").addEventListener('change', handleFileUpload);
            });
        }
        
        uploadBox.style.backgroundColor = '#e2e6ea'; // Keep background highlight
    }
}

// Add event listener for file selection
document.getElementById("fileInput").addEventListener("change", handleFileUpload);

// Drag-and-drop functionality for the upload box
const uploadBox = document.getElementById("uploadBox");
const fileInput = document.getElementById("fileInput");

uploadBox.addEventListener("dragover", function (event) {
    event.preventDefault(); // Allow drop
    this.style.backgroundColor = "#e2e6ea"; // Highlight on drag over
});

uploadBox.addEventListener("dragleave", function () {
    this.style.backgroundColor = "#f9f9f9"; // Revert highlight on drag leave
});

uploadBox.addEventListener("drop", function (event) {
    event.preventDefault(); // Prevent default behavior
    
    // Access the dropped files from dataTransfer
    if (event.dataTransfer.files.length > 0) {
        // Can't directly set files property on input, need a workaround
        const dt = new DataTransfer();
        for (let i = 0; i < event.dataTransfer.files.length; i++) {
            dt.items.add(event.dataTransfer.files[i]);
        }
        fileInput.files = dt.files;
        
        // Call the upload handler
        handleFileUpload();
    }
});

// Initially hide the Submit button
document.querySelector(".compliance-link + button").style.display = "none";

// Function to show the "Upload Final" button when "New Disclosures" section is visible
function showUploadButton() {
    const newDisclosuresContainer = document.getElementById("newDisclosuresContainer");
    const uploadButton = document.getElementById("uploadButton");

    // Observe when the "New Disclosures" section becomes visible
    const observer = new MutationObserver(() => {
        if (newDisclosuresContainer.style.display === "block") {
            uploadButton.style.display = "inline-block"; // Show the Upload Final button
            observer.disconnect(); // Stop observing after the button is shown
        }
    });

    // Start observing changes to the "New Disclosures" section
    observer.observe(newDisclosuresContainer, { attributes: true, attributeFilter: ['style'] });
}

// Call the function to observe the "New Disclosures" section
showUploadButton();

document.addEventListener("DOMContentLoaded", function () {
    // DEBUG: Log backend data sent to frontend
    const finraAnalysis = {{ finra_analysis | tojson }};
    console.log("FINRA Analysis Data:", finraAnalysis);

    // Verify data rendering
    if (finraAnalysis.length > 0) {
        console.log("Flagged Instances Found:");
        finraAnalysis.forEach((item, index) => {
            console.log(`Instance ${index + 1}:`, item);
        });
    } else {
        console.log("No FINRA analysis data found.");
    }
});


document.addEventListener("DOMContentLoaded", function () {
    // Retrieve the selected scenario disclosure from localStorage
    const selectedScenarioDisclosure = localStorage.getItem("selectedScenarioDisclosure");

    if (selectedScenarioDisclosure) {
        // Populate the "New Disclosures" section with the selected disclosure
        const newDisclosuresContainer = document.getElementById("newDisclosuresContainer");
        const newDisclosuresSection = document.getElementById("newDisclosuresSection");

        const li = document.createElement("li");
        li.textContent = selectedScenarioDisclosure;
        newDisclosuresSection.appendChild(li);

        // Make the "New Disclosures" section visible
        newDisclosuresContainer.style.display = "block";
    }
});


// Retrieve and log the logged-in user
const loggedInUser = localStorage.getItem('loggedInUser');

if (loggedInUser) {
    console.log(`Logged-in user: ${loggedInUser}`);
} else {
    console.log('No user is currently logged in.');
}


document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Fetch the current user's data
        const response = await fetch('/api/current-user');
        if (!response.ok) {
            throw new Error('Failed to fetch user data');
        }

        const user = await response.json();

        // Check if the user is an Administrator
        if (user.Administrator === "Yes") {
            document.getElementById('adminTab').style.display = 'block'; // Show the Admin tab
        }
    } catch (error) {
        console.error('Error checking admin status:', error);
    }
});

// Add toggle functionality for the instructions box
document.getElementById("toggleInstructionsButton").addEventListener("click", function() {
    const instructionsContent = document.getElementById("instructionsContent");
    if (instructionsContent.style.display === "none") {
        instructionsContent.style.display = "block";
        this.textContent = "Hide Instructions";
    } else {
        instructionsContent.style.display = "none";
        this.textContent = "Show Instructions";
    }
});

// Add this right after the <script> tag
function fetchUserScenario() {
    // Get the logged-in user's email from localStorage
    const userEmail = localStorage.getItem('loggedInUser') || '';
    if (!userEmail) {
        console.log('No logged-in user found');
        localStorage.setItem('pendingUserScenario', '');
        return;
    }

    // Fetch the user's assigned scenario from the server
    fetch('/get_user_scenario')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.hasScenario) {
                    // Store the scenario text in localStorage for use in disclosures
                    localStorage.setItem('pendingUserScenario', data.scenarioText);
                    
                    // Update the disclosureScenario element if it exists
                    const disclosureScenario = document.getElementById('disclosureScenario');
                    if (disclosureScenario) {
                        disclosureScenario.textContent = data.scenarioText;
                    }
                    
                    console.log('Assigned scenario fetched successfully:', data.scenarioText);
                } else {
                    localStorage.setItem('pendingUserScenario', '');
                    console.log('User has no assigned scenario');
                }
            } else {
                localStorage.setItem('pendingUserScenario', '');
                console.error('Error fetching scenario:', data.error);
            }
        })
        .catch(error => {
            localStorage.setItem('pendingUserScenario', '');
            console.error('Error fetching scenario:', error);
        });
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', fetchUserScenario);

// Add this to your script section
document.addEventListener('DOMContentLoaded', function() {
    // Check if the disclosureScenario element exists and update it if needed
    const disclosureScenario = document.getElementById('disclosureScenario');
    if (disclosureScenario) {
        // First, check if we already have a scenario from the server
        const scenarioText = disclosureScenario.textContent.trim();
        
        // If it's the default "No scenario assigned." text, try to get it from the API
        if (scenarioText === "No scenario assigned.") {
            fetch('/get_user_scenario')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.hasScenario) {
                        // Update the displayed scenario text
                        disclosureScenario.textContent = data.scenarioText;
                        
                        // Also update in localStorage for other parts of the app
                        localStorage.setItem('pendingUserScenario', data.scenarioText);
                    }
                })
                .catch(error => {
                    console.error('Error fetching scenario:', error);
                });
        } else {
            // If the server already provided a scenario, store it in localStorage
            localStorage.setItem('pendingUserScenario', scenarioText);
        }
    }
});

// Save for Later feature
document.addEventListener('DOMContentLoaded', function() {
    const saveForLaterButton = document.getElementById('saveForLaterButton');
    const titleDialog = document.getElementById('titleDialog');
    const confirmSaveButton = document.getElementById('confirmSave');
    const cancelSaveButton = document.getElementById('cancelSave');
    const titleInput = document.getElementById('savedTitle');
    
    // Add hover effects
    if (saveForLaterButton) {
        saveForLaterButton.addEventListener('mouseover', function() {
            this.style.backgroundColor = '#218838'; // Darker green on hover
            this.style.transform = 'translateY(-3px)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        });
        
        saveForLaterButton.addEventListener('mouseout', function() {
            this.style.backgroundColor = '#28a745'; // Back to original color
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        });
        
        // When Save for Later button is clicked, show title dialog
        saveForLaterButton.addEventListener('click', function() {
            // Show the title dialog
            titleDialog.style.display = "flex";
            
            // Set focus on title input
            setTimeout(() => {
                titleInput.focus();
            }, 100);
            
            // Generate a default title with date and time
            const now = new Date();
            const defaultTitle = `Analysis - ${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            titleInput.value = defaultTitle;
        });
    }
    
    // Handle confirm save
    if (confirmSaveButton) {
        confirmSaveButton.addEventListener('click', function() {
            saveAnalysis();
        });
    }
    
    // Also allow Enter key to confirm
    if (titleInput) {
        titleInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveAnalysis();
            }
        });
    }
    
    // Handle cancel
    if (cancelSaveButton) {
        cancelSaveButton.addEventListener('click', function() {
            titleDialog.style.display = "none";
        });
    }
    
    function saveAnalysis() {
    const title = titleInput.value.trim() || `Untitled - ${new Date().toLocaleString()}`;
    
    // Get current content and state
    const revisedText = document.getElementById('revisedText').innerText;
    const selectedOptions = JSON.parse(localStorage.getItem('selectedUseTypes') || '[]');
    
    // Get any displayed disclosures
    let disclosures = [];
    const dynamicInstructions = document.getElementById('dynamicInstructions');
    if (dynamicInstructions) {
        const disclosureDivs = dynamicInstructions.querySelectorAll('.disclosure-content');
        disclosureDivs.forEach(div => {
            const disclosureText = div.innerText.replace(/\n\s*\n/g, '\n');
            disclosures.push(disclosureText);
        });
    }
    
    // Get the original URL parameters to recreate this page
    const urlParams = new URLSearchParams(window.location.search);
    
    // Create saved analysis object with all necessary state
    const savedAnalysis = {
        id: Date.now().toString(),
        title: title,
        date: new Date().toISOString(),
        revisedText: revisedText,
        selectedOptions: selectedOptions,
        disclosures: disclosures,
        urlParams: urlParams.toString(), // Store URL parameters to recreate page
        pathname: window.location.pathname // Store the page path
    };
    
    // Get existing saved analyses or initialize empty array
    const savedAnalyses = JSON.parse(localStorage.getItem('savedAnalyses') || '[]');
    
    // Add new analysis to the beginning of the array
    savedAnalyses.unshift(savedAnalysis);
    
    // Save to localStorage
    localStorage.setItem('savedAnalyses', JSON.stringify(savedAnalyses));
    
    // Close dialog
    titleDialog.style.display = "none";
    
    // Provide feedback to user
    const originalText = saveForLaterButton.innerHTML;
    saveForLaterButton.innerHTML = '<i class="fas fa-check" style="margin-right: 8px;"></i> Saved Successfully!';
    saveForLaterButton.style.backgroundColor = '#218838';
    
    setTimeout(() => {
        window.location.href = "/profile"; // Redirect to profile page
    }, 2000);
}
});

// Debugging for Save for Later button
document.addEventListener('DOMContentLoaded', function() {
    const saveForLaterButton = document.getElementById('saveForLaterButton');
    console.log("Save for Later button found:", !!saveForLaterButton);
    
    if (saveForLaterButton) {
        saveForLaterButton.addEventListener('click', function() {
            console.log("Save for Later button clicked!");
        });
    }
    
    // Debug the submitConfirm button too
    const submitConfirmButton = document.getElementById('submitConfirm');
    if (submitConfirmButton) {
        console.log("Submit Confirm button found:", !!submitConfirmButton);
        
        // Add a second click handler just for debugging
        submitConfirmButton.addEventListener('click', function() {
            console.log("Submit Confirm button clicked!");
            
            // Check if the Save for Later button is visible after a short delay
            setTimeout(() => {
                const saveButtonStyle = window.getComputedStyle(saveForLaterButton);
                console.log("Save button display:", saveButtonStyle.display);
                console.log("Save button visibility:", saveButtonStyle.visibility);
            }, 500);
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Check if we're supposed to load a saved analysis
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        const savedAnalysisJson = localStorage.getItem('loadSavedAnalysis');
        if (savedAnalysisJson) {
            try {
                const savedAnalysis = JSON.parse(savedAnalysisJson);
                
                // Populate the revised text
                const revisedTextElement = document.getElementById('revisedText');
                if (revisedTextElement && savedAnalysis.revisedText) {
                    revisedTextElement.innerText = savedAnalysis.revisedText;
                    
                    // Make sure the revised text box is visible
                    const revisedTextBox = document.getElementById('revisedTextBox');
                    if (revisedTextBox) {
                        revisedTextBox.style.display = 'block';
                    }
                    
                    // Make content visible
                    revisedTextElement.style.display = 'block';
                    
                    // Update toggle button if it exists
                    const toggleButton = document.getElementById('toggleRevisedTextButton');
                    if (toggleButton) {
                        toggleButton.textContent = 'Hide Revised Text';
                    }
                }
                
                // Restore selected options if needed
                if (savedAnalysis.selectedOptions && savedAnalysis.selectedOptions.length > 0) {
                    localStorage.setItem('selectedUseTypes', JSON.stringify(savedAnalysis.selectedOptions));
                }
                
                // Show action buttons if they exist
                const actionButtons = document.getElementById('actionButtons');
                if (actionButtons) {
                    actionButtons.style.display = 'flex';
                }
                
                // Show the reminders/instructions box if there were disclosures
                if (savedAnalysis.disclosures && savedAnalysis.disclosures.length > 0) {
                    const instructionsBox = document.getElementById('instructionsBox');
                    if (instructionsBox) {
                        instructionsBox.style.display = 'block';
                        
                        // Populate dynamic instructions
                        const dynamicInstructions = document.getElementById('dynamicInstructions');
                        if (dynamicInstructions) {
                            // This would need custom code to recreate the instructions
                            // based on your specific implementation
                        }
                    }
                }
                
                // Show a notification that we loaded a saved analysis
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.backgroundColor = '#28a745';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '4px';
                notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                notification.style.zIndex = '1000';
                notification.textContent = `Loaded saved analysis: ${savedAnalysis.title}`;
                
                document.body.appendChild(notification);
                
                // Remove the notification after 5 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 500);
                }, 5000);
                
                // Clear the saved analysis from localStorage
                localStorage.removeItem('loadSavedAnalysis');
                
            } catch (error) {
                console.error('Error loading saved analysis:', error);
            }
        }
    }
});


function addPageSpecificDisclosures(categoryId, contentType) {
    // First get the current filename from localStorage
    const filename = localStorage.getItem('currentFilename');
    if (!filename) {
        console.warn('No filename found in localStorage');
        return;
    }
    
    console.log(`Getting page-specific disclosures for ${filename}, content type: ${contentType}`);
    
    // Get the page-specific disclosures container
    const pageDisclosuresSection = document.getElementById(`${categoryId}-page-disclosures`);
    if (!pageDisclosuresSection) {
        console.warn(`Page disclosures section not found for ${categoryId}`);
        return;
    }
    
    // Show loading indicator
    pageDisclosuresSection.innerHTML = `
        <h4>Page-Specific Disclosures</h4>
        <p><em>Loading page-specific disclosures...</em></p>
    `;
    
    // Get the revised text
    const revisedTextElement = document.getElementById("revisedText");
    const revisedText = revisedTextElement ? revisedTextElement.innerText : '';
    
    // First, log the pages directly from the text to debug
    const debugContent = `
        <h4>Text pages for debugging:</h4>
        <p>Page 1: This mutual fund aims to generate returns.</p>
        <p>Page 2: This index fund aims to emulate the performance of the S&P 500.</p>
        <p>Page 3: This CD may have the potential to yield a return on your investment.</p>
    `;
    
    // If we're testing, use our hardcoded test pages
    const testMode = true; // Set to true for testing with our example
    
    if (testMode) {
        // For testing with our example pages
        const testPages = [
            { page: 1, text: "This mutual fund aims to generate returns." },
            { page: 2, text: "This index fund aims to emulate the performance of the S&P 500." },
            { page: 3, text: "This CD may have the potential to yield a return on your investment." }
        ];
        
        console.log('Using test pages:', testPages);
        
        // Call the API directly with our test pages
        fetch('/get_page_specific_disclosures', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content_type: contentType,
                text: "Test text",
                original_text_by_page: testPages
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Page-specific disclosures API response:', data);
            displayPageDisclosures(data, pageDisclosuresSection);
        })
        .catch(error => {
            console.error('Error fetching page-specific disclosures:', error);
            pageDisclosuresSection.innerHTML = `
                <h4>Page-Specific Disclosures</h4>
                <p><em>Could not load page-specific disclosures: ${error.message}</em></p>
                ${debugContent}
            `;
        });
    }
    else {
        // Regular code path - get file pages then get disclosures
        fetch('/get_file_pages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ filename: filename })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to get file pages');
            }
            
            console.log('Got file pages successfully:', data.text_by_page);
            
            // Now get page-specific disclosures
            return fetch('/get_page_specific_disclosures', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content_type: contentType,
                    text: revisedText,
                    original_text_by_page: data.text_by_page
                })
            });
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Page-specific disclosures API response:', data);
            displayPageDisclosures(data, pageDisclosuresSection);
        })
        .catch(error => {
            console.error('Error fetching page-specific disclosures:', error);
            pageDisclosuresSection.innerHTML = `
                <h4>Page-Specific Disclosures</h4>
                <p><em>Could not load page-specific disclosures: ${error.message}</em></p>
                ${debugContent}
            `;
        });
    }
}

// Update the displayPageDisclosures function to reformat the content
function displayPageDisclosures(data, pageDisclosuresSection) {
    // Get the user's assigned scenario
    let userScenario = localStorage.getItem('pendingUserScenario') || '';
    
    // Format page-specific disclosures
    if (data.page_disclosures && Object.keys(data.page_disclosures).length > 0) {
        let pageDisclosuresHTML = `<h2>PAGE SPECIFIC DISCLOSURES</h2>`;
        
        // Sort pages numerically
        const pages = Object.keys(data.page_disclosures).map(Number).sort((a, b) => a - b);
        
        pages.forEach(pageNum => {
            const pageDisclosures = data.page_disclosures[pageNum.toString()];
            
            if (pageDisclosures && pageDisclosures.length > 0) {
                // Check if the page has the investing disclosure
                const pageHasInvestingDisclosure = pageDisclosures.some(d => 
                    d.includes("Investing involves risk including loss of principal"));
                    
                // Filter out investing disclosure if needed
                const filteredPageDisclosures = pageHasInvestingDisclosure 
                    ? pageDisclosures.filter(d => !d.includes("Investing involves risk including loss of principal"))
                    : pageDisclosures;
                
                // Add the formatted scenario and disclosures for this page
                pageDisclosuresHTML += `
                    <div class="page-disclosure">
                        <h5>Page ${pageNum}</h5>
                        ${pageHasInvestingDisclosure ? 
                            `<p><strong>Investing involves risk including loss of principal. No strategy assures success or protects against loss.</strong></p>` : ''}
                        <p>${userScenario ? `<strong>${userScenario}</strong> ` : ''}${filteredPageDisclosures.join(' ')}</p>
                    </div>
                `;
            }
        });
        
        pageDisclosuresSection.innerHTML = pageDisclosuresHTML;
        
        // Update the tabs in any existing reminders box
        updatePageTabsInReminders();
    } else {
        // No disclosures found
        // Add debugging information to help troubleshoot
        const debugInfo = data.debug_info ? 
            `<p><em>Debug info: ${JSON.stringify(data.debug_info)}</em></p>` : '';
        
        pageDisclosuresSection.innerHTML = `
            <h2>PAGE SPECIFIC DISCLOSURES</h2>
            <p><em>No page-specific disclosures identified. Use general disclosures for all pages.</em></p>
            ${debugInfo}
            <p><em>Debug keywords checked: mutual fund, index fund, CD, returns, performance, investment</em></p>
        `;
        
        // Update the tabs in any existing reminders box
        updatePageTabsInReminders();
    }
}

function updatePageTabsInReminders() {
    const pageSpecificBox = document.getElementById('pageSpecificDisclosures');
    if (!pageSpecificBox) return;
    
    // Find all pages panels in the reminders
    const pagePanels = document.querySelectorAll('[id$="-pages-panel"]');
    
    pagePanels.forEach(panel => {
        const categoryId = panel.id.replace('-pages-panel', '');
        
        // Only update for book or presentation categories
        if (categoryId === 'booklet-or-pamphlet' || categoryId === 'presentation-script-or-slides') {
            // Extract page disclosures from the pageSpecificDisclosures box
            const pageDisclosures = pageSpecificBox.querySelectorAll('.page-disclosure');
            
            if (pageDisclosures.length <= 1) {
                // For one-page files, just show "See Main Disclosure Tab"
                panel.innerHTML = `<p><em>See Main Disclosure Tab</em></p>`;
            } else if (pageDisclosures.length > 0) {
                let pagesHTML = '';
                pageDisclosures.forEach(disclosure => {
                    const pageTitle = disclosure.querySelector('h5').textContent;
                    const pageContent = disclosure.querySelector('p').textContent;
                    
                    pagesHTML += `
                        <div class="page-tab-content">
                            <div class="page-number">${pageTitle}</div>
                            <p>${pageContent}</p>
                        </div>
                    `;
                });
                
                panel.innerHTML = pagesHTML;
            } else {
                panel.innerHTML = `<p><em>No page-specific disclosures found.</em></p>`;
            }
        }
    });
}

// Make sure we have the helper function for the category notes
function getCategorySpecificNote(categoryName) {
    switch(categoryName) {
        case 'Booklet or Pamphlet':
            return 'Multi-page documents should contain disclosures on the corresponding page as indicated, along with other disclosures that appear in your Revised Analyzed Text.';
        case 'Presentation Script or Slides':
            return 'Speaker\'s notes may be required in addition to slides if there is not sufficient information on the slides. Slides should contain disclosures on the corresponding page as indicated. Disclosures on slides should be large enough to be seen from all points in the room.';
        case 'Audio or Podcast':
            return 'Content that is audio only should have disclosures said aloud at beginning or end of content. Disclosures must be articulated clearly and at a pace that can be easily understood by listeners.';
        case 'Video':
            return 'Disclosures should be presented clearly on screen, appear long enough to be read by viewers, and should be placed within the context of the content itself or at the end of the video. Consideration should be given to size of text used to display disclosure(s).';
        case 'Article':
            return 'For articles, disclosures text should not vary from size of text used in article and they should be placed within the context of the content itself or at the bottom of the page.';
        case 'Graphic or Image':
            return 'Graphics and images should include a source (if applicable) and relevant disclosure. Graphics should also include a simplified description.';
        case 'Other Format':
            return 'Ensure all disclosures from your Revised Analyzed Text are incorporated appropriately based on the medium you\'re using.';
        case 'Social Media Post':
            return 'Your social media account profile used to post this content must contain necessary disclaimers and be approved by principal prior to posting.';
        default:
            return '';
    }
}
// Add this code to your script section

document.addEventListener('DOMContentLoaded', function() {
    const uploadBox = document.getElementById("uploadBox");
    const fileInput = document.getElementById("fileInput");
    
    // Make sure elements exist before adding event listeners
    if (uploadBox && fileInput) {
        // Setup drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadBox.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadBox.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            uploadBox.style.backgroundColor = '#e2e6ea';
            uploadBox.style.borderColor = '#007bff';
        }
        
        function unhighlight() {
            uploadBox.style.backgroundColor = '#f9f9f9';
            uploadBox.style.borderColor = '#007bff';
        }
        
        // Handle dropped files
        uploadBox.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFileUpload();
        }
        
        // Make sure file select button works
        const fileSelectButton = document.getElementById("fileSelectButton");
        if (fileSelectButton) {
            fileSelectButton.addEventListener('click', function() {
                fileInput.click();
            });
        }
        
        // Handle file selection
        fileInput.addEventListener('change', handleFileUpload);
    } else {
        console.error("Upload box or file input elements not found");
    }
    
    // PDF Upload Area handlers
    const pdfUploadArea = document.getElementById("pdfUploadArea");
    const pdfFileInput = document.getElementById("pdfFileInput");
    const selectPdfButton = document.getElementById("selectPdfButton");
    
    if (pdfUploadArea && pdfFileInput && selectPdfButton) {
        // Setup drag and drop for PDF
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            pdfUploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight PDF drop area
        ['dragenter', 'dragover'].forEach(eventName => {
            pdfUploadArea.addEventListener(eventName, function() {
                pdfUploadArea.style.backgroundColor = '#e2e6ea';
                pdfUploadArea.style.borderColor = '#007bff';
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            pdfUploadArea.addEventListener(eventName, function() {
                pdfUploadArea.style.backgroundColor = '';
                pdfUploadArea.style.borderColor = '#007bff';
            }, false);
        });
        
        // Handle dropped PDF files
        pdfUploadArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0 && files[0].type === 'application/pdf') {
                pdfFileInput.files = files;
                document.getElementById('pdfFileName').textContent = files[0].name;
            } else {
                alert('Please upload a PDF file');
            }
        }, false);
        
        // Make PDF select button work
        selectPdfButton.addEventListener('click', function() {
            pdfFileInput.click();
        });
        
        // Handle PDF file selection
        pdfFileInput.addEventListener('change', function() {
            if (pdfFileInput.files.length > 0) {
                document.getElementById('pdfFileName').textContent = pdfFileInput.files[0].name;
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Store the filename in localStorage if it's passed from the server
    const filename = "{{ filename }}";
    if (filename) {
        localStorage.setItem('currentFilename', filename);
        console.log('Stored filename in localStorage:', filename);
    }
});


// Add this function to scan uploaded file for keywords from disclosures.json
function scanFileForDisclosureKeywords(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async function(event) {
            try {
                const fileContent = event.target.result;
                
                // Call the backend to get disclosures
                const disclosuresResponse = await fetch('/get_disclosures');
                const disclosuresData = await disclosuresResponse.json();
                
                if (!disclosuresData.success) {
                    throw new Error('Failed to fetch disclosures');
                }
                
                const disclosures = disclosuresData.disclosures;
                const pageSpecificDisclosures = {};
                
                // Simple parser to split content into pages (this is a simplified approach)
                // For PDFs or complex documents, you would need a more robust page detection
                const pages = fileContent.split(/Page\s+\d+|[\f\n]{2,}/g).filter(page => page.trim());
                
                // For each page, look for keywords
                pages.forEach((pageContent, pageIndex) => {
                    const pageNumber = pageIndex + 1;
                    const matchedKeywords = [];
                    
                    // Look for each keyword in the page content
                    Object.keys(disclosures).forEach(keyword => {
                        if (pageContent.toLowerCase().includes(keyword.toLowerCase())) {
                            matchedKeywords.push({
                                keyword: keyword,
                                description: disclosures[keyword]
                            });
                        }
                    });
                    
                    if (matchedKeywords.length > 0) {
                        pageSpecificDisclosures[pageNumber] = matchedKeywords;
                    }
                });
                
                resolve(pageSpecificDisclosures);
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = function() {
            reject(new Error('Error reading file'));
        };
        
        reader.readAsText(file);
    });
}

// Update the file input handler to check for keywords
document.addEventListener('DOMContentLoaded', function() {
    // Find file input in both the main upload area and the popup
    const fileInputs = document.querySelectorAll('input[type="file"]');
    
    fileInputs.forEach(fileInput => {
        fileInput.addEventListener('change', async function(event) {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                try {
                    // Process the file as before for compliance checking
                    handleFileUpload();
                    
                    // Additionally, scan for disclosure keywords
                    const pageDisclosures = await scanFileForDisclosureKeywords(file);
                    
                    // Display the page-specific disclosures
                    displayPageSpecificDisclosures(pageDisclosures);
                } catch (error) {
                    console.error('Error processing file for disclosures:', error);
                }
            }
        });
    });
});


// Update the scanFileForDisclosureKeywords function to use the server endpoint
function scanFileForDisclosureKeywords(file) {
    return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/scan_file_for_disclosures', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Server error scanning file');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                resolve(data.page_specific_disclosures);
            } else {
                reject(new Error(data.error || 'Unknown error scanning file'));
            }
        })
        .catch(error => {
            reject(error);
        });
    });
}

// Function to scan uploaded file for keywords from disclosures.json
function handleUploadedFileForDisclosures(file) {
    // Create a FormData object to send the file to the server
    const formData = new FormData();
    formData.append('file', file);
    
    // Show loading indicator
    const pageSpecificDisclosuresSection = document.getElementById('pageSpecificDisclosures');
    if (!pageSpecificDisclosuresSection) {
        // Create the section if it doesn't exist
        const newSection = document.createElement('div');
        newSection.id = 'pageSpecificDisclosures';
        newSection.className = 'compliance-box';
        newSection.innerHTML = `
            <h2>PAGE SPECIFIC DISCLOSURES</h2>
            <div style="text-align: center; padding: 20px;">
                <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p>Scanning file for disclosure keywords...</p>
            </div>
        `;
        
        // Find a good place to insert it - after the instructionsBox or at the end of the body
        const instructionsBox = document.getElementById('instructionsBox');
        if (instructionsBox) {
            instructionsBox.parentNode.insertBefore(newSection, instructionsBox.nextSibling);
        } else {
            document.body.appendChild(newSection);
        }
    } else {
        pageSpecificDisclosuresSection.innerHTML = `
            <h2>PAGE SPECIFIC DISCLOSURES</h2>
            <div style="text-align: center; padding: 20px;">
                <div class="spinner" style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p>Scanning file for disclosure keywords...</p>
            </div>
        `;
        pageSpecificDisclosuresSection.style.display = 'block';
    }
    
    // Send the file to the server for scanning
    fetch('/scan_file_for_disclosures', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Server error scanning file');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            displayPageSpecificDisclosures(data.page_specific_disclosures);
        } else {
            throw new Error(data.error || 'Unknown error scanning file');
        }
    })
    .catch(error => {
        console.error('Error scanning file for disclosures:', error);
        const pageSpecificDisclosuresSection = document.getElementById('pageSpecificDisclosures');
        if (pageSpecificDisclosuresSection) {
            pageSpecificDisclosuresSection.innerHTML = `
                <h2>PAGE SPECIFIC DISCLOSURES</h2>
                <p style="color: #dc3545;">Error scanning file: ${error.message}</p>
            `;
        }
    });
}

// Function to display page-specific disclosures with the new format
function displayPageSpecificDisclosures(disclosuresByPage) {
    // Create or get the section for page-specific disclosures
    let pageDisclosuresSection = document.getElementById('pageSpecificDisclosures');
    
    if (!pageDisclosuresSection) {
        pageDisclosuresSection = document.createElement('div');
        pageDisclosuresSection.id = 'pageSpecificDisclosures';
        pageDisclosuresSection.className = 'compliance-box';
        
        // Add it after the instructionsBox if possible
        const instructionsBox = document.getElementById('instructionsBox');
        if (instructionsBox) {
            instructionsBox.parentNode.insertBefore(pageDisclosuresSection, instructionsBox.nextSibling);
        } else {
            document.body.appendChild(pageDisclosuresSection);
        }
    }
    
    // Clear any existing content
    pageDisclosuresSection.innerHTML = '';
    
    // Add header
    const header = document.createElement('h2');
    header.textContent = 'PAGE SPECIFIC DISCLOSURES';
    pageDisclosuresSection.appendChild(header);
    
    // If no disclosures found
    if (Object.keys(disclosuresByPage).length === 0) {
        const noDisclosuresMsg = document.createElement('p');
        noDisclosuresMsg.textContent = 'No page-specific disclosures found in the document.';
        pageDisclosuresSection.appendChild(noDisclosuresMsg);
        
        // Update the Pages sections in reminders
        updatePagesInReminders();
        return;
    }
    
    // Sort pages numerically
    const sortedPages = Object.keys(disclosuresByPage).sort((a, b) => Number(a) - Number(b));
    
    // Display disclosures for each page
    sortedPages.forEach(pageNumber => {
        const pageSection = document.createElement('div');
        pageSection.className = 'page-disclosure';
        
        const pageHeader = document.createElement('h5');
        pageHeader.textContent = `Page ${pageNumber}`;
        pageSection.appendChild(pageHeader);
        
        // Combine all disclosures for this page into a single paragraph
        const disclosurePara = document.createElement('p');
        
        // Get all disclosure descriptions for this page and join them with spaces
        const combinedText = disclosuresByPage[pageNumber]
            .map(item => item.description)
            .join(' ');
        
        disclosurePara.textContent = combinedText;
        pageSection.appendChild(disclosurePara);
        
        pageDisclosuresSection.appendChild(pageSection);
    });
    
    // Ensure the section is visible
    pageDisclosuresSection.style.display = 'block';
    
    // Update the Pages sections in reminders
    updatePagesInReminders();
    
    // Scroll to the section
    pageDisclosuresSection.scrollIntoView({ behavior: 'smooth' });
}

// Add this to our existing fileInput change handler (don't replace it)
document.addEventListener('DOMContentLoaded', function() {
    // Get all file input elements
    const fileInputs = document.querySelectorAll('input[type="file"]');
    
    fileInputs.forEach(fileInput => {
        // Keep the original change event handler if it exists, but add our new functionality
        const originalChangeHandler = fileInput.onchange;
        
        fileInput.addEventListener('change', function(event) {
            // Call original handler if it exists
            if (typeof originalChangeHandler === 'function') {
                originalChangeHandler.call(this, event);
            }
            
            // Add our new functionality for disclosure scanning
            if (this.files && this.files[0]) {
                // Only scan for disclosures if this is the main file input, not the PDF upload area
                if (this.id === 'fileInput') {
                    setTimeout(() => {
                        handleUploadedFileForDisclosures(this.files[0]);
                    }, 1000); // Small delay to let the original handler finish
                }
            }
        });
    });
    
    // Also handle the drop event on the upload box
    const uploadBox = document.getElementById('uploadBox');
    if (uploadBox) {
        // Keep the original drop event handler if it exists
        const originalDropHandler = uploadBox.ondrop;
        
        uploadBox.addEventListener('drop', function(event) {
            // Prevent the browser from opening the file
            event.preventDefault();
            
            // Call original handler if it exists
            if (typeof originalDropHandler === 'function') {
                originalDropHandler.call(this, event);
            }
            
            // Process the dropped file
            if (event.dataTransfer.files.length > 0) {
                setTimeout(() => {
                    handleUploadedFileForDisclosures(event.dataTransfer.files[0]);
                }, 1000); // Small delay to let the original handler finish
            }
        });
    }
});

// Make sure we also handle files that are attached through the Upload Final button
document.addEventListener('DOMContentLoaded', function() {
    const uploadButton = document.getElementById('uploadButton');
    
    if (uploadButton) {
        uploadButton.addEventListener('click', function(e) {
            // The original click handler will show the upload box
            // We just need to monitor when a file is attached
            
            // Get a reference to the file input inside the upload box
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                // Keep track of the original change handler
                const originalChangeHandler = fileInput.onchange;
                
                // Replace with our enhanced version
                fileInput.onchange = function(event) {
                    // Call original handler if it exists
                    if (typeof originalChangeHandler === 'function') {
                        originalChangeHandler.call(this, event);
                    }
                    
                    // Also handle the file for disclosures
                    if (this.files && this.files[0]) {
                        setTimeout(() => {
                            handleUploadedFileForDisclosures(this.files[0]);
                        }, 1000); // Small delay
                    }
                };
            }
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Set all toggle buttons to "Expand" initially
    const toggleButtons = document.querySelectorAll('.toggle-button');
    toggleButtons.forEach(button => {
        button.textContent = 'Expand';
    });
});

// In your results.html page, add this to handle loading from client
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're loading from a saved analysis
    if (document.body.dataset.loadFromClient === 'true') {
        const savedAnalysisJson = localStorage.getItem('loadSavedAnalysis');
        if (savedAnalysisJson) {
            try {
                const savedAnalysis = JSON.parse(savedAnalysisJson);
                
                // Populate elements with saved content
                document.getElementById('analyzedTextContent').innerText = 
                    savedAnalysis.originalText || '';
                document.getElementById('revisedText').innerText = 
                    savedAnalysis.revisedText || '';
                
                // Show appropriate sections
                document.getElementById("revisedTextBox").style.display = "block";
                document.getElementById("revisedText").style.display = "block";
                
                // Other UI adjustments as needed...
            } catch (error) {
                console.error('Error loading saved analysis:', error);
            }
        }
    }
});

// Add this inside your existing DOMContentLoaded event handler
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're loading a saved analysis
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        const savedAnalysisJson = localStorage.getItem('loadSavedAnalysis');
        const savedAlternativesJson = localStorage.getItem('selectedAlternatives');
        
        if (savedAnalysisJson && savedAlternativesJson) {
            try {
                const savedAnalysis = JSON.parse(savedAnalysisJson);
                const selectedAlternatives = JSON.parse(savedAlternativesJson);
                
                // Load the saved alternatives
                Object.keys(selectedAlternatives).forEach(itemId => {
                    const selectedText = selectedAlternatives[itemId];
                    if (selectedText) {
                        // Set the selected text
                        const selectedTextElement = document.getElementById(`selectedText${itemId}`);
                        if (selectedTextElement) {
                            selectedTextElement.textContent = selectedText;
                            
                            // Show the selected alternative and hide the content
                            const selectedAlternativeDiv = document.getElementById(`selectedAlternative${itemId}`);
                            const contentDiv = document.getElementById(`content${itemId}`);
                            
                            if (selectedAlternativeDiv) selectedAlternativeDiv.style.display = 'block';
                            if (contentDiv) contentDiv.style.display = 'none';
                            
                            // Increment selected count
                            selectedCount++;
                        }
                    }
                });
                
                // Check if all items are selected
                checkAllSelected();
                
                // Rest of your existing code for loading a saved analysis...
            } catch (error) {
                console.error('Error loading saved alternatives:', error);
            }
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Check if we're loading a saved analysis
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        const savedAnalysisJson = localStorage.getItem('loadSavedAnalysis');
        const savedAlternativesJson = localStorage.getItem('selectedAlternatives');
        
        if (savedAlternativesJson) {
            try {
                const selectedAlternatives = JSON.parse(savedAlternativesJson);
                
                // Load the saved alternatives
                Object.keys(selectedAlternatives).forEach(itemId => {
                    const selectedText = selectedAlternatives[itemId];
                    if (selectedText) {
                        // Set the selected text
                        const selectedTextElement = document.getElementById(`selectedText${itemId}`);
                        if (selectedTextElement) {
                            selectedTextElement.textContent = selectedText;
                            
                            // Show the selected alternative and hide the content
                            const selectedAlternativeDiv = document.getElementById(`selectedAlternative${itemId}`);
                            const contentDiv = document.getElementById(`content${itemId}`);
                            
                            if (selectedAlternativeDiv) selectedAlternativeDiv.style.display = 'block';
                            if (contentDiv) contentDiv.style.display = 'none';
                            
                            // Increment selected count
                            selectedCount++;
                        }
                    }
                });
                
                // Check if all items are selected
                checkAllSelected();
            } catch (error) {
                console.error('Error loading saved alternatives:', error);
            }
        }
    }
});

// Add this to your existing javascript code
document.addEventListener('DOMContentLoaded', function() {
    // Check if we're loading a saved analysis
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        // For saved instances, modify the behavior of the Next button
        const originalCheckAllSelected = window.checkAllSelected;
        
        // Override the checkAllSelected function
        window.checkAllSelected = function() {
            // Call the original function first
            originalCheckAllSelected();
            
            // If all items are selected and this is a saved instance
            if (selectedCount >= totalItems) {
                // When the Next button appears, also highlight the Revised Text box
                const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
                const revisedTextBox = document.getElementById("revisedTextBox");
                
                if (generateDisclosuresBtn && generateDisclosuresBtn.style.display !== "none") {
                    // Add event listener to Next button for saved instances
                    generateDisclosuresBtn.addEventListener('click', function() {
                        // Make sure the Revised Analyzed Text box is shown and highlighted
                        revisedTextBox.style.display = "block";
                        revisedTextBox.classList.add("highlighted");
                        
                        // Make revised text content visible
                        document.getElementById("revisedText").style.display = "block";
                        document.getElementById("actionButtons").style.display = "flex";
                        
                        // Update toggle button text
                        const toggleRevisedTextButton = document.getElementById("toggleRevisedTextButton");
                        if (toggleRevisedTextButton) {
                            toggleRevisedTextButton.textContent = "Hide Revised Text";
                        }
                    }, { once: true }); // Only add this listener once
                }
            }
        };
        
        // If the Next button is already clicked when loading a saved instance
        if (nextButtonClicked) {
            // Ensure Revised Analyzed Text box is properly highlighted
            const revisedTextBox = document.getElementById("revisedTextBox");
            if (revisedTextBox) {
                revisedTextBox.style.display = "block";
                revisedTextBox.classList.add("highlighted");
                
                // Ensure content is visible
                document.getElementById("revisedText").style.display = "block";
                document.getElementById("actionButtons").style.display = "flex";
                
                // Update toggle button
                const toggleRevisedTextButton = document.getElementById("toggleRevisedTextButton");
                if (toggleRevisedTextButton) {
                    toggleRevisedTextButton.textContent = "Hide Revised Text";
                }
            }
        }
    }
});

// Additionally, modify the generateDisclosures function for saved instances
const originalGenerateDisclosures = window.generateDisclosures;
window.generateDisclosures = function() {
    // Call the original function
    originalGenerateDisclosures();
    
    // Check if this is a saved instance
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        // For saved instances, ensure the Revised Analyzed Text box is highlighted
        const revisedTextBox = document.getElementById("revisedTextBox");
        if (revisedTextBox) {
            revisedTextBox.classList.add("highlighted");
        }
    }
};

// Add highlighting for Revised Analyzed Text and Generated Disclosures boxes for saved instances
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        // Function to handle the Next button click for saved instances
        function handleNextButtonClick() {
            // Highlight Revised Analyzed Text box
            const revisedTextBox = document.getElementById("revisedTextBox");
            if (revisedTextBox) {
                revisedTextBox.style.display = "block";
                revisedTextBox.classList.add("highlighted");
                document.getElementById("revisedText").style.display = "block";
                document.getElementById("actionButtons").style.display = "flex";
            }
            
            // Highlight Generated Disclosures box
            setTimeout(function() {
                const instructionsBox = document.getElementById("instructionsBox");
                if (instructionsBox) {
                    instructionsBox.classList.add("highlighted");
                }
            }, 500);
        }
        
        // Watch for the Next button and add a listener
        function setupNextButtonListener() {
            const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
            if (generateDisclosuresBtn && generateDisclosuresBtn.style.display !== "none") {
                generateDisclosuresBtn.addEventListener('click', handleNextButtonClick, { once: true });
            }
        }
        
        // Set up listener when all items are selected
        const originalCheckAllSelected = window.checkAllSelected;
        window.checkAllSelected = function() {
            originalCheckAllSelected();
            if (selectedCount >= totalItems) {
                setupNextButtonListener();
            }
        };
        
        // Handle case where Next button was already clicked
        if (nextButtonClicked) {
            handleNextButtonClick();
        }
        
        // Monitor when the Generated Disclosures box appears
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' || (mutation.type === 'attributes' && mutation.attributeName === 'style')) {
                    const instructionsBox = document.getElementById("instructionsBox");
                    if (instructionsBox && instructionsBox.style.display !== "none") {
                        instructionsBox.classList.add("highlighted");
                    }
                }
            });
        });
        
        // Start observing for Generated Disclosures box
        observer.observe(document.body, { childList: true, subtree: true, attributes: true });
    }
});

// Function to show the Save for Later button for saved instances
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const loadSaved = urlParams.get('loadSaved') === 'true';
    
    if (loadSaved) {
        // Function to show the Save for Later button
        function showSaveForLaterButton() {
            const saveForLaterButton = document.getElementById('saveForLaterButton');
            if (saveForLaterButton) {
                saveForLaterButton.style.display = "block";
                saveForLaterButton.classList.add("highlighted");
            }
        }
        
        // Show it when the Next button is clicked
        const generateDisclosuresBtn = document.getElementById("generateDisclosuresBtn");
        if (generateDisclosuresBtn) {
            generateDisclosuresBtn.addEventListener('click', function() {
                // Add a slight delay to ensure other elements are rendered first
                setTimeout(showSaveForLaterButton, 600);
            }, { once: true });
        }
        
        // Also show it if instructions box is already visible (Next was already clicked)
        const instructionsBox = document.getElementById("instructionsBox");
        if (instructionsBox && instructionsBox.style.display !== "none") {
            showSaveForLaterButton();
        }
        
        // Additionally, monitor for when the Generated Disclosures box appears
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const target = mutation.target;
                    if (target.id === "instructionsBox" && target.style.display !== "none") {
                        showSaveForLaterButton();
                    }
                }
            });
        });
        
        // Start observing the instructionsBox if it exists
        if (instructionsBox) {
            observer.observe(instructionsBox, { attributes: true });
        }
    }
});

// Very simple function to hide Save for Later button when no compliance issues found
document.addEventListener('DOMContentLoaded', function() {
    // Give a moment for the page to fully render
    setTimeout(function() {
        // Check if there are no compliance issues
        const complianceAnalysis = document.querySelector(".compliance-analysis");
        if (complianceAnalysis && complianceAnalysis.textContent.includes("No compliance issues found")) {
            // Simply hide the Save for Later button
            const saveForLaterButton = document.getElementById('saveForLaterButton');
            if (saveForLaterButton) {
                saveForLaterButton.style.display = "none";
                
                // Also add a class that we can use with CSS to keep it hidden
                saveForLaterButton.classList.add("permanently-hidden");
            }
            
            // Add a style rule to keep it hidden
            const style = document.createElement('style');
            style.textContent = '.permanently-hidden { display: none !important; }';
            document.head.appendChild(style);
        }
    }, 300);
});

document.addEventListener('DOMContentLoaded', function() {
    // Check if user has admin access
    fetch('/api/check-admin-access')
        .then(response => response.json())
        .then(data => {
            // Find the Admin dropdown - using the class and text content since there's no ID
            const adminDropdowns = document.querySelectorAll('.dropdown');
            const adminDropdown = Array.from(adminDropdowns).find(el => 
                el.querySelector('.dropdown-toggle')?.textContent.trim().startsWith('Admin')
            );
            
            if (adminDropdown) {
                // If user doesn't have admin access, hide the dropdown
                if (!data.has_admin_access) {
                    adminDropdown.style.display = 'none';
                } else {
                    // Explicitly show the dropdown for users with admin access
                    adminDropdown.style.display = '';
                }
            }
        })
        .catch(error => {
            console.error('Error checking admin access:', error);
        });
});

</script>
<div id="customAlert" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); text-align: center; max-width: 90%; width: 400px;">
        <p>By confirming, you acknowledge that the social media account profile used to post this content has not been altered since approval by your principal.</p>
        <button id="alertConfirm" style="margin: 10px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirm</button>
        <button id="alertCancel" style="margin: 10px; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
    </div>
</div>

<!-- Save for Later Button -->
<button id="saveForLaterButton" style="display: none; margin: 20px auto; padding: 12px 24px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; display: block; margin: 20px auto; width: 200px;">
    <i class="fas fa-save" style="margin-right: 8px;"></i> Save for Later
</button>

<!-- Title Input Dialog -->
<div id="titleDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); text-align: left; max-width: 90%; width: 400px; margin: 40px auto;">
        <h3 style="margin-top: 0; text-align: center;">Save This Analysis</h3>
        <p style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #666;">Enter a title to help you identify this saved analysis:</p>
        
        <input type="text" id="savedTitle" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px;" placeholder="Enter a title for this analysis">
        
        <div style="text-align: center;">
            <button id="confirmSave" style="margin: 10px; padding: 8px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Save</button>
            <button id="cancelSave" style="margin: 10px; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>

<footer style="text-align: center; margin-top: 20px; font-size: 14px; color: #555;">
        &copy; 2025 Finalyze, LLC. All Rights Reserved.
    </footer>
<div id="exitAlert" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); text-align: center; max-width: 90%; width: 400px;">
        <p>Are you sure you want to exit without saving? All changes will be lost.</p>
        <button id="exitConfirm" style="margin: 10px; padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirm</button>
        <button id="exitCancel" style="margin: 10px; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
    </div>
</div>
<div id="submitAlert" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;">
    <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1); text-align: left; max-width: 90%; width: 500px; margin: 40px auto;">
        <h3 style="margin-top: 0; text-align: center;">How do you intend to use this content?</h3>
        <p style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #666;">Select all that apply:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useSocialMedia" name="useType" value="Social Media Post" style="margin-right: 10px;">
                <label for="useSocialMedia">Social Media Post</label>
            </div>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useArticle" name="useType" value="Article" style="margin-right: 10px;">
                <label for="useArticle">Article</label>
            </div>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useBook" name="useType" value="Book" style="margin-right: 10px;">
                <label for="useBook">Booklet or Pamphlet</label>
            </div>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useAudio" name="useType" value="Audio" style="margin-right: 10px;">
                <label for="useAudio">Audio or Podcast</label>
            </div>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="usePresentation" name="useType" value="Presentation" style="margin-right: 10px;">
                <label for="usePresentation">Presentation Script or Slides</label>
            </div>
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useVideo" name="useType" value="Video" style="margin-right: 10px;">
                <label for="useVideo">Video</label>
            </div>
            <!-- 
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useGraphic" name="useType" value="Graphic/Image" style="margin-right: 10px;">
                <label for="useGraphic">Graphic or Image</label>
            </div>
            -->
            <div style="display: flex; align-items: center;">
                <input type="checkbox" id="useOther" name="useType" value="Other" style="margin-right: 10px;">
                <label for="useOther">Other</label>
            </div>
        </div>




        <!-- PDF Upload Area - Initially hidden -->
<div id="pdfUploadArea" style="display: none; margin-top: 15px; border: 2px dashed #007bff; padding: 15px; text-align: center; border-radius: 6px;">
    <p>Please upload your final multi-page document for page specific disclosure generation</p>
    <input type="file" id="pdfFileInput" accept="application/pdf" style="display: none;">
    <button id="selectPdfButton" style="padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">Select PDF File</button>
    <p style="color: #666; font-size: 12px;">Or drag and drop a PDF file here</p>
    <div id="pdfFileName" style="margin-top: 10px; font-weight: bold;"></div>
</div>


        <!-- Message containers - initially hidden -->
        <div id="socialMediaMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff; font-size: 14px;">
            Please note your social media account profile used to post this content must contain necessary disclaimers and be approved by principal prior to posting.
        </div>
        
        <div id="bookletMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #9c27b0; font-size: 14px;">
            Please note multi-page documents should contain disclosures on the corresponding page as indicated along with other disclosures indicated in Revised Analyzed Text section.
        </div>
        
        <div id="presentationMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #28a745; font-size: 14px;">
            Speaker's notes may be required in addition to slides if there is not sufficient information on the slides to constitute completeness, fairness, and balance.<br><br>
            Disclosures on slides should be large enough to be seen from all points in the room. Slides should contain disclosures on the corresponding page as indicated
        </div>
        
        <div id="audioMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #dc3545; font-size: 14px;">
            Please note content that is audio only (like a podcast) should have disclosures said aloud at beginning or end of content.<br><br>
            Disclosures must be articulated clearly and at a pace that can be easily understood by listeners.
        </div>
        
        <div id="videoMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #fd7e14; font-size: 14px;">
            Please note, disclosures should be presented clearly on screen, appear long enough to be read by viewers, and should be placed within the context of the content itself or at the end of the video. <br><br>
	    Consideration should be given to size of text used to display disclosure(s).
        </div>
        
        <div id="articleMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #6f42c1; font-size: 14px;">
            For articles disclosures text should not vary from size of text used in article and they should be placed within the context of the content itself or at the bottom of the page.
        </div>
        
        <div id="graphicMessage" class="usage-message" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #20c997; font-size: 14px;">
            Graphics and images should include a source (if applicable) and relevant disclosure. Graphics should also include a simplified description.
        </div>
        
        <div style="text-align: center;">
            <button id="submitConfirm" style="margin: 10px; padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Continue</button>
            <button id="submitCancel" style="margin: 10px; padding: 8px 16px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
        </div>
    </div>
</div>
</body>
</html>